---
title: "Dose-Response Assay Compilation"
site: workflowr::wflow_site
output:
  workflowr::wflow_html:
    toc: true
    toc_float: true
    toc_collapsed: true
    toc_depth: 4
editor_options:
  chunk_output_type: console
---
## Purpose:
* Compile past assay results.
* Provide dose-response curves for each toxin.

## Analysis Date: `r format(Sys.time(), '%B %d, %Y')`

```{r include=FALSE}
require(tidyverse)
# devtools::install_github("AndersenLab/easyXpress")
require(easyXpress)
require(drc)
require(knitr)
require(kableExtra)
require(ddpcr)
require(RCurl)
require(RColorBrewer)
require(workflowr)
require(cowplot)
require(ggbeeswarm)
require(ggrepel)

setwd("~/Documents/projects/toxin_dose_responses/")
strain_colors       <- c("blue",   "orange","#5A0C13","#C51B29",  "#a37000","#627264","#67697C","purple")
names(strain_colors) <- c("CB4856","PD1074", "ECA36",  "ECA396"  ,"ECA248", "RC301",   "MY16", "XZ1516")
# Custom function to find tick vector
logticks <- function(datavar,type) {
      minimum <- 1/10^abs(floor(log10(min(datavar, na.rm=TRUE))))
      maximum <- 1*10^abs(floor(log10(max(datavar, na.rm=TRUE)))+1)
      multiple <- floor(log10(maximum/minimum))
      
      yourtickvector <- c()
      
      if (type=="breaks") {
        
        yourtickvector <- c(minimum)
        
        for (x in seq(0,multiple)) {
          
          andadd <- seq(minimum*10^x,minimum*10^(x+1),minimum*10^x)[-1]
          
          yourtickvector <- c(yourtickvector,andadd)
          
        }
      } else if (type=="labels") {
        
        for (x in seq(0,multiple)) {
          
          andadd <- c(minimum*10^x,rep("",8))
          
          yourtickvector <- c(yourtickvector,andadd)
          
        }
        
        yourtickvector <- c(yourtickvector,minimum*10^multiple)
        
      }
      
      return(yourtickvector)
      
}

fit_best_models <- function(data, traits = "median_wormlength_um_reg", ...){
  # extract concentration variable name
  conc_var_name <- str_subset(names(data), pattern = "concentration_um")
  # dose-response model inference
  fit.best.model  <- function(x, model){
    
    if(model == "W1.4"){
      drc::drm(data = x, fct = W1.4(fixed = c(NA, NA, 0, NA), names = c("b", "c", "d", "e")))
    } else if(model == "LL.4"){
      drc::drm(data = x, fct = LL.4(fixed = c(NA, NA, 0, NA), names = c("b", "c", "d", "e")))
    } else if(model == "LN.4"){
      drc::drm(data = x, fct = LN.4(fixed = c(NA, NA, 0, NA), names = c("b", "c", "d", "e")))
    } else if(model == "W2.4"){
      drc::drm(data = x, fct = W2.4(fixed = c(NA, NA, 0, NA), names = c("b", "c", "d", "e")))
    } else {
      print("Unable to optimize model")
    }

  }
  safe_ED <- function(f){
    if(is.character(f)){print("Unable to optimize model")} 
    else {
      drc::ED(object = f, c(10, 50, 90), interval = "delta", display = FALSE)
      }
  }
  safe_predict <- function(data, f){
    if(is.character(f)){print("Unable to optimize model")}
    else{
      expand.grid(conc = exp(seq(log(max(data$concentration_um)),
                                 log(min(data$concentration_um[data$concentration_um!=min(data$concentration_um)])),
                                 length = 100))) %>%
        dplyr::bind_cols(., tibble::as.tibble(predict(f, newdata=., interval="confidence")))
    }
    
  }
  
  
  # gather trait data, nest by grouping variables and trait, 
  mselect.data <- data %>%
    dplyr::select(Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, 
                  contains("wormlength"), concentration_um := !!glue::glue("{conc_var_name}")) %>% # rename concentration_um variable adds flexibility for units
    tidyr::gather(trait, value, -drug, -strain, -concentration_um, -Metadata_Plate, -Metadata_Well, -Metadata_Experiment, -bleach) %>%
    dplyr::ungroup() %>%
    dplyr::select(drug, strain, trait, value, concentration_um) %>% # reorder for drc::drm
    dplyr::filter(trait %in% traits) %>% # filter to traits provided in arguments
    # dplyr::group_by(drug, strain, trait, Metadata_Experiment) %>% 
    dplyr::group_by(drug, strain, trait) %>% # should eventually be "..." passed from function + trait
    tidyr::nest()
  
  selected.models <- list()
  for(i in 1:length(mselect.data$data)){
    max.dose <- max(mselect.data$data[[i]]$concentration_um)
    
    # Infer average bottom phenotype to estimate ED for DRM
    c <- mselect.data$data[[i]] %>%
      dplyr::filter(concentration_um == max(mselect.data$data[[i]]$concentration_um)) %>%
      dplyr::filter(!is.na(value)) %>%
      dplyr::summarise(mean(value)) %>%
      as.numeric(.)
    
    d <- mselect.data$data[[i]] %>%
      dplyr::filter(concentration_um == min(mselect.data$data[[i]]$concentration_um)) %>%
      dplyr::filter(!is.na(value)) %>%
      dplyr::summarise(mean(value)) %>%
      as.numeric(.)
      
    
    m1 <- drc::drm(data = mselect.data$data[[i]],
                     fct = W1.4(fixed = c(NA, c, d, NA), 
                                names = c("b", "c", "d", "e")))
    mselect <- mselect(m1, list(LN.4(fixed = c(NA, c, d, NA)), 
                                LL.4(fixed = c(NA, c, d, NA)), 
                                W2.4(fixed = c(NA, c, d, NA))), icfct = BIC) %>%
      as.data.frame() %>%
      dplyr::mutate(model = rownames(.),
                    `Lack of fit` = round(`Lack of fit`, 3))
    
    selected.models[[i]] <- mselect[1,]$model
    }
  
  # fit drc, find ED10, ED50, ED90, and make predictions.
  mselect.data$fit <- purrr::map2(mselect.data$data, selected.models, fit.best.model)
  mselect.data$ED <- purrr::map(mselect.data$fit, safe_ED)
  mselect.data$prediction <- purrr::map2(mselect.data$data, mselect.data$fit, safe_predict)
  mselect.data$best.model <- unlist(selected.models)
  return(mselect.data)
}
plot_best_DRC <- function(all.model.list, toxin, metadata){
  
  # extract concentration_um variable name
  conc_var_name <- str_subset(colnames(metadata), pattern = "concentration_um")

  
  # Combined Strains from All Assays
  phenotype_data <- all.model.list %>%
    dplyr::ungroup() %>%
    dplyr::mutate(data = as.list(data)) %>% # need to convert to list to use unnest properly
    dplyr::select(drug, strain, trait, data) %>%
    tidyr::unnest(data) %>%
    as.data.frame(.) %>%
    dplyr::mutate(value = as.double(value))

  model_predictions <- all.model.list %>%
    dplyr::ungroup() %>%
    dplyr::select(drug, strain, trait, prediction, best.model) %>%
    tidyr::unnest(cols = c(prediction)) %>%
    as.data.frame(.)
  ECs.tmp <- all.model.list %>%
    dplyr::ungroup() %>%
    dplyr::select(drug, strain, trait, ED, best.model)
  ECs <- ECs.tmp[unlist(purrr::map(ECs.tmp$ED, is.character)) == FALSE,] %>%
    tidyr::unnest(cols = c(ED)) %>%
    as.data.frame(.)%>%
    dplyr::mutate(fraction = rep(c("EC10","EC50","EC90"), nrow(.)/3))
  
  
  
  drug_data <- phenotype_data

  
  ## EC50s for each DRM ##
  # drug_ECs <- ECs.W14[2,] %>%
  #   dplyr::full_join(ECs.LL4[2,]) %>%
  #   dplyr::full_join(ECs.LN4[2,])
  # drug_predictions <- W14_predictions %>%
  #   dplyr::full_join(LL4_predictions) %>%
  #   dplyr::full_join(LN4_predictions)
  
  ## EC10, EC50, EC90 for SINGLE DRM model (Log-Logistic; LL4) ##
  drug_ECs <- ECs
  drug_predictions <- model_predictions
  drug_predictions <- drug_predictions %>%
    dplyr::full_join(.,data.frame(drug_ECs$strain, drug_ECs$ED[,1], drug_ECs$best.model, drug_ECs$fraction) %>% 
                       `colnames<-`(c("strain","EC","model","fraction"))) %>%
    dplyr::filter(fraction == "EC50")
  
  for(j in 1:length(unique(phenotype_data$trait))){
      
  # Assay Info
  trait_data <- drug_data %>% 
    dplyr::filter(trait == unique(phenotype_data$trait)[j])
  trait_predictions <- drug_predictions %>% 
    dplyr::filter(trait == unique(phenotype_data$trait)[j]) %>%
    dplyr::filter(!is.na(Prediction)) %>%
    droplevels()
  assay.info <- metadata %>%
    dplyr::select(Metadata_Experiment, bleach, strain, drug, concentration_um) %>%
    dplyr::ungroup()
  
  if(nrow(trait_predictions) == 0){
          next
  }
  options(scipen = 999999)
  strain_colors       <- c("blue",   "orange","#5A0C13","#C51B29",  "#a37000","#627264","#67697C","purple")
  names(strain_colors) <- c("CB4856","PD1074", "ECA36",  "ECA396"  ,"ECA248", "RC301",   "MY16", "XZ1516")
  plot <- ggplot(data = trait_data, aes(x = concentration_um, 
                                        y = value, 
                                        colour = strain)) +
    theme_bw(base_size = 10) +
    # geom_point(data = trait_data, 
    #            shape = 21, 
    #            alpha = 0.75,
    #            aes(fill = strain, group = interaction(concentration_um, strain))) +
    
    # Predictions Section
    geom_ribbon(data = trait_predictions, aes(x = conc,
                                              y = Prediction,
                                              group = strain,
                                              fill = strain,
                                              ymin = Lower,
                                              ymax = Upper), alpha = 0.1, colour = NA) +
    geom_line(data = trait_predictions, aes(x = conc, 
                                            y = Prediction)) +
    theme(legend.position = "top") +
    scale_x_log10(breaks = logticks(c(trait_predictions$conc, max(trait_predictions$EC)),"breaks"),
                  labels = logticks(c(trait_predictions$conc, max(trait_predictions$EC)), "labels")) +
    scale_y_continuous(limits = c(-750,100)) + 
    scale_fill_manual(name = "Strain", values = strain_colors) + 
    scale_colour_manual(name = "Strain", values = strain_colors) +
    labs(y = "Relative Worm Length (µm)",
         x = "Concentration (µM)",
         fill = "Strain",
         colour = "Strain",
         title = unique(trait_data$drug)) + 
    theme(plot.title = element_text(hjust = 0.5))
  
  
  return(assign(paste(paste(strsplit(unique(trait_data$drug),split = " ")[[1]], collapse = "_"), "DRCplot", sep = "_"), plot, envir = parent.frame()))
  }# trait loop
  
}
selected.strain.EC50s <- function(best.drug.drm, drug.df){
  
  EC.list <- list()
  for(i in 1:nrow(best.drug.drm)){
    
   EC.list[[i]] <- best.drug.drm[i,]$ED[[1]] %>%
     as.data.frame() %>%
     dplyr::mutate(drug = best.drug.drm[i,]$drug,
                    strain = best.drug.drm[i,]$strain,
                    trait = best.drug.drm[i,]$trait,
                    best.model = best.drug.drm[i,]$best.model,
                    fraction = rownames(.)) %>%
    tidyr::separate(col = fraction, sep = ":", into = c("x","y","fraction")) %>%
    dplyr::mutate(fraction = paste0("EC", fraction)) %>%
    dplyr::select(-c(x,y))
    
    
    
    
    }
  EC.est.df <- do.call(rbind,EC.list) %>%
    dplyr::mutate(above.max.conc = Estimate > max(drug.df$concentration_um))
  return(EC.est.df)
  
}

fit_all_models <- function(data, traits = "median_wormlength_um_reg", ...){
  # extract concentration variable name
  conc_var_name <- str_subset(names(data), pattern = "concentration_um")
  # dose-response model inference
  safe_W14 <- purrr::safely(.f = ~ drc::drm(data = ., fct = W1.4(fixed = c(NA, NA, 0, NA), names = c("b", "c", "d", "e"))),
                            otherwise = "Unable to optimize model")
  safe_LL4 <- purrr::safely(.f = ~ drc::drm(data = ., fct = LL.4(fixed = c(NA, NA, 0, NA), names = c("b", "c", "d", "e"))),
                            otherwise = "Unable to optimize model")
  safe_LN4 <- purrr::safely(.f = ~ drc::drm(data = ., fct = LN.4(fixed = c(NA, NA, 0, NA), names = c("b", "c", "d", "e"))),
                            otherwise = "Unable to optimize model")
  safe_ED <- function(fit){
    if(is.character(fit$result)){print("Unable to optimize model")} 
    else {
      drc::ED(object = fit$result, c(10, 50, 90), interval = "delta", display = FALSE)
      }
  }
  safe_predict <- function(data, fit){
    if(is.character(fit$result)){print("Unable to optimize model")}
    else{
      expand.grid(conc = exp(seq(log(max(data$concentration_um)),
                                 log(min(data$concentration_um[data$concentration_um!=min(data$concentration_um)])),
                                 length = 100))) %>%
        dplyr::bind_cols(., tibble::as.tibble(predict(fit$result, newdata=., interval="confidence")))
    }
    
  }
  
  # gather trait data, nest by grouping variables and trait, fit drc, find ED10, ED50, ED90, and make predictions.
  W14_fit_data <- data %>%
    dplyr::select(Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, 
                  contains("wormlength"), concentration_um := !!glue::glue("{conc_var_name}")) %>% # rename concentration_um variable adds flexibility for units
    tidyr::gather(trait, value, -drug, -strain, -concentration_um, -Metadata_Plate, -Metadata_Well, -Metadata_Experiment, -bleach) %>%
    dplyr::ungroup() %>%
    dplyr::select(drug, strain, trait, value, concentration_um) %>% # reorder for drc::drm
    dplyr::filter(trait %in% traits) %>% # filter to traits provided in arguments
    # dplyr::group_by(drug, strain, trait, Metadata_Experiment) %>% 
    dplyr::group_by(drug, strain, trait) %>% # should eventually be "..." passed from function + trait
    tidyr::nest() %>%
    mutate(fit = purrr::map(data, safe_W14),
           ED = purrr::map(fit, safe_ED),
           predictions = purrr::map2(data, fit, safe_predict),
           model = "W1.4")
  
  LL4_fit_data <- data %>%
    dplyr::select(Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, 
                  contains("wormlength"), concentration_um := !!glue::glue("{conc_var_name}")) %>%
    tidyr::gather(trait, value, -drug, -strain, -concentration_um, -Metadata_Plate, -Metadata_Well, -Metadata_Experiment, -bleach) %>%
    dplyr::ungroup() %>%
    dplyr::select(drug, strain, trait, value, concentration_um) %>% # reorder for drc::drm
    dplyr::filter(trait %in% traits) %>% # filter to traits provided in arguments
    # dplyr::group_by(drug, strain, trait, Metadata_Experiment) %>% 
    dplyr::group_by(drug, strain, trait) %>% # should eventually be "..." passed from function + trait
    tidyr::nest() %>%
    mutate(fit = purrr::map(data, safe_LL4),
           ED = purrr::map(fit, safe_ED),
           predictions = purrr::map2(data, fit, safe_predict),
           model = "LL.4")
  
  LN4_fit_data <- data %>%
    dplyr::select(Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, 
                  contains("wormlength"), concentration_um := !!glue::glue("{conc_var_name}")) %>% # rename concentration_um variable adds flexibility for units
    tidyr::gather(trait, value, -drug, -strain, -concentration_um, -Metadata_Plate, -Metadata_Well, -Metadata_Experiment, -bleach) %>%
    dplyr::ungroup() %>%
    dplyr::select(drug, strain, trait, value, concentration_um) %>% # reorder for drc::drm
    dplyr::filter(trait %in% traits) %>% # filter to traits provided in arguments
    # dplyr::group_by(drug, strain, trait, Metadata_Experiment) %>% 
    dplyr::group_by(drug, strain, trait) %>% # should eventually be "..." passed from function + trait
    tidyr::nest() %>%
    mutate(fit = purrr::map(data, safe_LN4),
           ED = purrr::map(fit, safe_ED),
           predictions = purrr::map2(data, fit, safe_predict),
           model = "LN.4")
  
   model.fits.list <- list(W14_fit_data, LL4_fit_data, LN4_fit_data)
   return(model.fits.list)
}
plot_EC50s_on_DRC <- function(all.model.list, toxin, metadata){
  
  # extract concentration_um variable name
  conc_var_name <- str_subset(colnames(metadata), pattern = "concentration_um")

  
  # Combined Strains from All Assays
  phenotype_data <- all.model.list[[1]] %>%
    dplyr::ungroup() %>%
    dplyr::mutate(data = as.list(data)) %>% # need to convert to list to use unnest properly
    dplyr::select(drug, strain, trait, data) %>%
    tidyr::unnest(data) %>%
    as.data.frame(.) %>%
    dplyr::mutate(value = as.double(value))

  W14_predictions <- all.model.list[[1]] %>%
    dplyr::ungroup() %>%
    dplyr::select(drug, strain, trait, predictions, model) %>%
    tidyr::unnest(cols = c(predictions)) %>%
    as.data.frame(.)
  ECs.W14.tmp <- all.model.list[[1]] %>%
    dplyr::ungroup() %>%
    dplyr::select(drug, strain, trait, ED, model)
  ECs.W14 <- ECs.W14.tmp[unlist(purrr::map(ECs.W14.tmp$ED, is.character)) == FALSE,] %>%
    tidyr::unnest(cols = c(ED)) %>%
    as.data.frame(.)%>%
    dplyr::mutate(fraction = rep(c("EC10","EC50","EC90"), nrow(.)/3))
  
  LL4_predictions <- all.model.list[[2]] %>%
    dplyr::ungroup() %>%
    dplyr::select(drug, strain, trait, predictions, model) %>%
    tidyr::unnest(cols = c(predictions)) %>%
    as.data.frame(.)
  ECs.LL4.tmp <- all.model.list[[2]] %>%
    dplyr::ungroup() %>%
    dplyr::select(drug, strain, trait, ED, model)
  ECs.LL4 <- ECs.LL4.tmp[unlist(purrr::map(ECs.LL4.tmp$ED, is.character)) == FALSE,] %>%
    tidyr::unnest(cols = c(ED)) %>%
    as.data.frame(.)%>%
    dplyr::mutate(fraction = rep(c("EC10","EC50","EC90"), nrow(.)/3))
  
  LN4_predictions <- all.model.list[[3]] %>%
    dplyr::ungroup() %>%
    dplyr::select(drug, strain, trait, predictions, model) %>%
    tidyr::unnest(cols = c(predictions)) %>%
    as.data.frame(.)
  ECs.LN4.tmp <- all.model.list[[3]] %>%
    dplyr::ungroup() %>%
    dplyr::select(drug, strain, trait, ED, model)
  ECs.LN4 <- ECs.LN4.tmp[unlist(purrr::map(ECs.LN4.tmp$ED, is.character)) == FALSE,] %>%
    tidyr::unnest(cols = c(ED)) %>%
    as.data.frame(.)%>%
    dplyr::mutate(fraction = rep(c("EC10","EC50","EC90"), nrow(.)/3))
  
  drug_data <- phenotype_data

  
  ## EC50s for each DRM ##
  # drug_ECs <- ECs.W14[2,] %>%
  #   dplyr::full_join(ECs.LL4[2,]) %>%
  #   dplyr::full_join(ECs.LN4[2,])
  # drug_predictions <- W14_predictions %>%
  #   dplyr::full_join(LL4_predictions) %>%
  #   dplyr::full_join(LN4_predictions)
  
  ## EC10, EC50, EC90 for SINGLE DRM model (Log-Logistic; LL4) ##
  drug_ECs <- ECs.LL4
  drug_predictions <- LL4_predictions
  drug_predictions <- drug_predictions %>%
    dplyr::full_join(.,data.frame(drug_ECs$strain, drug_ECs$ED[,1], drug_ECs$model, drug_ECs$fraction) %>% 
                       `colnames<-`(c("strain","EC","model","fraction"))) %>%
    dplyr::filter(fraction == "EC50")
  
  for(j in 1:length(unique(phenotype_data$trait))){
      
  # Assay Info
  trait_data <- drug_data %>% 
    dplyr::filter(trait == unique(phenotype_data$trait)[j])
  trait_predictions <- drug_predictions %>% 
    dplyr::filter(trait == unique(phenotype_data$trait)[j]) %>%
    dplyr::filter(!is.na(Prediction)) %>%
    droplevels()
  assay.info <- metadata %>%
    dplyr::select(Metadata_Experiment, bleach, strain, drug, concentration_um) %>%
    dplyr::ungroup()
  
  if(nrow(trait_predictions) == 0){
          next
  }
  options(scipen = 999999)
  strain_colors       <- c("blue",   "orange","#5A0C13","#C51B29",  "#a37000","#627264","#67697C","purple")
  names(strain_colors) <- c("CB4856","PD1074", "ECA36",  "ECA396"  ,"ECA248", "RC301",   "MY16", "XZ1516")
  plot <- ggplot(data = trait_data, aes(x = concentration_um, 
                                        y = value, 
                                        colour = strain)) +
    theme_bw(base_size = 10) +
    # geom_point(data = trait_data, 
    #            shape = 21, 
    #            alpha = 0.75,
    #            aes(fill = strain, group = interaction(concentration_um, strain))) +
    
    # Predictions Section
    geom_ribbon(data = trait_predictions, aes(x = conc,
                                              y = Prediction,
                                              group = strain,
                                              fill = strain,
                                              ymin = Lower,
                                              ymax = Upper), alpha = 0.1, colour = NA) +
    geom_line(data = trait_predictions, aes(x = conc, 
                                            y = Prediction)) +
    theme(legend.position = "top") +
    scale_x_log10(breaks = logticks(c(trait_predictions$conc, max(trait_predictions$EC)),"breaks"),
                  labels = logticks(c(trait_predictions$conc, max(trait_predictions$EC)), "labels")) +
    scale_y_continuous(limits = c(-750,100)) + 
    scale_fill_manual(name = "Strain", values = strain_colors) + 
    scale_colour_manual(name = "Strain", values = strain_colors) +
    labs(y = "Relative Worm Length (µm)",
         x = "Concentration (µM)",
         fill = "Strain",
         colour = "Strain",
         title = unique(trait_data$drug)) + 
    theme(plot.title = element_text(hjust = 0.5))
  
  
  return(assign(paste(paste(strsplit(unique(trait_data$drug),split = " ")[[1]], collapse = "_"), "DRCplot", sep = "_"), plot, envir = parent.frame()))
  }# trait loop
  
}
remove_outliers <- function(x, na.rm = TRUE, ...) {
    qnt <- stats::quantile(x, probs = c(0.25, 0.75), na.rm = na.rm, 
      ...)
    H <- 1.5 * stats::IQR(x, na.rm = na.rm)
    y <- x
    y[x < (qnt[1] - H)] <- NA
    y[x > (qnt[2] + H)] <- NA
    y
}
EC.collapse <- function(x,y,z){
        # x <- stuff$data[[1]] # metadata from nest
        # y <- stuff$strain[[1]] # strain from nest
        # z <- drug.drm[[i]]$ED[[1]] # EC data

        tidy.EC <- z %>% 
          data.frame() %>%
          dplyr::mutate(model = x$model,
                        drug = x$drug,
                        trait = x$trait,
                        strain = y,
                        fraction = rownames(.))
}
strain.EC50s <- function(drug.drm, drug.df){
  diditwork <- c(is.character(drug.drm[[1]]$ED[[1]]), 
                 is.character(drug.drm[[2]]$ED[[1]]), 
                 is.character(drug.drm[[3]]$ED[[1]]))
  if(TRUE %in% diditwork){
      next
    } 
  EC.list <- list()
  for(i in 1:length(drug.drm)){
    stuff <- drug.drm[[i]] %>%
      dplyr::select(drug, strain, trait, model) %>%
      dplyr::group_by(strain) %>%
      tidyr::nest()
    
    EC.list[[i]] <- purrr::pmap(.l = list(stuff$data[sapply(drug.drm[[i]]$ED, is.character) == FALSE], 
                                          stuff$strain[sapply(drug.drm[[i]]$ED, is.character) == FALSE], 
                                          drug.drm[[i]]$ED[sapply(drug.drm[[i]]$ED, is.character) == FALSE]), .f = EC.collapse) %>%
        Reduce(rbind,.)
    }
  EC.est.df <- do.call(rbind,EC.list) %>%
    dplyr::mutate(above.max.conc = Estimate > max(drug.df$concentration_um))
}
```

```{r Three-Model CP Data, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
##############
## TOXIN 09 ##
##############
processed.toxin09A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20200711_toxin09A",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20200711_toxin09A_data_1603396935.RData") %>%
  dplyr::filter(model != "MDHD") %>%
  droplevels() %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>%
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

##############
## TOXIN 10 ##
##############
processed.toxin10A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20200802_toxin10A",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20200802_toxin10A_data_1603469205.RData") %>%
  dplyr::filter(model != "MDHD") %>%
  droplevels() %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>%
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

##############
## TOXIN 11 ##
##############
processed.toxin11A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20200924_toxin11A",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20200924_toxin11A_data_1602696342SJW.RData") %>%
  dplyr::filter(model != "MDHD") %>%
  droplevels() %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>%
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

##############
## TOXIN 12 ##
##############
processed.toxin12A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20201105_toxin12A",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20201105_toxin12A_data_1605131334SJW.RData") %>%
  dplyr::filter(model != "MDHD") %>%
  droplevels() %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>%
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

##############
## TOXIN 14 ##
##############
processed.toxin14A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20201210_toxin14A",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20201210_toxin14A_data_1609973542SJW.RData") %>%
  dplyr::filter(model != "MDHD") %>%
  droplevels() %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>%
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

processed.toxin14B <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20201211_toxin14B",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20201211_toxin14B_data_1609875275SJW.RData") %>%
  dplyr::filter(model != "MDHD") %>%
  droplevels() %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>%
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)


##############
## TOXIN 15 ##
##############
processed.toxin15A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20201217_toxin15A",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20201217_toxin15A_data_1609886407SJW.RData") %>%
  dplyr::filter(model != "MDHD") %>%
  droplevels() %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>%
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

processed.toxin15B <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20201218_toxin15B",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20201218_toxin15B_data_1609979126SJW.RData") %>%
  dplyr::filter(model != "MDHD") %>%
  droplevels() %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>%
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

##############
## TOXIN 16 ##
##############
processed.toxin16A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20210129_toxin16A",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20210129_toxin16A_data_1612115412SJW.RData") %>%
  dplyr::filter(model != "MDHD") %>%
  droplevels() %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>%
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

##############
## TOXIN 17 ##
##############
processed.toxin17A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20210204_toxin17A",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20210204_toxin17A_data_1612562886SJW.RData") %>%
  dplyr::filter(model != "MDHD") %>%
  droplevels() %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>%
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

##############
## TOXIN 18 ##
##############
processed.toxin18A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20210211_toxin18A",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20210211_toxin18A_data_1613317121SJW.RData") %>% 
  dplyr::filter(model != "MDHD") %>%
  droplevels() %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>% 
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

##############
## TOXIN 19 ##
##############
processed.toxin19A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20210218_toxin19A",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20210218_toxin19A_data_1614224793SJW.RData") %>% 
  dplyr::filter(model != "MDHD") %>%
  droplevels() %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>% 
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

##############
## TOXIN 22 ##
##############
processed.toxin22A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20210311_toxin22A/",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20210311_toxin22A_data_1615574989SJW.RData") %>% 
  dplyr::filter(model != "MDHD") %>%
  droplevels() %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>% 
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

##############
## TOXIN 23 ##
##############
processed.toxin23A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20210318_toxin23A/",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20210318_toxin23A_data_1616184391SJW.RData") %>% 
  dplyr::filter(model != "MDHD") %>%
  droplevels() %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>% 
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)
```

```{r MDHD CP Data, message=FALSE, warning=FALSE, include=FALSE}

##############
## TOXIN 09 ##
##############
MDHD.toxin09A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20200711_toxin09A",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20200711_toxin09A_data_1603396935.RData") %>%
  dplyr::filter(Worm_Length > 50) %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>%
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

##############
## TOXIN 10 ##
##############
MDHD.toxin10A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20200802_toxin10A",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20200802_toxin10A_data_1603469205.RData") %>%
  dplyr::filter(Worm_Length > 50) %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>%
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

##############
## TOXIN 11 ##
##############
MDHD.toxin11A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20200924_toxin11A",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20200924_toxin11A_data_1602696342SJW.RData") %>%
  dplyr::filter(Worm_Length > 50) %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>%
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

##############
## TOXIN 12 ##
##############
MDHD.toxin12A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20201105_toxin12A",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20201105_toxin12A_data_1605131334SJW.RData") %>%
  dplyr::filter(Worm_Length > 50) %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>%
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

##############
## TOXIN 14 ##
##############
MDHD.toxin14A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20201210_toxin14A",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20201210_toxin14A_data_1609973542SJW.RData") %>%
  dplyr::filter(Worm_Length > 50) %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>%
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

MDHD.toxin14B <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20201211_toxin14B",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20201211_toxin14B_data_1609875275SJW.RData") %>%
  dplyr::filter(Worm_Length > 50) %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>%
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)


##############
## TOXIN 15 ##
##############
MDHD.toxin15A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20201217_toxin15A",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20201217_toxin15A_data_1609886407SJW.RData") %>%
  dplyr::filter(Worm_Length > 50) %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>%
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

MDHD.toxin15B <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20201218_toxin15B",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20201218_toxin15B_data_1609979126SJW.RData") %>%
  dplyr::filter(Worm_Length > 50) %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>%
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

##############
## TOXIN 16 ##
##############
MDHD.toxin16A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20210129_toxin16A",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20210129_toxin16A_data_1612115412SJW.RData") %>%
  dplyr::filter(Worm_Length > 50) %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>%
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

##############
## TOXIN 17 ##
##############
MDHD.toxin17A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20210204_toxin17A",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20210204_toxin17A_data_1612562886SJW.RData") %>%
  dplyr::filter(Worm_Length > 50) %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>%
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

##############
## TOXIN 18 ##
##############
MDHD.toxin18A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20210211_toxin18A",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20210211_toxin18A_data_1613317121SJW.RData") %>% 
  dplyr::filter(Worm_Length > 50) %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>% 
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

##############
## TOXIN 19 ##
##############
MDHD.toxin19A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20210218_toxin19A",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20210218_toxin19A_data_1614224793SJW.RData") %>% 
  dplyr::filter(Worm_Length > 50) %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>% 
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)


##############
## TOXIN 22 ##
##############
MDHD.toxin22A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20210311_toxin22A/",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20210311_toxin22A_data_1615574989SJW.RData") %>% 
  dplyr::filter(Worm_Length > 50) %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>% 
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)


##############
## TOXIN 23 ##
##############
MDHD.toxin23A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20210318_toxin23A/",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20210318_toxin23A_data_1616184391SJW.RData") %>% 
  dplyr::filter(Worm_Length > 50) %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>% 
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)


##############
## TOXIN 24 ##
##############
MDHD.toxin24A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20210325_toxin24A/",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20210325_toxin24A_data_1616789627SJW.RData") %>% 
  dplyr::filter(Worm_Length > 50) %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>% 
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

##############
## TOXIN 25 ##
##############
MDHD.toxin25A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20210401_toxin25A/",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20210401_toxin25A_data_1617560356SJW.RData") %>% 
  dplyr::filter(Worm_Length > 50) %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>% 
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

##############
## TOXIN 26 ##
##############
MDHD.toxin26A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20210408_toxin26A/",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20210408_toxin26A_data_1617993567SJW.RData") %>% 
  dplyr::filter(Worm_Length > 50) %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>% 
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)


##############
## TOXIN 27 ##
##############
MDHD.toxin27A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20210415_toxin27A/",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20210415_toxin27A_data_1618834612SJW.RData") %>% 
  dplyr::filter(Worm_Length > 50) %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>% 
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

beepr::beep(sound = "fanfare")
# #### TIDY IMAGES #### (ifneedbe)
# easyXpress::tidyImages(project_dir = "/Volumes/ECA_Image/sam/20210211-toxin18A/", rm_other = T)
# easyXpress::tidyProject(project_dir = "/Volumes/ECA_Image/sam/20210211-toxin18A/", plates = "all")
```

```{r message=TRUE, warning=FALSE, include=FALSE}
CP.data.list <- as.list(ls(pattern = "processed"))
MDHD.data.list <- as.list(ls(pattern = "MDHD"))
pull.toxin <- function(data, toxin){
  assay <- get(data)
  assay$summarized_processed[grep(assay$summarized_processed$drug, pattern = toxin, ignore.case = T),] %>%
    dplyr::mutate(Metadata_Plate = gsub(x = Metadata_Plate, 
                                        pattern = "p", 
                                        replacement = ""),
                  well_censor_reason = as.character(well_censor_reason),
                  notes = as.character(notes),
                  concentration_um = round(concentration_um, 1))
}
pull.toxin.raw <- function(data, toxin){
  assay <- get(data)
  assay$raw_data[grep(assay$raw_data$drug, pattern = toxin, ignore.case = T),] %>%
    dplyr::mutate(Metadata_Plate = gsub(x = Metadata_Plate, 
                                        pattern = "p", 
                                        replacement = ""),
                  well_censor_reason = as.character(well_censor_reason),
                  notes = as.character(notes),
                  concentration_um = round(concentration_um, 1))
}
traits <- c("median_wormlength_um")
clean.data <- function(raw.data){
  
  if(length(levels(as.factor(raw.data$Metadata_Experiment))) > 1){
    
    # Remove Low n and Censored Wells
    n.drug.df <- raw.data %>%
      dplyr::filter(n < 30,
                    n > 5,
                    is.na(well_censor))
    
    # Regression
    median.reg <- lm(data = n.drug.df, formula = median_wormlength_um ~ Metadata_Experiment + bleach)
    mean.reg <- lm(data = n.drug.df, formula = mean_wormlength_um ~ Metadata_Experiment + bleach)
    n.drug.df <- cbind(n.drug.df, median.reg$residuals, mean.reg$residuals)
    colnames(n.drug.df) <- c(colnames(n.drug.df)[-c(length(colnames(n.drug.df))-1, length(colnames(n.drug.df)))],
                           "median_wormlength_um_reg","mean_wormlength_um_reg")
    # Outlier Removal
    outlier.removed.drug.df <- n.drug.df %>%
      dplyr::group_by(concentration_um, strain) %>%
      # dplyr::group_by(concentration_um) %>%
      dplyr::mutate(median_wormlength_um_reg = remove_outliers(median_wormlength_um_reg)) %>%
      dplyr::filter(!is.na(median_wormlength_um_reg))
    
    # Control Delta
    if(!0 %in% outlier.removed.drug.df$concentration_um){
      full_df_proc <-  outlier.removed.drug.df
    } else {
      control_values <- outlier.removed.drug.df %>%
        dplyr::filter(concentration_um == 0) %>% # filter to control wells
        dplyr::group_by(strain, bleach, Metadata_Experiment) %>%
        dplyr::mutate(control_pheno = mean(median_wormlength_um_reg)) %>% # get mean control value for each trait and strain
        dplyr::distinct(control_pheno, bleach, strain, Metadata_Experiment) # make it neat
    
      full_df_proc <-  outlier.removed.drug.df %>%
        dplyr::ungroup() %>%
        dplyr::left_join(., control_values) %>% # join control values for each trait
        dplyr::mutate(median_wormlength_um_reg = median_wormlength_um_reg - control_pheno)
    }
    
    n.raw <- raw.data %>%
      dplyr::group_by(Metadata_Experiment, bleach, drug, strain) %>%
      dplyr::summarise(raw = n())
    
    n.cleaned <- n.drug.df %>%
      dplyr::group_by(Metadata_Experiment, bleach, drug, strain) %>%
      dplyr::summarise(cleaned = n())
    
    n.outlier.removed <- outlier.removed.drug.df %>%
      dplyr::group_by(Metadata_Experiment, bleach, drug, strain) %>%
      dplyr::summarise(outlier.removed = n())
    
    filtering.summary <- n.raw %>%
      dplyr::full_join(., n.cleaned) %>%
      dplyr::full_join(., n.outlier.removed)
    filtering.summary[is.na(filtering.summary)] <- 0
    
    drug.filtering.summary <- filtering.summary %>%
      dplyr::mutate(pct.retained = (outlier.removed/raw)*100,
                    pct.outlier = ((cleaned-outlier.removed)/raw)*100,
                    pct.cleaned = ((raw-cleaned)/raw)*100,
                    check = pct.retained + pct.outlier + pct.cleaned) %>%
      tidyr::pivot_longer(cols = -c(Metadata_Experiment, bleach, drug, strain), names_to = "stat")
    
  } else {
    
    # Remove Low n and Censored Wells
    n.drug.df <- raw.data %>%
      dplyr::filter(n < 30,
                    n > 5,
                    is.na(well_censor))
    

    # Regression
    median.reg <- lm(data = n.drug.df, formula = median_wormlength_um ~ bleach)
    mean.reg <- lm(data = n.drug.df, formula = mean_wormlength_um ~ bleach)
    n.drug.df <- cbind(n.drug.df, median.reg$residuals, mean.reg$residuals)
    colnames(n.drug.df) <- c(colnames(n.drug.df)[-c(length(colnames(n.drug.df))-1, length(colnames(n.drug.df)))],
                           "median_wormlength_um_reg","mean_wormlength_um_reg")
    # Outlier Removal
    outlier.removed.drug.df <- n.drug.df %>%
      dplyr::group_by(concentration_um, strain) %>%
      # dplyr::group_by(concentration_um) %>%
      dplyr::mutate(median_wormlength_um_reg = remove_outliers(median_wormlength_um_reg)) %>%
      dplyr::filter(!is.na(median_wormlength_um_reg))
    
    # Control Delta
    if(!0 %in% outlier.removed.drug.df$concentration_um){
      full_df_proc <-  outlier.removed.drug.df
    } else {
      control_values <- outlier.removed.drug.df %>%
        dplyr::filter(concentration_um == 0) %>% # filter to control wells
        dplyr::group_by(strain, bleach, Metadata_Experiment) %>%
        dplyr::mutate(control_pheno = mean(median_wormlength_um_reg)) %>% # get mean control value for each trait and strain
        dplyr::distinct(control_pheno, bleach, strain, Metadata_Experiment) # make it neat
    
      full_df_proc <-  outlier.removed.drug.df %>%
        dplyr::ungroup() %>%
        dplyr::left_join(., control_values) %>% # join control values for each trait
        dplyr::mutate(median_wormlength_um_reg = median_wormlength_um_reg - control_pheno)
    }
    
    n.raw <- raw.data %>%
      dplyr::group_by(Metadata_Experiment, bleach, drug, strain) %>%
      dplyr::summarise(raw = n())
    
    n.cleaned <- n.drug.df %>%
      dplyr::group_by(Metadata_Experiment, bleach, drug, strain) %>%
      dplyr::summarise(cleaned = n())
    
    n.outlier.removed <- outlier.removed.drug.df %>%
      dplyr::group_by(Metadata_Experiment, bleach, drug, strain) %>%
      dplyr::summarise(outlier.removed = n())
    
    filtering.summary <- n.raw %>%
      dplyr::full_join(., n.cleaned) %>%
      dplyr::full_join(., n.outlier.removed)
    filtering.summary[is.na(filtering.summary)] <- 0
    
    drug.filtering.summary <- filtering.summary %>%
      dplyr::mutate(pct.retained = (outlier.removed/raw)*100,
                    pct.outlier = ((cleaned-outlier.removed)/raw)*100,
                    pct.cleaned = ((raw-cleaned)/raw)*100,
                    check = pct.retained + pct.outlier + pct.cleaned) %>%
      tidyr::pivot_longer(cols = -c(Metadata_Experiment, bleach, drug, strain), names_to = "stat")
  }
  return(list(full_df_proc,drug.filtering.summary))
}
cleanData <- function(raw.data){
  
  if(length(levels(as.factor(raw.data$Metadata_Experiment))) > 1){
    
    # Remove Low n and Censored Wells
    n.drug.df <- raw.data %>%
      dplyr::filter(n < 30,
                    n > 5,
                    is.na(well_censor))
    
    # Outlier Removal
    outlier.removed.drug.df <- n.drug.df %>%
      dplyr::group_by(concentration_um, strain) %>%
      # dplyr::group_by(concentration_um) %>%
      dplyr::mutate(median_wormlength_um = remove_outliers(median_wormlength_um)) %>%
      dplyr::filter(!is.na(median_wormlength_um))
    
    # Regression
    median.reg <- lm(data = outlier.removed.drug.df, formula = median_wormlength_um ~ Metadata_Experiment + bleach)
    mean.reg <- lm(data = outlier.removed.drug.df, formula = mean_wormlength_um ~ Metadata_Experiment + bleach)
    outlier.removed.drug.df <- cbind(outlier.removed.drug.df, median.reg$residuals, mean.reg$residuals)
    colnames(outlier.removed.drug.df) <- c(colnames(outlier.removed.drug.df)[-c(length(colnames(outlier.removed.drug.df))-1, length(colnames(n.drug.df)))],
                           "median_wormlength_um_reg","mean_wormlength_um_reg")
    
    
    # Control Delta
    if(!0 %in% outlier.removed.drug.df$concentration_um){
      full_df_proc <-  outlier.removed.drug.df
    } else {
      control_values <- outlier.removed.drug.df %>%
        dplyr::filter(concentration_um == 0) %>% # filter to control wells
        dplyr::group_by(strain, bleach, Metadata_Experiment) %>%
        dplyr::mutate(control_pheno = mean(median_wormlength_um_reg)) %>% # get mean control value for each trait and strain
        dplyr::distinct(control_pheno, bleach, strain, Metadata_Experiment) # make it neat
    
      full_df_proc <-  outlier.removed.drug.df %>%
        dplyr::ungroup() %>%
        dplyr::left_join(., control_values) %>% # join control values for each trait
        dplyr::mutate(median_wormlength_um_reg = median_wormlength_um_reg - control_pheno)
    }
    
    n.raw <- raw.data %>%
      dplyr::group_by(Metadata_Experiment, bleach, drug, strain) %>%
      dplyr::summarise(raw = n())
    
    n.cleaned <- n.drug.df %>%
      dplyr::group_by(Metadata_Experiment, bleach, drug, strain) %>%
      dplyr::summarise(cleaned = n())
    
    n.outlier.removed <- outlier.removed.drug.df %>%
      dplyr::group_by(Metadata_Experiment, bleach, drug, strain) %>%
      dplyr::summarise(outlier.removed = n())
    
    filtering.summary <- n.raw %>%
      dplyr::full_join(., n.cleaned) %>%
      dplyr::full_join(., n.outlier.removed)
    filtering.summary[is.na(filtering.summary)] <- 0
    
    drug.filtering.summary <- filtering.summary %>%
      dplyr::mutate(pct.retained = (outlier.removed/raw)*100,
                    pct.outlier = ((cleaned-outlier.removed)/raw)*100,
                    pct.cleaned = ((raw-cleaned)/raw)*100,
                    check = pct.retained + pct.outlier + pct.cleaned) %>%
      tidyr::pivot_longer(cols = -c(Metadata_Experiment, bleach, drug, strain), names_to = "stat")
    
  } else {
    
    # Remove Low n and Censored Wells
    n.drug.df <- raw.data %>%
      dplyr::filter(n < 30,
                    n > 5,
                    is.na(well_censor))
    

    # Outlier Removal
    outlier.removed.drug.df <- n.drug.df %>%
      dplyr::group_by(concentration_um, strain) %>%
      # dplyr::group_by(concentration_um) %>%
      dplyr::mutate(median_wormlength_um = remove_outliers(median_wormlength_um)) %>%
      dplyr::filter(!is.na(median_wormlength_um))
    
    # Regression
    median.reg <- lm(data = outlier.removed.drug.df, formula = median_wormlength_um ~ bleach)
    mean.reg <- lm(data = outlier.removed.drug.df, formula = mean_wormlength_um ~ bleach)
    outlier.removed.drug.df <- cbind(outlier.removed.drug.df, median.reg$residuals, mean.reg$residuals)
    colnames(outlier.removed.drug.df) <- c(colnames(outlier.removed.drug.df)[-c(length(colnames(outlier.removed.drug.df))-1, length(colnames(n.drug.df)))],
                           "median_wormlength_um_reg","mean_wormlength_um_reg")
    
    # Control Delta
    if(!0 %in% outlier.removed.drug.df$concentration_um){
      full_df_proc <-  outlier.removed.drug.df
    } else {
      control_values <- outlier.removed.drug.df %>%
        dplyr::filter(concentration_um == 0) %>% # filter to control wells
        dplyr::group_by(strain, bleach, Metadata_Experiment) %>%
        dplyr::mutate(control_pheno = mean(median_wormlength_um_reg)) %>% # get mean control value for each trait and strain
        dplyr::distinct(control_pheno, bleach, strain, Metadata_Experiment) # make it neat
    
      full_df_proc <-  outlier.removed.drug.df %>%
        dplyr::ungroup() %>%
        dplyr::left_join(., control_values) %>% # join control values for each trait
        dplyr::mutate(median_wormlength_um_reg = median_wormlength_um_reg - control_pheno)
    }
    
    n.raw <- raw.data %>%
      dplyr::group_by(Metadata_Experiment, bleach, drug, strain) %>%
      dplyr::summarise(raw = n())
    
    n.cleaned <- n.drug.df %>%
      dplyr::group_by(Metadata_Experiment, bleach, drug, strain) %>%
      dplyr::summarise(cleaned = n())
    
    n.outlier.removed <- outlier.removed.drug.df %>%
      dplyr::group_by(Metadata_Experiment, bleach, drug, strain) %>%
      dplyr::summarise(outlier.removed = n())
    
    filtering.summary <- n.raw %>%
      dplyr::full_join(., n.cleaned) %>%
      dplyr::full_join(., n.outlier.removed)
    filtering.summary[is.na(filtering.summary)] <- 0
    
    drug.filtering.summary <- filtering.summary %>%
      dplyr::mutate(pct.retained = (outlier.removed/raw)*100,
                    pct.outlier = ((cleaned-outlier.removed)/raw)*100,
                    pct.cleaned = ((raw-cleaned)/raw)*100,
                    check = pct.retained + pct.outlier + pct.cleaned) %>%
      tidyr::pivot_longer(cols = -c(Metadata_Experiment, bleach, drug, strain), names_to = "stat")
  }
  return(list(full_df_proc,drug.filtering.summary))
}
dose.check.plot <- function(data){
  strain_colors       <- c("blue",   "orange","#5A0C13","#C51B29",  "#a37000","#627264","#67697C","purple")
  names(strain_colors) <- c("CB4856","PD1074", "ECA36",  "ECA396"  ,"ECA248", "RC301",   "MY16", "XZ1516")
  ggplot(data) + 
  theme_bw(base_size = 8) + 
  # geom_jitter(mapping = aes(x = strain, y = median_wormlength_um_reg, colour = Metadata_Experiment),size = 1) + 
    geom_quasirandom(mapping = aes(x = strain, y = median_wormlength_um_reg, colour = Metadata_Experiment), size = 1) + 
    geom_boxplot(mapping = aes(x = strain, y = median_wormlength_um_reg), 
               outlier.shape = NA, alpha = 0.5) + 
  facet_wrap(.~round(concentration_um,2), scales = "free") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
        legend.position = "top") + 
  labs(fill = "Strain",
       y = "Relative Worm Length (um)",
       x = "Strain") + 
  theme(plot.title = element_text(hjust = 0.5), legend.box="vertical") + 
  ylim(c(-810,200)) +
  scale_colour_brewer(palette = "Dark2") + 
  ggtitle(unique(data$drug))
}
data.cleaning.plot <- function(data, title){
  data %>%
  dplyr::filter(stat %in% c("pct.retained","pct.outlier","pct.cleaned")) %>%
  dplyr::mutate(bleach = paste("Bleach", bleach, sep = " ")) %>%
  ggplot(., mapping = aes(x = strain, y = value, fill = stat)) + 
  theme_bw() +
  geom_col() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        legend.position = "top") +
  scale_fill_brewer(palette = "Set1", name = "Cleaning Category") + 
  facet_wrap(.~Metadata_Experiment+bleach) + 
  ggtitle(paste(unique(data$drug), title, sep = ": ")) + 
  labs(x = "Strain", y = "Experimental Retention (% of Expected Wells)")
}
EC10.plot <- function(e, d){
  max.EC10 <- e %>%
    dplyr::filter(fraction == "EC10") %>%
    dplyr::select(Estimate, `Std. Error`) %>%
    dplyr::mutate(max.value = Estimate + `Std. Error`) %>%
    dplyr::filter(max.value == max(max.value)) %>%
    dplyr::select(max.value) %>% as.numeric()
  
  
  if(max(d[[1]]$concentration_um) < max.EC10){
    e %>%
      dplyr::mutate(label = paste0(best.model,"; ",round(Estimate, 2)," µM")) %>%
      dplyr::filter(fraction == "EC10") %>%
      ggplot(., mapping = aes(x = strain, y = Estimate, colour = strain)) + 
      theme_bw() +
      geom_pointrange(aes(ymin=Lower, ymax=Upper)) +
      # geom_text_repel(aes(label = round(Estimate, 2)), size = 3, box.padding = 0.5, colour = "black") +
      # geom_text_repel(aes(label = best.model), size = 3, box.padding = 2, colour = "black") +
      geom_text_repel(aes(label = label), size = 3, box.padding = 2, colour = "black") +
      scale_y_log10() +
      geom_hline(yintercept = max(d[[1]]$concentration_um), linetype = 2, colour = "grey") + 
      scale_colour_manual(values = strain_colors, name = "Strain") + 
      theme(axis.ticks.x = element_blank(),
            axis.text.x = element_blank(),
            axis.title.x = element_blank(),
            panel.grid = element_blank()) + 
      labs(y = "EC10", x = "Strain")
  } else {
    e %>%
      dplyr::mutate(label = paste0(best.model,"; ",round(Estimate, 2)," µM")) %>%
      dplyr::filter(fraction == "EC10") %>%
      ggplot(., mapping = aes(x = strain, y = Estimate, colour = strain)) + 
      theme_bw() +
      geom_pointrange(aes(ymin=Lower, ymax=Upper)) +
      # geom_text_repel(aes(label = round(Estimate, 2)), size = 3, box.padding = 0.5, colour = "black") +
      # geom_text_repel(aes(label = best.model), size = 3, box.padding = 2, colour = "black") +
      geom_text_repel(aes(label = label), size = 3, box.padding = 2, colour = "black") +
      scale_y_log10(limits = c(unique(d[[1]]$concentration_um)[2],
                               max(d[[1]]$concentration_um))) +
            theme(axis.ticks.x = element_blank(),
            axis.text.x = element_blank(),
            axis.title.x = element_blank(),
            panel.grid = element_blank()) + 
      scale_colour_manual(values = strain_colors, name = "Strain") + 
      labs(y = "EC10", x = "Strain")
    
    
  }

}
```

## Assay Summary
```{r Assay Diagnostics, echo=FALSE, fig.height=7, fig.width=10, message=FALSE, warning=FALSE}

# 4 Model - Worm_Length Filtered
all.4model.dat <- MDHD.toxin09A$summarized_processed %>%
  dplyr::full_join(MDHD.toxin10A$summarized_processed) %>%
  dplyr::full_join(MDHD.toxin11A$summarized_processed) %>%
  dplyr::full_join(MDHD.toxin14A$summarized_processed) %>%
  dplyr::full_join(MDHD.toxin14B$summarized_processed) %>%
  dplyr::full_join(MDHD.toxin15A$summarized_processed) %>%
  dplyr::full_join(MDHD.toxin15B$summarized_processed) %>%
  dplyr::full_join(MDHD.toxin16A$summarized_processed) %>%
  dplyr::full_join(MDHD.toxin17A$summarized_processed) %>%
  dplyr::full_join(MDHD.toxin18A$summarized_processed) %>%
  dplyr::full_join(MDHD.toxin19A$summarized_processed) %>%
  dplyr::full_join(MDHD.toxin22A$summarized_processed) %>%
  dplyr::full_join(MDHD.toxin23A$summarized_processed) %>%
  dplyr::full_join(MDHD.toxin24A$summarized_processed) %>%
  dplyr::full_join(MDHD.toxin25A$summarized_processed) %>%
  dplyr::full_join(MDHD.toxin26A$summarized_processed) %>%
  dplyr::full_join(MDHD.toxin27A$summarized_processed) %>%
  dplyr::mutate(drug = if_else(drug == "copper",
                        true = "Copper(II) chloride",
                        false = drug),
                drug = if_else(drug == "zinc", 
                        true = "Zinc dichloride", 
                        false = drug),
                drug = if_else(drug == "methyl_mercury",
                        true = "Methylmercury dichloride",
                        false = drug),
                drug = if_else(drug == "cadmium",
                        true = "Cadmium dichloride",
                        false = drug),
                drug = if_else(drug == "nickel",
                        true = "Nickel dichloride",
                        false = drug),
                drug = if_else(drug == "silver",
                        true = "Silver nitrate",
                        false = drug)) %>%
  dplyr::mutate(drug = as.factor(stringr::str_to_sentence(drug)))
pre.tab <- all.4model.dat %>%
  dplyr::group_by(drug, strain, Metadata_Experiment) %>%
  tidyr::nest()
tab <- list()
for(i in 1:length(pre.tab$data)){
  g <- pre.tab$data[[i]] %>%
    dplyr::mutate(dose = as.factor(concentration_um),
                  strain = pre.tab$strain[[i]],
                  drug = pre.tab$drug[[i]],
                  assay = pre.tab$Metadata_Experiment[[i]])
  levels(g$dose) <- c(1:length(levels(g$dose)))
  tab[[i]] <- g
}
raw.tab.dat.MDHD <- Reduce(rbind, tab) %>%
  dplyr::select(Metadata_Plate, assay, bleach, drug, strain, dose, n, median_wormlength_um, Metadata_Well)

# Percentage of Expected Wells - 4 Model; Worm_Length Filtered
raw.tab.dat.MDHD %>%
  dplyr::filter(n < 30,
                n > 5) %>%
  dplyr::group_by(bleach, drug, strain, assay) %>%
  summarise(n = n()) %>%
  dplyr::mutate(perc.full.assay = n/48) %>%
  ggplot(., mapping = aes(x = strain, y = bleach, fill = perc.full.assay)) + 
  theme_bw(base_size = 10) + 
  geom_tile(colour = "black") + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        legend.position = "top", legend.justification = "left",
        panel.grid = element_blank(),
        strip.text.y.right = element_text(angle = 0)) +
  scale_fill_distiller(palette = "RdYlBu", direction = 1, name = "Assay Complement (% Expected Wells)") + 
  facet_grid(drug~assay, drop = TRUE, scales = "free", space = "free") + 
  labs(x = "Strain", y = "Bleach", y = "Drug", title = "4 Worm Model Measurements, Worm_Length < 50") + 
  ggsave(filename = "output/4model.heatmap.png", height = 10, width = 15)




  


control.wells.variance <- raw.tab.dat.MDHD %>%
  dplyr::filter(dose == 1) %>%
  dplyr::group_by(assay, bleach, strain) %>%
  dplyr::summarise(mean.n = mean(n),
                   sd.n = sd(n),
                   cv.n = (sd.n/mean.n),
                   mean.median_wormlength_um = mean(median_wormlength_um),
                   sd.median_wormlength_um = sd(median_wormlength_um),
                   cv.worm.length = sd(median_wormlength_um)/mean(median_wormlength_um)) %>%
  tidyr::pivot_longer(cols = !c(assay, bleach, strain), names_to = "metric")

control.wells.variance %>%
  dplyr::filter(metric == "cv.n") %>%
  ggplot(., mapping = aes(x = assay, y = value, fill = as.factor(bleach))) +
  theme_bw() +
  # geom_jitter(shape = 21, width = 0.1, alpha = 0.75) +
  geom_boxplot() + 
  scale_fill_brewer(palette = "Set1", name = "Bleach") + 
  facet_wrap(.~metric, scales = "free") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
        legend.position = "top") + 
  labs(title = "Control Well Variance in Titering",
       y = "Variance Metric",
       x = "Assay")

cv.n.censor <- control.wells.variance %>%
  dplyr::filter(metric == "cv.n") %>%
  dplyr::group_by(assay, bleach) %>%
  dplyr::summarise(median = median(value)) %>%
  dplyr::mutate(cv.censor = if_else(condition = median > 0.5, true = 1, false = 0)) %>%
  dplyr::rename(Metadata_Experiment = assay)
data.frame(cv.n.censor)
control.wells.variance %>%
  dplyr::filter(metric %in% c("cv.n","cv.worm.length")) %>%
  tidyr::pivot_wider(names_from = bleach, values_from = value) %>%
  as.data.frame() %>%
  write.csv(x = ., file = "output/cv.control.wells.csv", quote = F, row.names = F)

control.wells.variance %>%
  dplyr::ungroup() %>%
  dplyr::filter(metric == "cv.n") %>%
  aov(data = ., formula = value ~ assay * as.factor(bleach) + strain ) %>%
  summary()

```

## Silver
```{r Silver, echo=FALSE, message=FALSE, warning=FALSE}
silver <- purrr::map2(MDHD.data.list, 
                      "silver",
                      pull.toxin)
silver.df <- Reduce(rbind,silver) %>%
  dplyr::mutate(drug = levels(as.factor(drug))[2],
                assay_bleach = paste(Metadata_Experiment,bleach,sep = "_")) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  dplyr::filter(!assay_bleach %in% c("toxin09A_1","toxin11A_1","toxin15A_1","toxin15A_2")) %>%
  cleanData(.)
data.cleaning.plot(silver.df[[2]], "Bleach Quality")
dose.check.plot(silver.df[[1]])


# drug.drm <- suppressMessages(fit_all_models(data = silver.df[[1]], 
#                                             traits = "median_wormlength_um_reg"))
# plot_EC50s_on_DRC(all.model.list = drug.drm,
#                   toxin = levels(as.factor(silver.df[[1]]$drug)), 
#                   metadata = silver.df[[1]])
# Silver_nitrate_DRCplot+
#   ggplot2::labs(subtitle = "LL4 Model")
# silver.LL4.estimates <- strain.EC50s(drug.drm = drug.drm, 
#                                     drug.df = silver.df[[1]]) %>%
#   dplyr::filter(model == "LL.4")



### Best model from model selection
best.drug.drm <- suppressMessages(fit_best_models(data = silver.df[[1]], 
                                            traits = "median_wormlength_um_reg"))
plot_best_DRC(all.model.list = best.drug.drm,
              toxin = levels(as.factor(silver.df[[1]]$drug)), 
              metadata = silver.df[[1]])
Silver_nitrate_DRCplot +
  ggplot2::labs(subtitle = "Selected Models")
silver.selected.EC.estimates <- selected.strain.EC50s(best.drug.drm = best.drug.drm,
                          drug.df = silver.df[[1]])
EC10.plot(e = silver.selected.EC.estimates, d = silver.df)
```

## Cadmium
```{r Cadmium, echo=FALSE, message=FALSE, warning=FALSE}
cadmium <- purrr::map2(MDHD.data.list, 
                        "cadmium",
                        pull.toxin)

cadmium.df <- Reduce(rbind,cadmium) %>%
  dplyr::mutate(drug = levels(as.factor(drug))[2],
                assay_bleach = paste(Metadata_Experiment,bleach,sep = "_")) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  dplyr::filter(!assay_bleach %in% c("toxin09A_1","toxin10A_1","toxin11A_1","toxin15A_1","toxin15A_2")) %>%
  cleanData(.)
data.cleaning.plot(cadmium.df[[2]], "Bleach Quality: Filtered")
dose.check.plot(cadmium.df[[1]])

# drug.drm <- suppressMessages(fit_all_models(data = cadmium.df[[1]], 
#                                             traits = "median_wormlength_um_reg"))
# 
# plot_EC50s_on_DRC(all.model.list = drug.drm,
#                   toxin = levels(as.factor(cadmium.df[[1]]$drug)), 
#                   metadata = cadmium.df[[1]])
# Cadmium_dichloride_DRCplot +
#   ggplot2::labs(subtitle = "LL4 Model")
# cadmium.LL4.estimates <- strain.EC50s(drug.drm = drug.drm, 
#                                     drug.df = cadmium.df[[1]])%>%
#   dplyr::filter(model == "LL.4")


### Best model from model selection
best.drug.drm <- suppressMessages(fit_best_models(data = cadmium.df[[1]], 
                                            traits = "median_wormlength_um_reg"))
plot_best_DRC(all.model.list = best.drug.drm,
              toxin = levels(as.factor(cadmium.df[[1]]$drug)), 
              metadata = cadmium.df[[1]])
Cadmium_dichloride_DRCplot +
  ggplot2::labs(subtitle = "Selected Models")
cadmium.selected.EC.estimates <- selected.strain.EC50s(best.drug.drm = best.drug.drm,
                          drug.df = cadmium.df[[1]])
EC10.plot(e = cadmium.selected.EC.estimates, d = cadmium.df)
```

## Copper
```{r Copper, echo=FALSE, message=FALSE, warning=FALSE}
copper <- purrr::map2(MDHD.data.list, 
                        "copper",
                        pull.toxin)
copper.df <- Reduce(rbind,copper) %>%
  dplyr::mutate(drug = levels(as.factor(drug))[2],
                assay_bleach = paste(Metadata_Experiment,bleach,sep = "_")) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  dplyr::filter(!assay_bleach %in% c("toxin09A_1","toxin11A_1","toxin15A_1","toxin15A_2")) %>%
  cleanData(.)

data.cleaning.plot(copper.df[[2]], "Bleach Quality")
dose.check.plot(copper.df[[1]])

# drug.drm <- suppressMessages(fit_all_models(data = copper.df[[1]], 
#                                             traits = "median_wormlength_um_reg"))
# plot_EC50s_on_DRC(all.model.list = drug.drm,
#                   toxin = levels(as.factor(copper.df[[1]]$drug)), 
#                   metadata = copper.df[[1]])
# `Copper(II)_chloride_DRCplot`+
#   ggplot2::labs(subtitle = "LL4 Model")
# copper.LL4.estimates <- strain.EC50s(drug.drm = drug.drm, 
#                                     drug.df = copper.df[[1]])%>%
#   dplyr::filter(model == "LL.4")

### Best model from model selection
best.drug.drm <- suppressMessages(fit_best_models(data = copper.df[[1]], 
                                            traits = "median_wormlength_um_reg"))
copper.selected.EC.estimates <- selected.strain.EC50s(best.drug.drm = best.drug.drm,
                                                      drug.df = copper.df[[1]])

plot_best_DRC(all.model.list = best.drug.drm,
              toxin = levels(as.factor(copper.df[[1]]$drug)), 
              metadata = copper.df[[1]])
`Copper(II)_chloride_DRCplot` +
  ggplot2::labs(subtitle = "Selected Models")

EC10.plot(e = copper.selected.EC.estimates, d = copper.df)
```

## Nickel
```{r Nickel, echo=FALSE, message=FALSE, warning=FALSE}
nickel <- purrr::map2(MDHD.data.list, 
                        "nickel",
                        pull.toxin)
nickel.df <- Reduce(rbind,nickel) %>%
  dplyr::mutate(drug = levels(as.factor(drug))[2],
                assay_bleach = paste(Metadata_Experiment,bleach,sep = "_")) %>%## from combining 9,10,11
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  dplyr::filter(!assay_bleach %in% c("toxin09A_1","toxin11A_1","toxin15A_1")) %>%
  cleanData(.)
data.cleaning.plot(nickel.df[[2]], "Bleach Quality")
dose.check.plot(nickel.df[[1]])

# drug.drm <- suppressMessages(fit_all_models(data = nickel.df[[1]],
#                                             traits = "median_wormlength_um_reg"))
# plot_EC50s_on_DRC(all.model.list = drug.drm,
#                   toxin = levels(as.factor(nickel.df[[1]]$drug)),
#                   metadata = nickel.df[[1]])
# 
# Nickel_dichloride_DRCplot+
#   ggplot2::labs(subtitle = "LL4 Model")
# nickel.LL4.estimates <- strain.EC50s(drug.drm = drug.drm,
#                                     drug.df = nickel.df[[1]])%>%
#   dplyr::filter(model == "LL.4")


### Best model from model selection
best.drug.drm <- suppressMessages(fit_best_models(data = nickel.df[[1]], 
                                            traits = "median_wormlength_um_reg"))
plot_best_DRC(all.model.list = best.drug.drm,
              toxin = levels(as.factor(nickel.df[[1]]$drug)), 
              metadata = nickel.df[[1]])
Nickel_dichloride_DRCplot +
  ggplot2::labs(subtitle = "Selected Models")
nickel.selected.EC.estimates <- selected.strain.EC50s(best.drug.drm = best.drug.drm,
                          drug.df = nickel.df[[1]])
EC10.plot(e = nickel.selected.EC.estimates, d = nickel.df)
```

## Paraquat
```{r Paraquat, echo=FALSE, message=FALSE, warning=FALSE}
paraquat <- purrr::map2(MDHD.data.list, 
                        "paraquat",
                        pull.toxin)
paraquat.df <- Reduce(rbind,paraquat) %>%
  dplyr::mutate(drug = levels(as.factor(drug))[2],
                assay_bleach = paste(Metadata_Experiment,bleach,sep = "_")) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  dplyr::filter(!assay_bleach %in% c("toxin09A_1","toxin10A_1","toxin11A_1","toxin15A_1")) %>%
  cleanData(.)
data.cleaning.plot(paraquat.df[[2]], "Bleach Quality")
dose.check.plot(paraquat.df[[1]])

# drug.drm <- suppressMessages(fit_all_models(data = paraquat.df[[1]], 
#                                             traits = "median_wormlength_um_reg"))
# 
# plot_EC50s_on_DRC(all.model.list = drug.drm,
#                   toxin = levels(as.factor(paraquat.df[[1]]$drug)), 
#                   metadata = paraquat.df[[1]])
# 
# Paraquat_DRCplot+
#   ggplot2::labs(subtitle = "LL4 Model")
# paraquat.LL4.estimates <- strain.EC50s(drug.drm = drug.drm, 
#                                     drug.df = paraquat.df[[1]])%>%
#   dplyr::filter(model == "LL.4")


### Best model from model selection
best.drug.drm <- suppressMessages(fit_best_models(data = paraquat.df[[1]], 
                                            traits = "median_wormlength_um_reg"))
plot_best_DRC(all.model.list = best.drug.drm,
              toxin = levels(as.factor(paraquat.df[[1]]$drug)), 
              metadata = paraquat.df[[1]])
Paraquat_DRCplot +
  ggplot2::labs(subtitle = "Selected Models")
paraquat.selected.EC.estimates <- selected.strain.EC50s(best.drug.drm = best.drug.drm,
                          drug.df = paraquat.df[[1]])
EC10.plot(e = paraquat.selected.EC.estimates, d = paraquat.df)

```

## Zinc
```{r Zinc, echo=FALSE, message=FALSE, warning=FALSE}
zinc <- purrr::map2(MDHD.data.list, 
                        "zinc",
                        pull.toxin)
zinc.df <- Reduce(rbind,zinc) %>%
  dplyr::mutate(drug = levels(as.factor(drug))[2],
                assay_bleach = paste(Metadata_Experiment,bleach,sep = "_")) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  dplyr::filter(!assay_bleach %in% c("toxin09A_1","toxin11A_1","toxin15A_1")) %>%
  cleanData(.)
data.cleaning.plot(zinc.df[[2]], "Bleach Quality")
dose.check.plot(zinc.df[[1]])
# 
# drug.drm <- suppressMessages(fit_all_models(data = zinc.df[[1]], 
#                                             traits = "median_wormlength_um_reg"))
# plot_EC50s_on_DRC(all.model.list = drug.drm,
#                   toxin = levels(as.factor(zinc.df[[1]]$drug)), 
#                   metadata = zinc.df[[1]])
# Zinc_dichloride_DRCplot+
#   ggplot2::labs(subtitle = "LL4 Model")

# zinc.LL4.estimates <- strain.EC50s(drug.drm = drug.drm, 
#                                     drug.df = zinc.df[[1]])%>%
#   dplyr::filter(model == "LL.4")

### Best model from model selection
best.drug.drm <- suppressMessages(fit_best_models(data = zinc.df[[1]], 
                                            traits = "median_wormlength_um_reg"))
plot_best_DRC(all.model.list = best.drug.drm,
              toxin = levels(as.factor(zinc.df[[1]]$drug)), 
              metadata = zinc.df[[1]])
Zinc_dichloride_DRCplot +
  ggplot2::labs(subtitle = "Selected Models")
zinc.selected.EC.estimates <- selected.strain.EC50s(best.drug.drm = best.drug.drm,
                          drug.df = zinc.df[[1]])
EC10.plot(e = zinc.selected.EC.estimates, d = zinc.df)
```

## Pyraclostrobin
```{r Pyraclostrobin, echo=FALSE, message=FALSE, warning=FALSE}
pyraclostrobin <- purrr::map2(MDHD.data.list, 
                        "pyraclostrobin",
                        pull.toxin)

pyraclostrobin.df <- Reduce(rbind,pyraclostrobin) %>%
  dplyr::mutate(drug = levels(as.factor(drug))[2],
                assay_bleach = paste(Metadata_Experiment,bleach,sep = "_")) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  dplyr::filter(!assay_bleach %in% c("toxin09A_1","toxin10A_1","toxin11A_1","toxin15B_2")) %>%
  cleanData(.)
data.cleaning.plot(pyraclostrobin.df[[2]], "Bleach Quality")
dose.check.plot(pyraclostrobin.df[[1]])

# drug.drm <- suppressMessages(fit_all_models(data = pyraclostrobin.df[[1]], 
#                                             traits = "median_wormlength_um_reg"))
# plot_EC50s_on_DRC(all.model.list = drug.drm,
#                   toxin = levels(as.factor(pyraclostrobin.df[[1]]$drug)), 
#                   metadata = pyraclostrobin.df[[1]])
# 
# Pyraclostrobin_DRCplot+
#   ggplot2::labs(subtitle = "LL4 Model")
# pyraclostrobin.LL4.estimates <- strain.EC50s(drug.drm = drug.drm, 
#                                     drug.df = pyraclostrobin.df[[1]])%>%
#   dplyr::filter(model == "LL.4")

### Best model from model selection
best.drug.drm <- suppressMessages(fit_best_models(data = pyraclostrobin.df[[1]], 
                                            traits = "median_wormlength_um_reg"))
plot_best_DRC(all.model.list = best.drug.drm,
              toxin = levels(as.factor(pyraclostrobin.df[[1]]$drug)), 
              metadata = pyraclostrobin.df[[1]])
Pyraclostrobin_DRCplot +
  ggplot2::labs(subtitle = "Selected Models")
pyraclostrobin.selected.EC.estimates <- selected.strain.EC50s(best.drug.drm = best.drug.drm,
                          drug.df = pyraclostrobin.df[[1]])
EC10.plot(e = pyraclostrobin.selected.EC.estimates, d = pyraclostrobin.df)
```

## Aldicarb
```{r Aldicarb, echo=FALSE, message=FALSE, warning=FALSE}
aldicarb <- purrr::map2(MDHD.data.list, 
                        "aldicarb",
                        pull.toxin)
aldicarb.df <- Reduce(rbind,aldicarb) %>%
  dplyr::mutate(drug = levels(as.factor(drug))[2],
                assay_bleach = paste(Metadata_Experiment,bleach,sep = "_")) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  dplyr::filter(!assay_bleach %in% c("toxin10A_1","toxin11A_1")) %>%
  cleanData(.)
data.cleaning.plot(aldicarb.df[[2]], "Bleach Quality")
dose.check.plot(aldicarb.df[[1]])

# drug.drm <- suppressMessages(fit_all_models(data = aldicarb.df[[1]], 
#                                             traits = "median_wormlength_um_reg"))
# plot_EC50s_on_DRC(all.model.list = drug.drm,
#                   toxin = levels(as.factor(aldicarb.df[[1]]$drug)), 
#                   metadata = aldicarb.df[[1]])
# 
# Aldicarb_DRCplot+
#   ggplot2::labs(subtitle = "LL4 Model")
# aldicarb.LL4.estimates <- strain.EC50s(drug.drm = drug.drm, 
#                                     drug.df = aldicarb.df[[1]])%>%
#   dplyr::filter(model == "LL.4")

### Best model from model selection
best.drug.drm <- suppressMessages(fit_best_models(data = aldicarb.df[[1]], 
                                            traits = "median_wormlength_um_reg"))
plot_best_DRC(all.model.list = best.drug.drm,
              toxin = levels(as.factor(aldicarb.df[[1]]$drug)), 
              metadata = aldicarb.df[[1]])
Aldicarb_DRCplot +
  ggplot2::labs(subtitle = "Selected Models")
aldicarb.selected.EC.estimates <- selected.strain.EC50s(best.drug.drm = best.drug.drm,
                          drug.df = aldicarb.df[[1]])
EC10.plot(e = aldicarb.selected.EC.estimates, d = aldicarb.df)
```

## Chlorfenapyr
```{r Chlorfenapyr, echo=FALSE, message=FALSE, warning=FALSE}
chlorfenapyr <- purrr::map2(MDHD.data.list, 
                        "chlorfenapyr",
                        pull.toxin)

chlorfenapyr.df <- Reduce(rbind,chlorfenapyr) %>%
  dplyr::mutate(drug = levels(as.factor(drug))[2],
                assay_bleach = paste(Metadata_Experiment,bleach,sep = "_")) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  dplyr::filter(!assay_bleach %in% c("toxin09A_1","toxin10A_1","toxin11A_1","toxin15B_1")) %>%
  cleanData(.)
data.cleaning.plot(chlorfenapyr.df[[2]], "Bleach Quality")
dose.check.plot(chlorfenapyr.df[[1]])

# drug.drm <- suppressMessages(fit_all_models(data = chlorfenapyr.df[[1]], 
#                                             traits = "median_wormlength_um_reg"))
# plot_EC50s_on_DRC(all.model.list = drug.drm,
#                   toxin = levels(as.factor(chlorfenapyr.df[[1]]$drug)), 
#                   metadata = chlorfenapyr.df[[1]])
# Chlorfenapyr_DRCplot+
#   ggplot2::labs(subtitle = "LL4 Model")
# 
# chlorfenapyr.LL4.estimates <- strain.EC50s(drug.drm = drug.drm, 
#                                     drug.df = chlorfenapyr.df[[1]])%>%
#   dplyr::filter(model == "LL.4")

### Best model from model selection
best.drug.drm <- suppressMessages(fit_best_models(data = chlorfenapyr.df[[1]], 
                                            traits = "median_wormlength_um_reg"))
plot_best_DRC(all.model.list = best.drug.drm,
              toxin = levels(as.factor(chlorfenapyr.df[[1]]$drug)), 
              metadata = chlorfenapyr.df[[1]])
Chlorfenapyr_DRCplot +
  ggplot2::labs(subtitle = "Selected Models")
chlorfenapyr.selected.EC.estimates <- selected.strain.EC50s(best.drug.drm = best.drug.drm,
                          drug.df = chlorfenapyr.df[[1]])
EC10.plot(e = chlorfenapyr.selected.EC.estimates, d = chlorfenapyr.df)
```

## Methomyl
```{r Methomyl, echo=FALSE, message=FALSE, warning=FALSE}
methomyl <- purrr::map2(MDHD.data.list, 
                        "methomyl",
                        pull.toxin)
methomyl.df <- Reduce(rbind,methomyl) %>%
  dplyr::mutate(drug = levels(as.factor(drug))[2],
                assay_bleach = paste(Metadata_Experiment,bleach,sep = "_")) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  dplyr::filter(!assay_bleach %in% c("toxin10A_1","toxin11A_1","toxin14B_1")) %>%
  cleanData(.)

data.cleaning.plot(methomyl.df[[2]], "Bleach Quality")
dose.check.plot(methomyl.df[[1]])

drug.drm <- suppressMessages(fit_all_models(data = methomyl.df[[1]], 
                                            traits = "median_wormlength_um_reg"))
# plot_EC50s_on_DRC(all.model.list = drug.drm,
#                   toxin = levels(as.factor(methomyl.df[[1]]$drug)), 
#                   metadata = methomyl.df[[1]])
# Methomyl_DRCplot+
#   ggplot2::labs(subtitle = "LL4 Model")
# 
# methomyl.LL4.estimates <- strain.EC50s(drug.drm = drug.drm, 
#                                     drug.df = methomyl.df[[1]])%>%
#   dplyr::filter(model == "LL.4")

### Best model from model selection
best.drug.drm <- suppressMessages(fit_best_models(data = methomyl.df[[1]], 
                                            traits = "median_wormlength_um_reg"))
plot_best_DRC(all.model.list = best.drug.drm,
              toxin = levels(as.factor(methomyl.df[[1]]$drug)), 
              metadata = methomyl.df[[1]])
Methomyl_DRCplot +
  ggplot2::labs(subtitle = "Selected Models")
methomyl.selected.EC.estimates <- selected.strain.EC50s(best.drug.drm = best.drug.drm,
                          drug.df = methomyl.df[[1]])
EC10.plot(e = methomyl.selected.EC.estimates, d = methomyl.df)
```

## Methyl Mercury
```{r Methyl Mercury, echo=FALSE, message=FALSE, warning=FALSE}
methyl.mercury <- purrr::map2(MDHD.data.list, 
                        "mercury",
                        pull.toxin)
methyl.mercury.df <- Reduce(rbind,methyl.mercury) %>%
  dplyr::mutate(drug = levels(as.factor(drug))[2],
                assay_bleach = paste(Metadata_Experiment,bleach,sep = "_")) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  dplyr::filter(!assay_bleach %in% c("toxin10A_1","toxin11A_1")) %>%
  cleanData(.)

data.cleaning.plot(methyl.mercury.df[[2]], "Bleach Quality")
dose.check.plot(methyl.mercury.df[[1]])

# drug.drm <- suppressMessages(fit_all_models(data = methyl.mercury.df[[1]], 
#                                             traits = "median_wormlength_um_reg"))
# plot_EC50s_on_DRC(all.model.list = drug.drm,
#                   toxin = levels(as.factor(methyl.mercury.df[[1]]$drug)), 
#                   metadata = methyl.mercury.df[[1]])
# Methylmercury_dichloride_DRCplot+
#   ggplot2::labs(subtitle = "LL4 Model")
# methyl.mercury.LL4.estimates <- strain.EC50s(drug.drm = drug.drm, 
#                                     drug.df = methyl.mercury.df[[1]])%>%
#   dplyr::filter(model == "LL.4")

### Best model from model selection
best.drug.drm <- suppressMessages(fit_best_models(data = methyl.mercury.df[[1]], 
                                            traits = "median_wormlength_um_reg"))
plot_best_DRC(all.model.list = best.drug.drm,
              toxin = levels(as.factor(methyl.mercury.df[[1]]$drug)), 
              metadata = methyl.mercury.df[[1]])
Methylmercury_dichloride_DRCplot +
  ggplot2::labs(subtitle = "Selected Models")
methyl.mercury.selected.EC.estimates <- selected.strain.EC50s(best.drug.drm = best.drug.drm,
                          drug.df = methyl.mercury.df[[1]])
EC10.plot(e = methyl.mercury.selected.EC.estimates, d = methyl.mercury.df)
```

## Triphenyl phosphate
```{r Triphenyl Phosphate, echo=FALSE, message=FALSE, warning=FALSE}
tpp <- purrr::map2(MDHD.data.list, 
                   "triphenyl",
                   pull.toxin)
tpp.df <- Reduce(rbind,tpp) %>%
  dplyr::mutate(drug = levels(as.factor(drug))[2],
                assay_bleach = paste(Metadata_Experiment,bleach,sep = "_")) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  dplyr::filter(!assay_bleach %in% c("toxin09A_1","toxin11A_1","toxin15B_1")) %>%
  cleanData(.)

data.cleaning.plot(tpp.df[[2]], "Bleach Quality")
dose.check.plot(tpp.df[[1]])

# drug.drm <- suppressMessages(fit_all_models(data = tpp.df[[1]], 
#                                             traits = "median_wormlength_um_reg"))
# plot_EC50s_on_DRC(all.model.list = drug.drm,
#                   toxin = levels(as.factor(tpp.df[[1]]$drug)), 
#                   metadata = tpp.df[[1]])
# Triphenyl_phosphate_DRCplot+
#   ggplot2::labs(subtitle = "LL4 Model")
# tpp.LL4.estimates <- strain.EC50s(drug.drm = drug.drm, 
#                                     drug.df = tpp.df[[1]])%>%
#   dplyr::filter(model == "LL.4")

### Best model from model selection
best.drug.drm <- suppressMessages(fit_best_models(data = tpp.df[[1]], 
                                            traits = "median_wormlength_um_reg"))
plot_best_DRC(all.model.list = best.drug.drm,
              toxin = levels(as.factor(tpp.df[[1]]$drug)), 
              metadata = tpp.df[[1]])
Triphenyl_phosphate_DRCplot +
  ggplot2::labs(subtitle = "Selected Models")
tpp.selected.EC.estimates <- selected.strain.EC50s(best.drug.drm = best.drug.drm,
                          drug.df = tpp.df[[1]])
EC10.plot(e = tpp.selected.EC.estimates, d = tpp.df)
```

## Arsenic trioxide
```{r Arsenic trioxide, echo=FALSE, message=FALSE, warning=FALSE}
arsenic <- purrr::map2(MDHD.data.list, 
                   "Arsenic",
                   pull.toxin)
arsenic.df <- Reduce(rbind,arsenic) %>%
  dplyr::mutate(assay_bleach = paste(Metadata_Experiment,bleach,sep = "_")) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  cleanData(.)
data.cleaning.plot(arsenic.df[[2]], "Bleach Quality")
dose.check.plot(arsenic.df[[1]])

# drug.drm <- suppressMessages(fit_all_models(data = arsenic.df[[1]], 
#                                             traits = "median_wormlength_um_reg"))
# plot_EC50s_on_DRC(all.model.list = drug.drm,
#                   toxin = levels(as.factor(arsenic.df[[1]]$drug)), 
#                   metadata = arsenic.df[[1]])
# Arsenic_trioxide_DRCplot+
#   ggplot2::labs(subtitle = "LL4 Model")
# arsenic.LL4.estimates <- strain.EC50s(drug.drm = drug.drm, 
#                                     drug.df = arsenic.df[[1]])%>%
#   dplyr::filter(model == "LL.4")

### Best model from model selection
best.drug.drm <- suppressMessages(fit_best_models(data = arsenic.df[[1]], 
                                            traits = "median_wormlength_um_reg"))
plot_best_DRC(all.model.list = best.drug.drm,
              toxin = levels(as.factor(arsenic.df[[1]]$drug)), 
              metadata = arsenic.df[[1]])
Arsenic_trioxide_DRCplot +
  ggplot2::labs(subtitle = "Selected Models")
arsenic.selected.EC.estimates <- selected.strain.EC50s(best.drug.drm = best.drug.drm,
                          drug.df = arsenic.df[[1]])
EC10.plot(e = arsenic.selected.EC.estimates, d = arsenic.df)
```

## Carbaryl
```{r Carbaryl, echo=FALSE, message=FALSE, warning=FALSE}
carbaryl <- purrr::map2(MDHD.data.list, 
                   "Carbaryl",
                   pull.toxin)
carbaryl.df <- Reduce(rbind,carbaryl) %>%
  dplyr::mutate(assay_bleach = paste(Metadata_Experiment,bleach,sep = "_")) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  # dplyr::filter(!assay_bleach %in% c("toxin09A_1","toxin11A_1","toxin15A_1","toxin15A_2")) %>%
  cleanData(.)
data.cleaning.plot(carbaryl.df[[2]], "Bleach Quality")
dose.check.plot(carbaryl.df[[1]])

# drug.drm <- suppressMessages(fit_all_models(data = carbaryl.df[[1]], 
#                                             traits = "median_wormlength_um_reg"))
# plot_EC50s_on_DRC(all.model.list = drug.drm,
#                   toxin = levels(as.factor(carbaryl.df[[1]]$drug)), 
#                   metadata = carbaryl.df[[1]])
# Carbaryl_DRCplot+
#   ggplot2::labs(subtitle = "LL4 Model")
# carbaryl.LL4.estimates <- strain.EC50s(drug.drm = drug.drm, 
#                                     drug.df = carbaryl.df[[1]])%>%
#   dplyr::filter(model == "LL.4")

### Best model from model selection
best.drug.drm <- suppressMessages(fit_best_models(data = carbaryl.df[[1]], 
                                            traits = "median_wormlength_um_reg"))
plot_best_DRC(all.model.list = best.drug.drm,
              toxin = levels(as.factor(carbaryl.df[[1]]$drug)), 
              metadata = carbaryl.df[[1]])
Carbaryl_DRCplot +
  ggplot2::labs(subtitle = "Selected Models")
carbaryl.selected.EC.estimates <- selected.strain.EC50s(best.drug.drm = best.drug.drm,
                          drug.df = carbaryl.df[[1]])
EC10.plot(e = carbaryl.selected.EC.estimates, d = carbaryl.df)
```

## Carboxin
```{r Carboxin, echo=FALSE, message=FALSE, warning=FALSE}
carboxin <- purrr::map2(MDHD.data.list, 
                   "Carboxin",
                   pull.toxin)
carboxin.df <- Reduce(rbind,carboxin) %>%
  dplyr::mutate(assay_bleach = paste(Metadata_Experiment,bleach,sep = "_")) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  cleanData(.)
data.cleaning.plot(carboxin.df[[2]], "Bleach Quality")
dose.check.plot(carboxin.df[[1]])

# drug.drm <- suppressMessages(fit_all_models(data = carboxin.df[[1]], 
#                                             traits = "median_wormlength_um_reg"))
# plot_EC50s_on_DRC(all.model.list = drug.drm,
#                   toxin = levels(as.factor(carboxin.df[[1]]$drug)), 
#                   metadata = carboxin.df[[1]])
# Carboxin_DRCplot+
#   ggplot2::labs(subtitle = "LL4 Model")
# carboxin.LL4.estimates <- strain.EC50s(drug.drm = drug.drm, 
#                                     drug.df = carboxin.df[[1]])%>%
#   dplyr::filter(model == "LL.4")

### Best model from model selection
best.drug.drm <- suppressMessages(fit_best_models(data = carboxin.df[[1]], 
                                                  traits = "median_wormlength_um_reg"))
plot_best_DRC(all.model.list = best.drug.drm,
              toxin = levels(as.factor(carboxin.df[[1]]$drug)), 
              metadata = carboxin.df[[1]])

Carboxin_DRCplot +
  ggplot2::labs(subtitle = "Selected Models")
carboxin.selected.EC.estimates <- selected.strain.EC50s(best.drug.drm = best.drug.drm,
                                                        drug.df = carboxin.df[[1]])
EC10.plot(e = carboxin.selected.EC.estimates, d = carboxin.df)
```

## Chlorpyrifos
```{r Chlorpyrifos, echo=FALSE, message=FALSE, warning=FALSE}
chlorpyrifos <- purrr::map2(MDHD.data.list, 
                   "Chlorpyrifos",
                   pull.toxin)
print("Excluding toxin17A: No Response")
chlorpyrifos.df <- Reduce(rbind,chlorpyrifos) %>%
  dplyr::mutate(assay_bleach = paste(Metadata_Experiment,bleach,sep = "_")) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  dplyr::filter(!Metadata_Experiment %in% c("toxin17A")) %>% 
  cleanData(.)

data.cleaning.plot(chlorpyrifos.df[[2]], "Bleach Quality")
dose.check.plot(chlorpyrifos.df[[1]])

# drug.drm <- suppressMessages(fit_all_models(data = chlorpyrifos.df[[1]], 
#                                             traits = "median_wormlength_um_reg"))
# plot_EC50s_on_DRC(all.model.list = drug.drm,
#                   toxin = levels(as.factor(chlorpyrifos.df[[1]]$drug)), 
#                   metadata = chlorpyrifos.df[[1]])
# Chlorpyrifos_DRCplot+
#   ggplot2::labs(subtitle = "LL4 Model")
# chlorpyrifos.LL4.estimates <- strain.EC50s(drug.drm = drug.drm, 
#                                     drug.df = chlorpyrifos.df[[1]])%>%
#   dplyr::filter(model == "LL.4")

### Best model from model selection
best.drug.drm <- suppressMessages(fit_best_models(data = chlorpyrifos.df[[1]], 
                                            traits = "median_wormlength_um_reg"))
plot_best_DRC(all.model.list = best.drug.drm,
              toxin = levels(as.factor(chlorpyrifos.df[[1]]$drug)), 
              metadata = chlorpyrifos.df[[1]])
Chlorpyrifos_DRCplot +
  ggplot2::labs(subtitle = "Selected Models")
chlorpyrifos.selected.EC.estimates <- selected.strain.EC50s(best.drug.drm = best.drug.drm,
                          drug.df = chlorpyrifos.df[[1]])
EC10.plot(e = chlorpyrifos.selected.EC.estimates, d = chlorpyrifos.df)
```

## Lead (II) nitrate
```{r Lead (II) nitrate, echo=FALSE, message=FALSE, warning=FALSE}
lead <- purrr::map2(MDHD.data.list, 
                   "Lead",
                   pull.toxin)
lead.df <- Reduce(rbind,lead) %>%
  dplyr::mutate(assay_bleach = paste(Metadata_Experiment,bleach,sep = "_")) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  cleanData(.)
data.cleaning.plot(lead.df[[2]], "Bleach Quality")
dose.check.plot(lead.df[[1]])

# drug.drm <- suppressMessages(fit_all_models(data = lead.df[[1]], 
#                                             traits = "median_wormlength_um_reg"))
# plot_EC50s_on_DRC(all.model.list = drug.drm,
#                   toxin = levels(as.factor(lead.df[[1]]$drug)), 
#                   metadata = lead.df[[1]])
# `Lead(II)_nitrate_DRCplot`+
#   ggplot2::labs(subtitle = "LL4 Model")
# lead.LL4.estimates <- strain.EC50s(drug.drm = drug.drm, 
#                                     drug.df = lead.df[[1]])%>%
#   dplyr::filter(model == "LL.4")

### Best model from model selection
best.drug.drm <- suppressMessages(fit_best_models(data = lead.df[[1]], 
                                            traits = "median_wormlength_um_reg"))
plot_best_DRC(all.model.list = best.drug.drm,
              toxin = levels(as.factor(lead.df[[1]]$drug)), 
              metadata = lead.df[[1]])
`Lead(II)_nitrate_DRCplot` +
  ggplot2::labs(subtitle = "Selected Models")
lead.selected.EC.estimates <- selected.strain.EC50s(best.drug.drm = best.drug.drm,
                          drug.df = lead.df[[1]])
EC10.plot(e = lead.selected.EC.estimates, d = lead.df)
```

## Atrazine
```{r Atrazine, echo=FALSE, message=FALSE, warning=FALSE}
atrazine <- purrr::map2(MDHD.data.list, 
                   "Atrazine",
                   pull.toxin)

print("Excluding toxin16A: Inaccurate Dilution Series")
atrazine.df <- Reduce(rbind,atrazine) %>%
  dplyr::mutate(assay_bleach = paste(Metadata_Experiment,bleach,sep = "_")) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  dplyr::filter(!Metadata_Experiment %in% c("toxin16A")) %>% 
  cleanData(.)
data.cleaning.plot(atrazine.df[[2]], "Bleach Quality")
dose.check.plot(atrazine.df[[1]])

# drug.drm <- suppressMessages(fit_all_models(data = atrazine.df[[1]], 
#                                             traits = "median_wormlength_um_reg"))
# plot_EC50s_on_DRC(all.model.list = drug.drm,
#                   toxin = levels(as.factor(atrazine.df[[1]]$drug)), 
#                   metadata = atrazine.df[[1]])
# Atrazine_DRCplot+
#   ggplot2::labs(subtitle = "LL4 Model")
# atrazine.LL4.estimates <- strain.EC50s(drug.drm = drug.drm, 
#                                     drug.df = atrazine.df[[1]])%>%
#   dplyr::filter(model == "LL.4")

### Best model from model selection
best.drug.drm <- suppressMessages(fit_best_models(data = atrazine.df[[1]], 
                                            traits = "median_wormlength_um_reg"))
plot_best_DRC(all.model.list = best.drug.drm,
              toxin = levels(as.factor(atrazine.df[[1]]$drug)), 
              metadata = atrazine.df[[1]])
Atrazine_DRCplot +
  ggplot2::labs(subtitle = "Selected Models")
atrazine.selected.EC.estimates <- selected.strain.EC50s(best.drug.drm = best.drug.drm,
                          drug.df = atrazine.df[[1]])
EC10.plot(e = atrazine.selected.EC.estimates, d = atrazine.df)
```

## 2,4-D
```{r 24-D, echo=FALSE, message=FALSE, warning=FALSE}
x2.4.D <- purrr::map2(MDHD.data.list, 
                   "2,4-D",
                   pull.toxin)

x2.4.D.df <- Reduce(rbind,x2.4.D) %>%
  dplyr::mutate(assay_bleach = paste(Metadata_Experiment,bleach,sep = "_")) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  cleanData(.)
data.cleaning.plot(x2.4.D.df[[2]], "Bleach Quality")
dose.check.plot(x2.4.D.df[[1]])

# drug.drm <- suppressMessages(fit_all_models(data = x2.4.D.df[[1]], 
#                                             traits = "median_wormlength_um_reg"))
# plot_EC50s_on_DRC(all.model.list = drug.drm,
#                   toxin = levels(as.factor(x2.4.D.df[[1]]$drug)), 
#                   metadata = x2.4.D.df[[1]])
# `2,4-D_DRCplot`+
#   ggplot2::labs(subtitle = "LL4 Model")
# x2.4.D.LL4.estimates <- strain.EC50s(drug.drm = drug.drm, 
#                                     drug.df = x2.4.D.df[[1]])%>%
#   dplyr::filter(model == "LL.4")

### Best model from model selection
best.drug.drm <- suppressMessages(fit_best_models(data = x2.4.D.df[[1]], 
                                            traits = "median_wormlength_um_reg"))
plot_best_DRC(all.model.list = best.drug.drm,
              toxin = levels(as.factor(x2.4.D.df[[1]]$drug)), 
              metadata = x2.4.D.df[[1]])
`2,4-D_DRCplot` +
  ggplot2::labs(subtitle = "Selected Models")
x2.4.D.selected.EC.estimates <- selected.strain.EC50s(best.drug.drm = best.drug.drm,
                          drug.df = x2.4.D.df[[1]])
EC10.plot(e = x2.4.D.selected.EC.estimates, d = x2.4.D.df)
```

## Malathion
```{r malathion, echo=FALSE, message=FALSE, warning=FALSE}
malathion <- purrr::map2(MDHD.data.list, 
                   "Malathion",
                   pull.toxin)

malathion.df <- Reduce(rbind,malathion) %>%
  dplyr::mutate(assay_bleach = paste(Metadata_Experiment,bleach,sep = "_")) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  cleanData(.)
data.cleaning.plot(malathion.df[[2]], "Bleach Quality")
dose.check.plot(malathion.df[[1]])

# drug.drm <- suppressMessages(fit_all_models(data = malathion.df[[1]], 
#                                             traits = "median_wormlength_um_reg"))
# plot_EC50s_on_DRC(all.model.list = drug.drm,
#                   toxin = levels(as.factor(malathion.df[[1]]$drug)), 
#                   metadata = malathion.df[[1]])
# Malathion_DRCplot+
#   ggplot2::labs(subtitle = "LL4 Model")
# malathion.LL4.estimates <- strain.EC50s(drug.drm = drug.drm, 
#                                     drug.df = malathion.df[[1]])%>%
#   dplyr::filter(model == "LL.4")

### Best model from model selection
best.drug.drm <- suppressMessages(fit_best_models(data = malathion.df[[1]], 
                                            traits = "median_wormlength_um_reg"))
plot_best_DRC(all.model.list = best.drug.drm,
              toxin = levels(as.factor(malathion.df[[1]]$drug)), 
              metadata = malathion.df[[1]])
Malathion_DRCplot +
  ggplot2::labs(subtitle = "Selected Models")
malathion.df.selected.EC.estimates <- selected.strain.EC50s(best.drug.drm = best.drug.drm,
                          drug.df = malathion.df[[1]])
EC10.plot(e = malathion.df.selected.EC.estimates, d = malathion.df)
```

## Chlorothalonil
```{r chlorothalonil, echo=FALSE, message=FALSE, warning=FALSE}
chlorothalonil <- purrr::map2(MDHD.data.list, 
                   "Chlorothalonil",
                   pull.toxin)

chlorothalonil.df <- Reduce(rbind,chlorothalonil) %>%
  dplyr::mutate(assay_bleach = paste(Metadata_Experiment,bleach,sep = "_")) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  cleanData(.)
data.cleaning.plot(chlorothalonil.df[[2]], "Bleach Quality")
dose.check.plot(chlorothalonil.df[[1]])

# drug.drm <- suppressMessages(fit_all_models(data = chlorothalonil.df[[1]], 
#                                             traits = "median_wormlength_um_reg"))
# plot_EC50s_on_DRC(all.model.list = drug.drm,
#                   toxin = levels(as.factor(chlorothalonil.df[[1]]$drug)), 
#                   metadata = chlorothalonil.df[[1]])
# Chlorothalonil_DRCplot+
#   ggplot2::labs(subtitle = "LL4 Model")
# chlorothalonil.LL4.estimates <- strain.EC50s(drug.drm = drug.drm, 
#                                     drug.df = chlorothalonil.df[[1]])%>%
#   dplyr::filter(model == "LL.4")


### Best model from model selection
best.drug.drm <- suppressMessages(fit_best_models(data = chlorothalonil.df[[1]], 
                                            traits = "median_wormlength_um_reg"))
plot_best_DRC(all.model.list = best.drug.drm,
              toxin = levels(as.factor(chlorothalonil.df[[1]]$drug)), 
              metadata = chlorothalonil.df[[1]])
Chlorothalonil_DRCplot +
  ggplot2::labs(subtitle = "Selected Models")
chlorothalonil.selected.EC.estimates <- selected.strain.EC50s(best.drug.drm = best.drug.drm,
                          drug.df = chlorothalonil.df[[1]])
EC10.plot(e = chlorothalonil.selected.EC.estimates, d = chlorothalonil.df)
```

## Deltamethrin
```{r deltamethrin, echo=FALSE, message=FALSE, warning=FALSE}
deltamethrin <- purrr::map2(MDHD.data.list, 
                   "Deltamethrin",
                   pull.toxin)

deltamethrin.df <- Reduce(rbind,deltamethrin) %>%
  dplyr::mutate(assay_bleach = paste(Metadata_Experiment,bleach,sep = "_")) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  cleanData(.)
data.cleaning.plot(deltamethrin.df[[2]], "Bleach Quality")
dose.check.plot(deltamethrin.df[[1]])

drug.drm <- suppressMessages(fit_all_models(data = deltamethrin.df[[1]], 
                                            traits = "median_wormlength_um_reg"))
plot_EC50s_on_DRC(all.model.list = drug.drm,
                  toxin = levels(as.factor(deltamethrin.df[[1]]$drug)), 
                  metadata = deltamethrin.df[[1]])
Deltamethrin_DRCplot+
  ggplot2::labs(subtitle = "LL4 Model")
deltamethrin.LL4.estimates <- strain.EC50s(drug.drm = drug.drm, 
                                    drug.df = deltamethrin.df[[1]])%>%
  dplyr::filter(model == "LL.4")

# ### Best model from model selection
# best.drug.drm <- suppressMessages(fit_best_models(data = deltamethrin.df[[1]], 
#                                             traits = "median_wormlength_um_reg"))
# plot_best_DRC(all.model.list = best.drug.drm,
#               toxin = levels(as.factor(deltamethrin.df[[1]]$drug)), 
#               metadata = deltamethrin.df[[1]])
# Deltamethrin_DRCplot +
#   ggplot2::labs(subtitle = "Selected Models")
# deltamethrin.selected.EC.estimates <- selected.strain.EC50s(best.drug.drm = best.drug.drm,
#                           drug.df = deltamethrin.df[[1]])
```

## Manganese dichloride
```{r manganese, echo=FALSE, message=FALSE, warning=FALSE}
manganese <- purrr::map2(MDHD.data.list, 
                   "Manganese dichloride",
                   pull.toxin)

manganese.df <- Reduce(rbind,manganese) %>%
  dplyr::mutate(assay_bleach = paste(Metadata_Experiment,bleach,sep = "_")) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  cleanData(.)
data.cleaning.plot(manganese.df[[2]], "Bleach Quality")
dose.check.plot(manganese.df[[1]])

drug.drm <- suppressMessages(fit_all_models(data = manganese.df[[1]], 
                                            traits = "median_wormlength_um_reg"))
# plot_EC50s_on_DRC(all.model.list = drug.drm,
#                   toxin = levels(as.factor(manganese.df[[1]]$drug)), 
#                   metadata = manganese.df[[1]])
# Manganese_dichloride_DRCplot+
#   ggplot2::labs(subtitle = "LL4 Model")
# manganese.LL4.estimates <- strain.EC50s(drug.drm = drug.drm, 
#                                     drug.df = manganese.df[[1]])%>%
#   dplyr::filter(model == "LL.4")


### Best model from model selection
best.drug.drm <- suppressMessages(fit_best_models(data = manganese.df[[1]], 
                                            traits = "median_wormlength_um_reg"))
plot_best_DRC(all.model.list = best.drug.drm,
              toxin = levels(as.factor(manganese.df[[1]]$drug)), 
              metadata = manganese.df[[1]])
Manganese_dichloride_DRCplot +
  ggplot2::labs(subtitle = "Selected Models")
manganese.df.selected.EC.estimates <- selected.strain.EC50s(best.drug.drm = best.drug.drm,
                          drug.df = manganese.df[[1]])
EC10.plot(e = manganese.df.selected.EC.estimates, d = manganese.df)
```

## Propoxur
```{r propoxur, echo=FALSE, message=FALSE, warning=FALSE}
propoxur <- purrr::map2(MDHD.data.list, 
                   "Propoxur",
                   pull.toxin)

propoxur.df <- Reduce(rbind,propoxur) %>%
  dplyr::mutate(assay_bleach = paste(Metadata_Experiment,bleach,sep = "_")) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  cleanData(.)
data.cleaning.plot(propoxur.df[[2]], "Bleach Quality")
dose.check.plot(propoxur.df[[1]])

# drug.drm <- suppressMessages(fit_all_models(data = propoxur.df[[1]], 
#                                             traits = "median_wormlength_um_reg"))
# plot_EC50s_on_DRC(all.model.list = drug.drm,
#                   toxin = levels(as.factor(propoxur.df[[1]]$drug)), 
#                   metadata = propoxur.df[[1]])
# Propoxur_DRCplot+
#   ggplot2::labs(subtitle = "LL4 Model")
# propoxur.LL4.estimates <- strain.EC50s(drug.drm = drug.drm, 
#                                     drug.df = propoxur.df[[1]])%>%
#   dplyr::filter(model == "LL.4")


### Best model from model selection
best.drug.drm <- suppressMessages(fit_best_models(data = propoxur.df[[1]], 
                                            traits = "median_wormlength_um_reg"))
plot_best_DRC(all.model.list = best.drug.drm,
              toxin = levels(as.factor(propoxur.df[[1]]$drug)), 
              metadata = propoxur.df[[1]])
Propoxur_DRCplot +
  ggplot2::labs(subtitle = "Selected Models")
propoxur.selected.EC.estimates <- selected.strain.EC50s(best.drug.drm = best.drug.drm,
                          drug.df = propoxur.df[[1]])
EC10.plot(e = propoxur.selected.EC.estimates, d = propoxur.df)
```

## Mancozeb
```{r mancozeb, echo=FALSE, message=FALSE, warning=FALSE}
mancozeb <- purrr::map2(MDHD.data.list, 
                   "Mancozeb",
                   pull.toxin)

mancozeb.df <- Reduce(rbind,mancozeb) %>%
  dplyr::mutate(assay_bleach = paste(Metadata_Experiment,bleach,sep = "_")) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1, drug != "Mancozeb_Dilute") %>%
  cleanData(.)
data.cleaning.plot(mancozeb.df[[2]], "Bleach Quality")
dose.check.plot(mancozeb.df[[1]])

drug.drm <- suppressMessages(fit_all_models(data = mancozeb.df[[1]], 
                                            traits = "median_wormlength_um_reg"))
# plot_EC50s_on_DRC(all.model.list = drug.drm,
#                   toxin = levels(as.factor(mancozeb.df[[1]]$drug)), 
#                   metadata = mancozeb.df[[1]])
# Mancozeb_DRCplot+
#   ggplot2::labs(subtitle = "LL4 Model")
# mancozeb.LL4.estimates <- strain.EC50s(drug.drm = drug.drm, 
#                                     drug.df = mancozeb.df[[1]])%>%
#   dplyr::filter(model == "LL.4")


### Best model from model selection
best.drug.drm <- suppressMessages(fit_best_models(data = mancozeb.df[[1]], 
                                            traits = "median_wormlength_um_reg"))
plot_best_DRC(all.model.list = best.drug.drm,
              toxin = levels(as.factor(mancozeb.df[[1]]$drug)), 
              metadata = mancozeb.df[[1]])
Mancozeb_DRCplot +
  ggplot2::labs(subtitle = "Selected Models")
mancozeb.selected.EC.estimates <- selected.strain.EC50s(best.drug.drm = best.drug.drm,
                                                        drug.df = mancozeb.df[[1]])
EC10.plot(e = mancozeb.selected.EC.estimates, d = mancozeb.df)
```




## EC Estimates
```{r DRC metrics, echo=FALSE, message=FALSE, warning=FALSE}
drug.pal <- c(brewer.pal(n = 9,name = "Set1"), brewer.pal(n = 8, "Set2"), brewer.pal(n = 8, "Set3"))
drug.classes <- read.csv("data/drugclasses.csv") %>%
  dplyr::select(c(drug, class)) %>%
  dplyr::arrange(class)

# # LL4 for all strains and compounds
# LL4.EC.est.list <- list()
# for(i in 1:length(ls(pattern = "LL4.estimate"))){
#   LL4.EC.est.list[[i]] <- get(ls(pattern = "LL4.estimate")[i])
# }
# LL4.EC.est.dat <- do.call(rbind, LL4.EC.est.list) %>%
#   dplyr::mutate(fraction = as.factor(fraction),
#                 model = as.factor(model),
#                 null.estimate = as.factor(is.na(Std..Error)),
#                 above.max.conc = as.factor(above.max.conc)) %>%
#   dplyr::rename(Strain = strain)
# 
# levels(LL4.EC.est.dat$null.estimate) <- c("Estimated ECs","NA EC Estimate")
# levels(LL4.EC.est.dat$fraction) <- c("EC10","EC50","EC90")
# levels(LL4.EC.est.dat$above.max.conc) <- c("EC Estimate Within Dose Range","EC Estimate Exceeds Maximum Dose")

# Model estimates from model selection
selected.EC.est.list <- list()
for(i in 1:length(ls(pattern = "selected.EC.estimate"))){
  selected.EC.est.list[[i]] <- get(ls(pattern = "selected.EC.estimate")[i])
}
selected.EC.est.dat <- do.call(rbind, selected.EC.est.list) %>%
  dplyr::mutate(fraction = as.factor(fraction),
                model = as.factor(best.model),
                null.estimate = as.factor(is.na(`Std. Error`)),
                above.max.conc = as.factor(above.max.conc)) %>%
  dplyr::rename(Strain = strain)

levels(selected.EC.est.dat$null.estimate) <- c("Estimated ECs","NA EC Estimate")
levels(selected.EC.est.dat$fraction) <- c("EC10","EC50","EC90")
levels(selected.EC.est.dat$above.max.conc) <- c("EC Estimate Within Dose Range","EC Estimate Exceeds Maximum Dose")

# LL4.EC.est.dat %>%
#   dplyr::group_by(null.estimate, fraction, Strain, drug) %>%
#   dplyr::summarise(n()) %>%
#   ggplot(., mapping = aes(x = drug, y = `n()`, fill = Strain)) + 
#   theme_bw() + 
#   geom_col(position = "stack") +
#   scale_fill_manual(name = "Strain", values = strain_colors) + 
#   theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) + 
#   facet_grid(fraction~null.estimate, drop = TRUE, scales = "free_x") + 
#   labs(x = "Toxicant",
#        y = "Number of Dose-Response Curve Fits")

selected.EC.est.dat %>%
  dplyr::group_by(null.estimate, fraction, Strain, drug, best.model) %>%
  dplyr::summarise(n()) %>%
  ggplot(., mapping = aes(x = drug, y = `n()`, fill = Strain)) + 
  theme_bw() + 
  geom_col(position = "stack") +
  scale_fill_manual(name = "Strain", values = strain_colors) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) + 
  facet_grid(fraction~null.estimate+best.model, drop = TRUE, scales = "free_x") + 
  labs(x = "Toxicant",
       y = "Number of Dose-Response Curve Fits")


selected.EC.est.dat %>%
  dplyr::group_by(above.max.conc, fraction, model, Strain, drug) %>%
  dplyr::filter(model == "Log-Logistic",
                fraction == "EC10") %>%
  dplyr::summarise(n()) %>%
  ggplot(., mapping = aes(x = drug, y = `n()`, fill = Strain)) + 
  theme_bw() + 
  geom_col(position = "stack") +
  scale_fill_manual(name = "Strain", values = strain_colors) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) + 
  facet_wrap(.~above.max.conc, drop = TRUE, scales = "free_x", nrow = 3) + 
  labs(x = "Toxicant",
       y = "Number of Dose-Response Curve Fits: EC10") +
  ggsave("output/EC10.survey.png", width = 10, height = 8)

```

### EC10
```{r EC10 plots, fig.height=7, fig.width=10, message=FALSE, warning=FALSE, , echo=FALSE}
selected.EC.est.dat %>%
  dplyr::filter(fraction == "EC10",
                above.max.conc == "EC Estimate Within Dose Range",
                model == "Log-Logistic",
                null.estimate != "NA EC Estimate") %>%
  dplyr::group_by(drug) %>%
  dplyr::summarise(n = n()) %>%
  dplyr::filter(n > 5) %>%
  write.csv("output/toxicants.8strains.csv")

tox.filter <- selected.EC.est.dat %>%
  dplyr::filter(fraction == "EC10",
                above.max.conc == "EC Estimate Within Dose Range",
                model == "Log-Logistic",
                null.estimate != "NA EC Estimate") %>%
  dplyr::group_by(drug) %>%
  dplyr::summarise(n = n())

drug.nested.ECs <- selected.EC.est.dat %>%
  dplyr::filter(fraction == "EC10",
                model == "Log-Logistic",
                null.estimate != "NA EC Estimate") %>%
  dplyr::group_by(drug) %>%
  tidyr::nest()


EC.plot <- function(data, drug){
  data %>%
    dplyr::filter(Estimate < 10000) %>%
    ggplot(., mapping = aes(x = Strain, y = Estimate, colour = above.max.conc)) + 
    theme_bw() +
    geom_point(size = 0.5) + 
    geom_pointrange(aes(ymin=Lower, ymax=Upper)) +
    scale_y_log10() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
          legend.text = element_text(size = 7.5),
          legend.title = element_text(size = 7.5),
          legend.position = "top",
          panel.grid = element_blank()) + 
    geom_text_repel(aes(label = round(Estimate, 2)), size = 3, box.padding = 0.5, colour = "black") +
    scale_colour_manual(name = "Above Maximum Dose?", values = c("black","red")) +
    labs(x = "Strain", y = "EC10 Estimate (µM)", title = drug) +
    ggsave(filename = paste("output/",drug,"_EC.plot.png", sep = ""), height = 6, width = 6)
}
purrr::map2(drug.nested.ECs$data, drug.nested.ECs$drug, EC.plot)

selected.EC.est.dat %>%
  dplyr::filter(fraction == "EC10",
                model == "Log-Logistic",
                null.estimate != "NA EC Estimate") %>%
  # dplyr::mutate(Lower = ifelse(Lower < 0, 0.1, Lower)) %>%
  ggplot(., mapping = aes(x = Strain, y = Estimate)) + 
  theme_bw() +
  geom_point(size = 0.5) + 
  geom_pointrange(aes(ymin=Lower, ymax=Upper)) +
  facet_wrap(drug~., scales = "free") +
  scale_y_log10() +
  theme(axis.text.x = element_text(angle = 45, hjust =1, vjust = 1),
        legend.position = "top") + 
  guides(fill = FALSE) + 
  labs(x = "Strain", 
       y = "EC10 Estimate (µM)")


EC.comps <- selected.EC.est.dat %>%
  dplyr::full_join(.,drug.classes) %>%
  dplyr::filter(fraction == "EC10",
                above.max.conc == "EC Estimate Within Dose Range",
                model == "Log-Logistic",
                null.estimate != "NA EC Estimate",
                drug %in% tox.filter$drug)

EC.nested.tx.classes <- EC.comps %>%
  dplyr::group_by(class, drug) %>%
  dplyr::summarise(drug.mean.EC10 = mean(log(Estimate))) %>%
  dplyr::full_join(EC.comps,.) %>%
  dplyr::mutate(Normalized.EC10 = log(Estimate) - drug.mean.EC10) %>%
  dplyr::ungroup() %>%
  dplyr::group_by(class) %>%
  tidyr::nest()

rel.EC10.plots <- function(data, class){
  data %>%
    dplyr::group_by(Strain) %>%
    dplyr::summarise(strain.mean.norm.EC10 = mean(Normalized.EC10)) %>%
    dplyr::full_join(data,.) %>%
    ggplot(., mapping = aes(x = Strain, y = Normalized.EC10, colour = drug)) + 
    theme_bw() + 
    geom_point(size = 1.5, alpha = 0.5) + 
    geom_point(mapping = aes(x = Strain, y = strain.mean.norm.EC10), colour = "black", shape = 23, size = 3) + 
    theme(axis.text.x = element_text(angle = 45, hjust =1, vjust = 1),
          panel.grid = element_blank()) + 
    scale_colour_brewer(name = "Toxicant", palette = "Set1") +
    labs(x = "Toxicant", 
         y = "Relative EC10 Estimate (µM)",
         title = paste(class,"s",sep = "")) +
    ggsave(paste("output/EC10.strain.comp",class,"png",sep = "."), width = 6, height = 6)
}
purrr::map2(EC.nested.tx.classes$data, EC.nested.tx.classes$class, rel.EC10.plots)
```

### EC50
```{r eval=FALSE, fig.height=7, fig.width=10, message=FALSE, warning=FALSE, , echo=FALSE, include=FALSE}
EC.est.dat %>%
  dplyr::filter(fraction == "EC50",
                above.max.conc == "EC Estimate Within Dose Range") %>%
  dplyr::filter(null.estimate != "NA EC Estimate") %>%
  dplyr::mutate(Lower = ifelse(Lower < 0, 0.1, Lower)) %>%
  ggplot(., mapping = aes(x = Strain, y = Estimate, fill = Strain, shape = model)) + 
  theme_bw() +
  geom_point(size = 2, alpha = 0.75) + 
  # geom_pointrange(aes(ymin=Lower, ymax=Upper), size = 0.75, alpha = 0.75) +
  # geom_text_repel(aes(label = round(Estimate, 2)), size = 2.5, box.padding = 0.5, colour = "black") + 
  facet_wrap(drug~., scales = "free") +
  scale_y_log10() +
  theme(axis.text.x = element_text(angle = 45, hjust =1, vjust = 1),
        legend.position = "top") + 
  guides(fill = FALSE) + 
  scale_shape_manual(name = "Dose-Response Model", values = c(21,22,23)) + 
  labs(x = "Strain", 
       y = "EC50 Estimate")
```

### EC90
```{r EC90 plots, eval=FALSE, fig.height=7, fig.width=10, message=FALSE, warning=FALSE, , echo=FALSE, include=FALSE}
EC.est.dat %>%
  dplyr::filter(fraction == "EC90",
                above.max.conc == "EC Estimate Within Dose Range",
                model == "Log-Logistic",
                null.estimate != "NA EC Estimate") %>%
  dplyr::group_by(drug) %>%
  dplyr::summarise(n = n()) %>%
  dplyr::filter(n > 5) %>%
  write.csv("output/toxicants.8strains.EC90.csv")

tox.filter <- EC.est.dat %>%
  dplyr::filter(fraction == "EC90",
                above.max.conc == "EC Estimate Within Dose Range",
                model == "Log-Logistic",
                null.estimate != "NA EC Estimate") %>%
  dplyr::group_by(drug) %>%
  dplyr::summarise(n = n())

drug.nested.ECs <- EC.est.dat %>%
  dplyr::filter(fraction == "EC90",
                model == "Log-Logistic",
                null.estimate != "NA EC Estimate") %>%
  dplyr::group_by(drug) %>%
  tidyr::nest()


EC.plot <- function(data, drug){
  data %>%
    dplyr::filter(Estimate < 10000) %>%
    ggplot(., mapping = aes(x = Strain, y = Estimate, colour = above.max.conc)) + 
    theme_bw() +
    geom_point(size = 0.5) + 
    geom_pointrange(aes(ymin=Lower, ymax=Upper)) +
    scale_y_log10() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
          legend.text = element_text(size = 7.5),
          legend.title = element_text(size = 7.5),
          legend.position = "top",
          panel.grid = element_blank()) + 
    geom_text_repel(aes(label = round(Estimate, 2)), size = 3, box.padding = 0.5, colour = "black") +
    scale_colour_manual(name = "Above Maximum Dose?", values = c("black","red")) +
    labs(x = "Strain", y = "EC90 Estimate (µM)", title = drug) +
    ggsave(filename = paste("output/",drug,"_EC90.plot.png", sep = ""), height = 6, width = 6)
}
purrr::map2(drug.nested.ECs$data, drug.nested.ECs$drug, EC.plot)

EC.est.dat %>%
  dplyr::filter(fraction == "EC90",
                model == "Log-Logistic",
                null.estimate != "NA EC Estimate") %>%
  # dplyr::mutate(Lower = ifelse(Lower < 0, 0.1, Lower)) %>%
  ggplot(., mapping = aes(x = Strain, y = Estimate)) + 
  theme_bw() +
  geom_point(size = 0.5) + 
  geom_pointrange(aes(ymin=Lower, ymax=Upper)) +
  facet_wrap(drug~., scales = "free") +
  scale_y_log10() +
  theme(axis.text.x = element_text(angle = 45, hjust =1, vjust = 1),
        legend.position = "top") + 
  guides(fill = FALSE) + 
  labs(x = "Strain", 
       y = "EC90 Estimate (µM)")


EC.comps <- EC.est.dat %>%
  dplyr::full_join(.,drug.classes) %>%
  dplyr::filter(fraction == "EC90",
                above.max.conc == "EC Estimate Within Dose Range",
                model == "Log-Logistic",
                null.estimate != "NA EC Estimate",
                drug %in% tox.filter$drug)

EC90.nested.tx.classes <- EC.comps %>%
  dplyr::group_by(class, drug) %>%
  dplyr::summarise(drug.mean.EC90 = mean(log(Estimate))) %>%
  dplyr::full_join(EC.comps,.) %>%
  dplyr::mutate(Normalized.EC90 = log(Estimate) - drug.mean.EC90) %>%
  dplyr::ungroup() %>%
  dplyr::group_by(class) %>%
  tidyr::nest()

rel.EC90.plots <- function(data, class){
  data %>%
    dplyr::group_by(Strain) %>%
    dplyr::summarise(strain.mean.norm.EC90 = mean(Normalized.EC90)) %>%
    dplyr::full_join(data,.) %>%
    ggplot(., mapping = aes(x = Strain, y = Normalized.EC90, colour = drug)) + 
    theme_bw() + 
    geom_point(size = 1.5, alpha = 0.5) + 
    geom_point(mapping = aes(x = Strain, y = strain.mean.norm.EC90), colour = "black", shape = 23, size = 3) + 
    theme(axis.text.x = element_text(angle = 45, hjust =1, vjust = 1),
          panel.grid = element_blank()) + 
    scale_colour_brewer(name = "Toxicant", palette = "Set1") +
    labs(x = "Toxicant", 
         y = "Relative EC90 Estimate (µM)",
         title = paste(class,"s",sep = "")) +
    ggsave(paste("output/EC90.strain.comp",class,"png",sep = "."), width = 6, height = 6)
}
purrr::map2(EC90.nested.tx.classes$data, EC90.nested.tx.classes$class, rel.EC90.plots)
```

### Summary Tables
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE}
options(scipen = 99999)
nested.summary.tables <- selected.EC.est.dat %>%
  dplyr::filter(above.max.conc == "EC Estimate Within Dose Range",
                null.estimate != "NA EC Estimate") %>%
  dplyr::mutate(estimate = round(Estimate, 2),
                se = round(Std..Error, 2)) %>%
  dplyr::select(drug, estimate, se, model, fraction, Strain) %>%
  tidyr::unite("EC", c(estimate, se),sep = "±") %>%
  tidyr::pivot_wider(names_from = model, values_from = EC) %>%
  dplyr::group_by(fraction, drug) %>%
  tidyr::nest()
fancy_print <- function(data,drug,fraction){
  EC <- paste("EC",stringr::str_split(fraction, pattern = ":")[[1]][3], sep = "")
  print(knitr::kable(data,
                     format = "pandoc",
                     caption = paste(fraction, "Estimates", sep = " "),
                     digits = 3))
  data %>%
    write.csv(x = ., file = paste("output/",fraction,"_",drug,".csv",sep = ""), row.names = F, quote = F)
}
purrr::pmap(.l = list(nested.summary.tables$data,
                      nested.summary.tables$fraction,
                      nested.summary.tables$drug),
            .f = fancy_print)
```

```{r eval=FALSE, include=FALSE}
drug = "triphenyl"
raw <- purrr::map2(MDHD.data.list,
                   drug,
                   pull.toxin.raw)
raw.df <- Reduce(rbind,raw) %>%
  dplyr::mutate(drug = levels(as.factor(drug))[2])

model.dists <- raw.df %>%
  dplyr::filter(cluster_flag == F) %>%
  dplyr::mutate(model = as.factor(case_when(model == "MDHD" ~ "L1 sick model",
                                  model == "L1_N2_HB101_100w" ~ "L1 model",
                                  model == "L2L3_N2_HB101_100w" ~ "L2/L3 model",
                                  model == "L4_N2_HB101_100w" ~ "L4 model")))

model.dists$model <- factor(model.dists$model, levels = c("L1 sick model","L1 model","L2/L3 model", "L4 model"))
ggplot(model.dists, mapping = aes(x = Worm_Length, fill = model)) +
  theme_bw() +
  geom_histogram(position = "stack", bins = 200) + 
  geom_vline(xintercept = 50) + 
  facet_wrap(.~concentration_um) + 
  scale_fill_brewer(palette = "RdGy", name = "Selected Worm Model") + 
  theme(legend.position = "top", legend.justification = "center") + 
  ggtitle(unique(model.dists$drug)) + 
  ggsave(paste0("output/",unique(model.dists$drug),"_MDHD.junk.png"), width = 10, height = 6)
```



## Toxicant Classes
```{r carbamate insecticides, echo=FALSE, message=FALSE, warning=FALSE}
drug.classes %>%
  dplyr::filter(class == "Carbamate Insecticide") %>%
  dplyr::select(drug)
strain.legend <- cowplot::get_legend(Aldicarb_DRCplot)
tx.plot.carb <- cowplot::plot_grid(Methomyl_DRCplot+ theme(legend.position = "none", axis.text.y = element_blank()),
                                   Aldicarb_DRCplot + theme(legend.position = "none", axis.text.y = element_blank()), 
                                   Carbaryl_DRCplot+ theme(legend.position = "none", axis.text.y = element_blank()), 
                                   Propoxur_DRCplot+theme(legend.position = "none", axis.text.y = element_blank()), nrow = 2)
carb.DRCs <- cowplot::plot_grid(tx.plot.carb, strain.legend, rel_heights = c(8,1), nrow = 2)
carb.DRCs
ggsave(carb.DRCs, filename = "output/carb.DRCs.png", height = 7.5, width = 10)
```

```{r fungicides, echo=FALSE, message=FALSE, warning=FALSE}
drug.classes %>%
  dplyr::filter(class == "Fungicide") %>%
  dplyr::select(drug)
strain.legend <- cowplot::get_legend(Carboxin_DRCplot)
tx.plot.fungi <- cowplot::plot_grid(Pyraclostrobin_DRCplot + theme(legend.position = "none", axis.text.y = element_blank()),
                                    Carboxin_DRCplot+ theme(legend.position = "none", axis.text.y = element_blank()), 
                                    Mancozeb_DRCplot + theme(legend.position = "none", axis.text.y = element_blank()), 
                                    Chlorothalonil_DRCplot + theme(legend.position = "none", axis.text.y = element_blank()),
                                    nrow = 2)
fungi.DRCs <- cowplot::plot_grid(tx.plot.fungi, strain.legend, rel_heights = c(8,1), nrow = 2)
fungi.DRCs
ggsave(fungi.DRCs, filename = "output/fungi.DRCs.png", height = 7.5, width = 10)
```

```{r pyrethroids, echo=FALSE, message=FALSE, warning=FALSE}
drug.classes %>%
  dplyr::filter(class == "Synthetic Pyrethroid Insecticide") %>%
  dplyr::select(drug)
Deltamethrin_DRCplot
```

```{r organophosphate, echo=FALSE, message=FALSE, warning=FALSE}
drug.classes %>%
  dplyr::filter(class == "Organophosphate insecticide") %>%
  dplyr::select(drug)
strain.legend <- cowplot::get_legend(Chlorpyrifos_DRCplot)
tx.plot.organophosphate <- cowplot::plot_grid(Chlorpyrifos_DRCplot + theme(legend.position = "none", axis.text.y = element_blank()),
                                    Malathion_DRCplot+ theme(legend.position = "none", axis.text.y = element_blank()),
                                    nrow = 1)
organophosphate.DRCs <- cowplot::plot_grid(tx.plot.organophosphate, strain.legend, rel_heights = c(8,1), nrow = 2)
organophosphate.DRCs
ggsave(organophosphate.DRCs, filename = "output/organophosphate.DRCs.png", height = 5, width = 10)
```

```{r metal, echo=FALSE, message=FALSE, warning=FALSE}
drug.classes %>%
  dplyr::filter(class == "Heavy Metal") %>%
  dplyr::select(drug)
strain.legend <- cowplot::get_legend(Arsenic_trioxide_DRCplot)
tx.plot.metals <- cowplot::plot_grid(Nickel_dichloride_DRCplot + theme(legend.position = "none", axis.text.y = element_blank()),
                                     `Copper(II)_chloride_DRCplot` + theme(legend.position = "none", axis.text.y = element_blank()),
                                     Zinc_dichloride_DRCplot + theme(legend.position = "none", axis.text.y = element_blank()), # transition metals
                                     Manganese_dichloride_DRCplot + theme(legend.position = "none", axis.text.y = element_blank()),
                                     Arsenic_trioxide_DRCplot + theme(legend.position = "none", axis.text.y = element_blank()),
                                     Cadmium_dichloride_DRCplot + theme(legend.position = "none", axis.text.y = element_blank()),
                                     Silver_nitrate_DRCplot + theme(legend.position = "none", axis.text.y = element_blank()),
                                     `Lead(II)_nitrate_DRCplot` + theme(legend.position = "none", axis.text.y = element_blank()),
                                     Methylmercury_dichloride_DRCplot + theme(legend.position = "none", axis.text.y = element_blank()),
                                     nrow = 3)
metal.DRCs <- cowplot::plot_grid(tx.plot.metals, strain.legend, rel_heights = c(8,1), nrow = 2)
metal.DRCs
ggsave(metal.DRCs, filename = "output/metal.DRCs.png", height = 9, width = 10)
```

```{r herb, echo=FALSE, message=FALSE, warning=FALSE}
drug.classes %>%
  dplyr::filter(class == "Herbicide") %>%
  dplyr::select(drug)
strain.legend <- cowplot::get_legend(`2,4-D_DRCplot`)
tx.plot.herb <- cowplot::plot_grid(`2,4-D_DRCplot` + theme(legend.position = "none", axis.text.y = element_blank()),
                                     Paraquat_DRCplot + theme(legend.position = "none", axis.text.y = element_blank()),
                                     Atrazine_DRCplot + theme(legend.position = "none", axis.text.y = element_blank()),
                                     nrow = 1)
herb.DRCs <- cowplot::plot_grid(tx.plot.herb, strain.legend, rel_heights = c(8,1), nrow = 2)
herb.DRCs
ggsave(herb.DRCs, filename = "output/herb.DRCs.png", height = 5, width = 10)
```

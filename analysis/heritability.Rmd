---
title: "Heritability Analyses"
site: workflowr::wflow_site
output:
  workflowr::wflow_html:
    toc: true
    toc_float: true
    toc_collapsed: true
    toc_depth: 4
editor_options:
  chunk_output_type: console
---

```{r include=FALSE}
require(tidyverse)
require(workflowr)
require(easyXpress)
require(drc)
require(knitr)
require(kableExtra)
require(ddpcr)
require(nationalparkcolors)
require(ggbeeswarm)
require(ggrepel)
require(sommer)
require(RColorBrewer)
require(beepr)
require(magrittr)
require(cowplot)
require(grid)
require(gridExtra)
setwd("~/Documents/projects/toxin_dose_responses/")
H2 <- function(d){
  strain.fit <- lme4::lmer(data = d, formula = value ~ 1 + (1|strain))
  variances <- lme4::VarCorr(x = strain.fit)
  A <- as.data.frame(variances)
  Vg <- A$vcov[1]
  Ve <- A$vcov[2]
  H2 <- Vg/(Vg+Ve)
  return(H2)
}
h2 <- function(d){
  pheno_strains <- unique(d$strain)
  A <- sommer::A.mat(t(geno_matrix[,colnames(geno_matrix) %in% pheno_strains]))
  
  df_y <- d %>%
    dplyr::arrange(strain) %>%
    dplyr::select(strain, value) %>%
    dplyr::mutate(strain = as.character(strain))
  h2_res <- sommer::mmer(value~1,
                         random=~vs(strain,Gu=A), 
                         data=df_y)
  h2 <- vpredict(h2_res, h2 ~ (V1) / ( V1+V2))[[1]][1]
  h2_SE <- vpredict(h2_res, h2 ~ (V1) / ( V1+V2))[[2]][1]
  
  h2_df <- data.frame(h2) %>%
    dplyr::mutate(h2.upper = h2 + h2_SE,
                  h2.lower = h2 - h2_SE)
  return(h2_df)
}
H2.bootstrapping.calc <- function(d, nreps = 100, boot = T){
  
  if(boot == T){
  # Broad-sense Heritability
    H2.point <- H2(d = d)
    h2.point <- h2(d = d)
    H2.boots <- list()
    for(i in 1:nreps) {
      
      nested <- d %>%
        dplyr::group_by(strain) %>%
        tidyr::nest()
      
      boot <- d[sample(seq(1:nrow(d)), replace = T),]
      
      check <- boot %>%
        dplyr::group_by(strain) %>%
        dplyr::summarise(n())
      if(1 %in% check$`n()`){
        print("Only 1 Strain Sampled in Bootstrap - Skipping")
        next
      }
      # Broad-Sense Heritability
      H2.est <- H2(d = boot)
      H2.boots[i] <- H2.est
    }
    
    H2.boots.vec <- unlist(H2.boots)
    H2.quantiles <- c(quantile(H2.boots.vec, probs = seq(0,1,0.05)))
    H2.CI <- data.frame(H2.point, 
                        as.numeric(H2.quantiles[2]), 
                        as.numeric(H2.quantiles[21])) %>%
      `colnames<-`(c("H2.Point.Estimate","H2.5.perc","H2.95.perc"))
    
  
  
    return(list(H2.CI,H2.boots.vec,h2.point))
    
  } else {
    
    H2.point <- H2(d = d)
    h2.point <- h2(d = d)
    H2.CI <- data.frame(H2.point, 
                        NA, 
                        NA) %>%
      `colnames<-`(c("H2.Point.Estimate","H2.5.perc","H2.95.perc"))
    return(H2.CI, h2.point)
  }
  
}
H2.bootstrapping.perm <- function(d, nreps = 500, perm = T){
  
  if(perm == T){
    H2.point <- H2(d = d)
    H2.perms <- list()
    for(i in 1:nreps){
      
      nested <- d %>%
        dplyr::group_by(strain) %>%
        tidyr::nest()
      
      # Permutation
      strains <- sample(nested$strain, replace=F)
      phenos <- sample(nested$data, replace=F)
      form.permutation <- function(strain,pheno.reps){
        pheno.reps %>%
          dplyr::mutate(strain = strain) %>%
          dplyr::select(strain, replicate, value)
      }
      perm <- purrr::map2(strains, phenos, form.permutation) %>%
        do.call(rbind,.)
      H2.est <- H2(d = perm)
      H2.perms[i] <- H2.est
      }
    H2.perms.vec <- unlist(H2.perms)
    H2.quantiles <- c(quantile(H2.perms.vec, probs = seq(0,1,0.05)))
    H2.CI <- data.frame(H2.point, 
                        as.numeric(H2.quantiles[2]), 
                        as.numeric(H2.quantiles[21])) %>%
      `colnames<-`(c("H2.Point.Estimate","H2.5.perc","H2.95.perc"))
    return(H2.CI)
    } else {
    
    H2.point <- H2(d = d)
    H2.CI <- data.frame(H2.point, 
                        NA, 
                        NA) %>%
      `colnames<-`(c("H2.Point.Estimate","H2.5.perc","H2.95.perc"))
    return(H2.CI)
  }
  
}
H2.plot <- function(H2.out){
  H2.ests <- list()
  for(i in 1:length(H2.out)){H2.ests[i] <- H2.out[[i]][2]}
  H2.points <- list()
  for(i in 1:length(H2.out)){H2.points[i] <- H2.out[[i]][1]}
  h2.points <- list()
  for(i in 1:length(H2.out)){h2.points[i] <- H2.out[[i]][3]}

  H2.df <- do.call(rbind, H2.ests) %>%
    dplyr::filter(H2.rep != "NA") %>%
    dplyr::mutate(H2.rep = as.numeric(H2.rep))
  H2.point.df <- do.call(rbind, H2.points) %>%
    dplyr::filter(H2 != "NA") %>%
    dplyr::mutate(H2 = as.numeric(H2))
  h2.point.df <- do.call(rbind, h2.points) %>%
    dplyr::filter(h2 != "NA") %>%
    dplyr::mutate(h2 = as.numeric(h2))
  options(scipen = 9999999)
  
  H2.df$concentration_um <- as.numeric(as.character(H2.df$concentration_um))
  H2.point.df$concentration_um <- as.numeric(as.character(H2.point.df$concentration_um))
  h2.point.df$concentration_um <- as.numeric(as.character(h2.point.df$concentration_um))
  
  BS <- ggplot() + 
    theme_bw() + 
    geom_violin(data = H2.df, mapping = aes(x = as.factor(concentration_um), y = H2.rep), draw_quantiles = seq(0,1,0.25), scale = "width") + 
    geom_quasirandom(data = H2.df, mapping = aes(x = as.factor(concentration_um), y = H2.rep), alpha = 0.2) + 
    geom_point(data = H2.point.df, mapping = aes(x = as.factor(concentration_um), y = H2), shape = 21, size = 3, fill = "darkred") +
    geom_label(data = H2.point.df, aes(x = as.factor(concentration_um), y = H2, label = round(H2,2)), 
               nudge_x = 0.0, nudge_y = 0.05, fill = "black", colour = "white") + 
    ylim(c(0,1)) +
    geom_hline(yintercept = 0.3, linetype = 3) + 
    labs(title = unique(H2.df$drug), 
       x = "Concentration (µM)",
       y = bquote(H^2))
  
  NS <- ggplot() + 
    theme_bw() + 
    geom_pointrange(data = h2.point.df, mapping = aes(x = as.factor(concentration_um), y = h2, ymax = as.numeric(upper), ymin = as.numeric(lower))) + 
    geom_label(data = h2.point.df, aes(x = as.factor(concentration_um), y = h2, label = round(h2,2)), 
               nudge_x = 0.0, nudge_y = 0.05, fill = "black", colour = "white") + 
    ylim(c(0,1)) +
    geom_hline(yintercept = 0.3, linetype = 3) + 
    labs(title = unique(H2.df$drug), 
       x = "Concentration (µM)",
       y = bquote(h^2))
  
  h_h <- H2.df %>%
    dplyr::group_by(concentration_um) %>%
    dplyr::summarise(mean.H2 = mean(H2.rep),
                     sd.H2 = sd(H2.rep)) %>%
    dplyr::full_join(h2.point.df) %>%
    dplyr::mutate(upper.H2 = mean.H2 + sd.H2,
                  lower.H2 = mean.H2 - sd.H2,
                  upper = as.numeric(upper),
                  lower = as.numeric(lower)) %>%
    dplyr::mutate(upper.H2 = if_else(upper.H2 > 1, true = 1, false = upper.H2),
                  lower.H2 = if_else(lower.H2 < 0, true = 0, false = lower.H2),
                  upper = if_else(upper > 1, true = 1, false = upper),
                  lower = if_else(lower < 0, true = 0, false = lower))
  
  h_h_plot <- ggplot(data = h_h, mapping = aes(x = mean.H2, y = h2, fill = log(concentration_um))) + 
    theme_bw() + 
    geom_errorbar(aes(ymin = upper, ymax = lower)) + 
    geom_errorbarh(aes(xmin = lower.H2,xmax = upper.H2)) + 
    geom_point(size = 3, shape = 21) +
    ylim(c(0,1)) + 
    xlim(c(0,1)) + 
    geom_abline(slope = 1, linetype = 3, colour = "grey50") + 
    scale_fill_distiller(palette = "PuOr", name = "Concentration (log(µM))") +
    labs(title = unique(h_h$drug), 
         x = bquote(H^2),
         y = bquote(h^2)) + 
    theme(axis.title.y = element_text(angle = 0, vjust = 0.5))
  
  print(BS)
  print(NS)
  print(h_h_plot)
    
}
DR.herit.summary <- function(H2.out, x, doses){

  H2.ests <- list()
  for(i in 1:length(H2.out)){H2.ests[i] <- H2.out[[i]][2]}
  H2.points <- list()
  for(i in 1:length(H2.out)){H2.points[i] <- H2.out[[i]][1]}
  h2.points <- list()
  for(i in 1:length(H2.out)){h2.points[i] <- H2.out[[i]][3]}

  H2.df <- do.call(rbind, H2.ests) %>%
    dplyr::filter(H2.rep != "NA") %>%
    dplyr::mutate(H2.rep = as.numeric(H2.rep))
  H2.point.df <- do.call(rbind, H2.points) %>%
    dplyr::filter(H2 != "NA") %>%
    dplyr::mutate(H2 = as.numeric(H2))
  h2.point.df <- do.call(rbind, h2.points) %>%
    dplyr::filter(h2 != "NA") %>%
    dplyr::mutate(h2 = as.numeric(h2))
  options(scipen = 9999999)
  
  H2.df$concentration_um <- as.numeric(as.character(H2.df$concentration_um))
  H2.point.df$concentration_um <- as.numeric(as.character(H2.point.df$concentration_um))
  h2.point.df$concentration_um <- as.numeric(as.character(h2.point.df$concentration_um))
  
  GWA.dose.herits <- H2.point.df[which(H2.point.df$concentration_um %in% round(doses,1)),]
  
  norm <- x %>%
    dplyr::group_by(strain,) %>%
    dplyr::filter(concentration_um == 0) %>%
    dplyr::summarize(mean_ctrl = mean(mean_wormlength_um_reg)) %>%
    dplyr::ungroup() %>%
    dplyr::select(strain, mean_ctrl) %>% ##added trait
    dplyr::full_join(x , by = c("strain")) %>% ## "trait" instead of "condition"
    dplyr::distinct() %>%
    dplyr::mutate(norm_pheno = mean_wormlength_um_reg - mean_ctrl) 
  dose_avg <- norm %>%
    dplyr::group_by(strain, concentration_um) %>%
    dplyr::summarise(avg = mean(norm_pheno), st_dev = sd(norm_pheno))
  dose.range <- unique(dose_avg$concentration_um)[length(unique(dose_avg$concentration_um))] - unique(dose_avg$concentration_um)[2]

  population.10perceffect <- x %>%
    dplyr::filter(concentration_um == levels(as.factor(x$concentration_um))[length(levels(as.factor(x$concentration_um)))]) %>%
    dplyr::select(strain, concentration_um, mean_wormlength_um_reg) %>%
    dplyr::group_by(concentration_um) %>%
    dplyr::summarise(avg.effects = mean(mean_wormlength_um_reg)) %>%
    dplyr::select(avg.effects) %>% as.numeric() * 0.5

  population.response <- x %>%
    dplyr::select(drug, strain, concentration_um, mean_wormlength_um_reg) %>%
    # dplyr::filter(!is.na(median_wormlength_um_reg)) %>%
    dplyr::mutate(affected = if_else(mean_wormlength_um_reg < population.10perceffect, 
                                     true = "affected", 
                                     false = "unaffected")) %>%
    dplyr::group_by(drug, concentration_um, affected) %>%
    dplyr::summarise(n = n()) %>%
    tidyr::pivot_wider(names_from = affected, values_from = n)
  population.response[is.na(population.response)] <- 0
  population.response %<>%
    dplyr::mutate(fraction.affected = 1 - (affected/(affected+unaffected)))


  frac.affected <- population.response %>%
    dplyr::left_join(.,GWA.dose.herits) %>%
    dplyr::select(-c(upper, lower)) %>%
    dplyr::mutate(H2 = if_else(is.na(H2),
                               true = "",
                               false = as.character(round(H2,2)))) %>%
    ggplot(.) +
    theme_bw() + 
    geom_line(aes(x=log(concentration_um), 
                  y=fraction.affected*100)) + 
    theme(panel.grid = element_blank()) +
    geom_vline(xintercept = log(GWA.dose.herits$concentration_um), linetype = 2) + 
    geom_label_repel(aes(x=log(concentration_um),
                        y=fraction.affected*100,
                        label = H2)) + 
    ggtitle(paste0(round(GWA.dose.herits$concentration_um,2),"μM")) + 
    ylim(c(0,100)) + 
    labs(x=expression(italic("log")("Concentration (μM)")),
       y = "Population Unaffected (%)")
  
  strains <- ggplot() +
    theme_bw() + 
    geom_errorbar(data = dose_avg, 
                  aes(x=log(concentration_um), 
                      ymin=avg-st_dev, 
                      ymax = avg+st_dev,
                      colour = strain), 
                  width = 1/(dose.range/10))  +
    geom_line(data = dose_avg,
              aes(x=log(concentration_um), 
                  y=avg, 
                  group = strain, 
                  colour = strain), size = 0.5) +
    scale_colour_manual(values = strain_colors, name = "Strain") +
    geom_vline(xintercept = log(GWA.dose.herits$concentration_um), linetype = 2) +
    scale_y_continuous("Normalized response") + 
    theme(panel.grid = element_blank(),
          legend.position = "left") + 
    labs(x=expression(italic("log")("Concentration (μM)"))) + 
    ggtitle(unique(x$drug))
  ggsave(cowplot::plot_grid(strains, frac.affected, rel_widths = c(3:2)), 
         filename =paste0("output/",
                          gsub(unique(x$drug),pattern = " ", replacement = "_"),
                         "_GWA.DR.summary.png"), 
         height = 5, width = 9)
}
remove_outliers <- function(x, na.rm = TRUE, ...) {
    qnt <- stats::quantile(x, probs = c(0.25, 0.75), na.rm = na.rm, 
      ...)
    H <- 1.5 * stats::IQR(x, na.rm = na.rm)
    y <- x
    y[x < (qnt[1] - H)] <- NA
    y[x > (qnt[2] + H)] <- NA
    y
}
clean.data <- function(raw.data){
  
  if(length(levels(as.factor(raw.data$Metadata_Experiment))) > 1){
    
    # Remove Low n and Censored Wells
    n.drug.df <- raw.data %>%
      dplyr::filter(n < 30,
                    n > 5,
                    is.na(well_censor))
    
    # Regression
    median.reg <- lm(data = n.drug.df, formula = median_wormlength_um ~ Metadata_Experiment + bleach)
    mean.reg <- lm(data = n.drug.df, formula = mean_wormlength_um ~ Metadata_Experiment + bleach)
    n.drug.df <- cbind(n.drug.df, median.reg$residuals, mean.reg$residuals)
    colnames(n.drug.df) <- c(colnames(n.drug.df)[-c(length(colnames(n.drug.df))-1, length(colnames(n.drug.df)))],
                           "median_wormlength_um_reg","mean_wormlength_um_reg")
    # Outlier Removal
    outlier.removed.drug.df <- n.drug.df %>%
      dplyr::group_by(concentration_um, strain) %>%
      # dplyr::group_by(concentration_um) %>%
      dplyr::mutate(median_wormlength_um_reg = remove_outliers(median_wormlength_um_reg)) %>%
      dplyr::filter(!is.na(median_wormlength_um_reg))
    
    # Control Delta
    if(!0 %in% outlier.removed.drug.df$concentration_um){
      full_df_proc <-  outlier.removed.drug.df
    } else {
      control_values <- outlier.removed.drug.df %>%
        dplyr::filter(concentration_um == 0) %>% # filter to control wells
        dplyr::group_by(strain, bleach, Metadata_Experiment) %>%
        dplyr::mutate(control_pheno = mean(median_wormlength_um_reg)) %>% # get mean control value for each trait and strain
        dplyr::distinct(control_pheno, bleach, strain, Metadata_Experiment) # make it neat
    
      full_df_proc <-  outlier.removed.drug.df %>%
        dplyr::ungroup() %>%
        dplyr::left_join(., control_values) %>% # join control values for each trait
        dplyr::mutate(median_wormlength_um_reg = median_wormlength_um_reg - control_pheno)
    }
    
    n.raw <- raw.data %>%
      dplyr::group_by(Metadata_Experiment, bleach, drug, strain) %>%
      dplyr::summarise(raw = n())
    
    n.cleaned <- n.drug.df %>%
      dplyr::group_by(Metadata_Experiment, bleach, drug, strain) %>%
      dplyr::summarise(cleaned = n())
    
    n.outlier.removed <- outlier.removed.drug.df %>%
      dplyr::group_by(Metadata_Experiment, bleach, drug, strain) %>%
      dplyr::summarise(outlier.removed = n())
    
    filtering.summary <- n.raw %>%
      dplyr::full_join(., n.cleaned) %>%
      dplyr::full_join(., n.outlier.removed)
    filtering.summary[is.na(filtering.summary)] <- 0
    
    drug.filtering.summary <- filtering.summary %>%
      dplyr::mutate(pct.retained = (outlier.removed/raw)*100,
                    pct.outlier = ((cleaned-outlier.removed)/raw)*100,
                    pct.cleaned = ((raw-cleaned)/raw)*100,
                    check = pct.retained + pct.outlier + pct.cleaned) %>%
      tidyr::pivot_longer(cols = -c(Metadata_Experiment, bleach, drug, strain), names_to = "stat")
    
  } else {
    
    # Remove Low n and Censored Wells
    n.drug.df <- raw.data %>%
      dplyr::filter(n < 30,
                    n > 5,
                    is.na(well_censor))
    

    # Regression
    median.reg <- lm(data = n.drug.df, formula = median_wormlength_um ~ bleach)
    mean.reg <- lm(data = n.drug.df, formula = mean_wormlength_um ~ bleach)
    n.drug.df <- cbind(n.drug.df, median.reg$residuals, mean.reg$residuals)
    colnames(n.drug.df) <- c(colnames(n.drug.df)[-c(length(colnames(n.drug.df))-1, length(colnames(n.drug.df)))],
                           "median_wormlength_um_reg","mean_wormlength_um_reg")
    # Outlier Removal
    outlier.removed.drug.df <- n.drug.df %>%
      dplyr::group_by(concentration_um, strain) %>%
      # dplyr::group_by(concentration_um) %>%
      dplyr::mutate(median_wormlength_um_reg = remove_outliers(median_wormlength_um_reg)) %>%
      dplyr::filter(!is.na(median_wormlength_um_reg))
    
    # Control Delta
    if(!0 %in% outlier.removed.drug.df$concentration_um){
      full_df_proc <-  outlier.removed.drug.df
    } else {
      control_values <- outlier.removed.drug.df %>%
        dplyr::filter(concentration_um == 0) %>% # filter to control wells
        dplyr::group_by(strain, bleach, Metadata_Experiment) %>%
        dplyr::mutate(control_pheno = mean(median_wormlength_um_reg)) %>% # get mean control value for each trait and strain
        dplyr::distinct(control_pheno, bleach, strain, Metadata_Experiment) # make it neat
    
      full_df_proc <-  outlier.removed.drug.df %>%
        dplyr::ungroup() %>%
        dplyr::left_join(., control_values) %>% # join control values for each trait
        dplyr::mutate(median_wormlength_um_reg = median_wormlength_um_reg - control_pheno)
    }
    
    n.raw <- raw.data %>%
      dplyr::group_by(Metadata_Experiment, bleach, drug, strain) %>%
      dplyr::summarise(raw = n())
    
    n.cleaned <- n.drug.df %>%
      dplyr::group_by(Metadata_Experiment, bleach, drug, strain) %>%
      dplyr::summarise(cleaned = n())
    
    n.outlier.removed <- outlier.removed.drug.df %>%
      dplyr::group_by(Metadata_Experiment, bleach, drug, strain) %>%
      dplyr::summarise(outlier.removed = n())
    
    filtering.summary <- n.raw %>%
      dplyr::full_join(., n.cleaned) %>%
      dplyr::full_join(., n.outlier.removed)
    filtering.summary[is.na(filtering.summary)] <- 0
    
    drug.filtering.summary <- filtering.summary %>%
      dplyr::mutate(pct.retained = (outlier.removed/raw)*100,
                    pct.outlier = ((cleaned-outlier.removed)/raw)*100,
                    pct.cleaned = ((raw-cleaned)/raw)*100,
                    check = pct.retained + pct.outlier + pct.cleaned) %>%
      tidyr::pivot_longer(cols = -c(Metadata_Experiment, bleach, drug, strain), names_to = "stat")
  }
  return(list(full_df_proc,drug.filtering.summary))
}
cleanData <- function(raw.data){
  
  if(length(levels(as.factor(raw.data$Metadata_Experiment))) > 1){
    
    # Remove Low n and Censored Wells
    n.drug.df <- raw.data %>%
      dplyr::filter(n < 30,
                    n > 5,
                    is.na(well_censor))
    
    # Outlier Removal
    outlier.removed.drug.df <- n.drug.df %>%
      dplyr::group_by(concentration_um, strain) %>%
      # dplyr::group_by(concentration_um) %>%
      dplyr::mutate(median_wormlength_um = remove_outliers(median_wormlength_um)) %>%
      dplyr::filter(!is.na(median_wormlength_um))
    
    # Regression
    median.reg <- lm(data = outlier.removed.drug.df, formula = median_wormlength_um ~ Metadata_Experiment + bleach)
    mean.reg <- lm(data = outlier.removed.drug.df, formula = mean_wormlength_um ~ Metadata_Experiment + bleach)
    outlier.removed.drug.df <- cbind(outlier.removed.drug.df, median.reg$residuals, mean.reg$residuals)
    colnames(outlier.removed.drug.df) <- c(colnames(outlier.removed.drug.df)[-c(length(colnames(outlier.removed.drug.df))-1, length(colnames(n.drug.df)))],
                           "median_wormlength_um_reg","mean_wormlength_um_reg")
    
    
    # Control Delta
    if(!0 %in% outlier.removed.drug.df$concentration_um){
      full_df_proc <-  outlier.removed.drug.df
    } else {
      control_values <- outlier.removed.drug.df %>%
        dplyr::filter(concentration_um == 0) %>% # filter to control wells
        dplyr::group_by(strain, bleach, Metadata_Experiment) %>%
        dplyr::mutate(control_pheno = mean(median_wormlength_um_reg)) %>% # get mean control value for each trait and strain
        dplyr::distinct(control_pheno, bleach, strain, Metadata_Experiment) # make it neat
    
      full_df_proc <-  outlier.removed.drug.df %>%
        dplyr::ungroup() %>%
        dplyr::left_join(., control_values) %>% # join control values for each trait
        dplyr::mutate(median_wormlength_um_reg = median_wormlength_um_reg - control_pheno)
    }
    
    n.raw <- raw.data %>%
      dplyr::group_by(Metadata_Experiment, bleach, drug, strain) %>%
      dplyr::summarise(raw = n())
    
    n.cleaned <- n.drug.df %>%
      dplyr::group_by(Metadata_Experiment, bleach, drug, strain) %>%
      dplyr::summarise(cleaned = n())
    
    n.outlier.removed <- outlier.removed.drug.df %>%
      dplyr::group_by(Metadata_Experiment, bleach, drug, strain) %>%
      dplyr::summarise(outlier.removed = n())
    
    filtering.summary <- n.raw %>%
      dplyr::full_join(., n.cleaned) %>%
      dplyr::full_join(., n.outlier.removed)
    filtering.summary[is.na(filtering.summary)] <- 0
    
    drug.filtering.summary <- filtering.summary %>%
      dplyr::mutate(pct.retained = (outlier.removed/raw)*100,
                    pct.outlier = ((cleaned-outlier.removed)/raw)*100,
                    pct.cleaned = ((raw-cleaned)/raw)*100,
                    check = pct.retained + pct.outlier + pct.cleaned) %>%
      tidyr::pivot_longer(cols = -c(Metadata_Experiment, bleach, drug, strain), names_to = "stat")
    
  } else {
    
    # Remove Low n and Censored Wells
    n.drug.df <- raw.data %>%
      dplyr::filter(n < 30,
                    n > 5,
                    is.na(well_censor))
    

    # Outlier Removal
    outlier.removed.drug.df <- n.drug.df %>%
      dplyr::group_by(concentration_um, strain) %>%
      # dplyr::group_by(concentration_um) %>%
      dplyr::mutate(median_wormlength_um = remove_outliers(median_wormlength_um)) %>%
      dplyr::filter(!is.na(median_wormlength_um))
    
    # Regression
    median.reg <- lm(data = outlier.removed.drug.df, formula = median_wormlength_um ~ bleach)
    mean.reg <- lm(data = outlier.removed.drug.df, formula = mean_wormlength_um ~ bleach)
    outlier.removed.drug.df <- cbind(outlier.removed.drug.df, median.reg$residuals, mean.reg$residuals)
    colnames(outlier.removed.drug.df) <- c(colnames(outlier.removed.drug.df)[-c(length(colnames(outlier.removed.drug.df))-1, length(colnames(n.drug.df)))],
                           "median_wormlength_um_reg","mean_wormlength_um_reg")
    
    # Control Delta
    if(!0 %in% outlier.removed.drug.df$concentration_um){
      full_df_proc <-  outlier.removed.drug.df
    } else {
      control_values <- outlier.removed.drug.df %>%
        dplyr::filter(concentration_um == 0) %>% # filter to control wells
        dplyr::group_by(strain, bleach, Metadata_Experiment) %>%
        dplyr::mutate(control_pheno = mean(median_wormlength_um_reg)) %>% # get mean control value for each trait and strain
        dplyr::distinct(control_pheno, bleach, strain, Metadata_Experiment) # make it neat
    
      full_df_proc <-  outlier.removed.drug.df %>%
        dplyr::ungroup() %>%
        dplyr::left_join(., control_values) %>% # join control values for each trait
        dplyr::mutate(median_wormlength_um_reg = median_wormlength_um_reg - control_pheno)
    }
    
    n.raw <- raw.data %>%
      dplyr::group_by(Metadata_Experiment, bleach, drug, strain) %>%
      dplyr::summarise(raw = n())
    
    n.cleaned <- n.drug.df %>%
      dplyr::group_by(Metadata_Experiment, bleach, drug, strain) %>%
      dplyr::summarise(cleaned = n())
    
    n.outlier.removed <- outlier.removed.drug.df %>%
      dplyr::group_by(Metadata_Experiment, bleach, drug, strain) %>%
      dplyr::summarise(outlier.removed = n())
    
    filtering.summary <- n.raw %>%
      dplyr::full_join(., n.cleaned) %>%
      dplyr::full_join(., n.outlier.removed)
    filtering.summary[is.na(filtering.summary)] <- 0
    
    drug.filtering.summary <- filtering.summary %>%
      dplyr::mutate(pct.retained = (outlier.removed/raw)*100,
                    pct.outlier = ((cleaned-outlier.removed)/raw)*100,
                    pct.cleaned = ((raw-cleaned)/raw)*100,
                    check = pct.retained + pct.outlier + pct.cleaned) %>%
      tidyr::pivot_longer(cols = -c(Metadata_Experiment, bleach, drug, strain), names_to = "stat")
  }
  return(list(full_df_proc,drug.filtering.summary))
}
make.reps <- function(x){
  x$replicate <- seq(1,nrow(x))
  x %>%
    dplyr::rename(value = median_wormlength_um_reg)
}
drugHeritability <- function(rep.data, concentration_um){
  
  # Broad-sense Heritability
  no.reps <- rep.data %>%
    dplyr::group_by(strain) %>%
    dplyr::summarise(n = n())
  
  if(1 %in% no.reps$n){
    H2.est <- data.frame("NA", "NA", "NA") %>%
      dplyr::mutate(drug = unique(rep.data$drug),
                    concentration = concentration_um) %>%
      `colnames<-`(c("H2", "lower", "upper", "drug", "concentration_um"))
    
    h2.est <- data.frame("NA", "NA", "NA") %>%
      dplyr::mutate(drug = unique(rep.data$drug),
                  concentration = concentration_um) %>%
      `colnames<-`(c("h2", "upper", "lower", "drug", "concentration_um"))
    
    H2.est
    
  } else {
    
    herits <- suppressMessages(H2.bootstrapping.calc(d = rep.data, nreps = 200, boot = T))
    
    H2.est <- as.data.frame(herits[[1]]) %>%
      dplyr::mutate(drug = unique(rep.data$drug),
                  concentration = concentration_um) %>%
      `colnames<-`(c("H2", "lower", "upper", "drug", "concentration_um"))
    
    H2.replicates <- as.data.frame(herits[[2]]) %>%
      dplyr::mutate(drug = unique(rep.data$drug),
                  concentration = concentration_um) %>%
      `colnames<-`(c("H2.rep", "drug", "concentration_um"))
    
    h2.est <- as.data.frame(herits[[3]]) %>%
      dplyr::mutate(drug = unique(rep.data$drug),
                  concentration = concentration_um) %>%
      `colnames<-`(c("h2", "upper", "lower", "drug", "concentration_um"))
    
    list(H2.est,H2.replicates,h2.est)
  }
}
today <- format(Sys.time(), '%Y%m%d')
geno_matrix <- data.table::fread("data/toxin_8strain_genotype_matrix.tsv") %>%
  as.data.frame() %>%
  dplyr::rename(ECA248 = CB4855, PD1074 = N2)
strain_colors       <- c("blue",   "orange","#5A0C13","#C51B29",  "#a37000","#627264","#67697C","purple")
names(strain_colors) <- c("CB4856","PD1074", "ECA36",  "ECA396","ECA248", "RC301",   "MY16", "XZ1516")
se.DR <- function(x){
  norm <- x %>%
    dplyr::group_by(strain,) %>%
    dplyr::filter(concentration_um == 0) %>%
    dplyr::summarize(mean_ctrl = mean(mean_wormlength_um_reg)) %>%
    dplyr::ungroup() %>%
    dplyr::select(strain, mean_ctrl) %>% ##added trait
    dplyr::full_join(x , by = c("strain")) %>% ## "trait" instead of "condition"
    dplyr::distinct() %>%
    dplyr::mutate(norm_pheno = mean_wormlength_um_reg - mean_ctrl) 

dose_avg <- norm %>%
  dplyr::group_by(strain, concentration_um) %>%
  dplyr::summarise(avg = mean(norm_pheno), st_dev = sd(norm_pheno))

dose.range <- unique(dose_avg$concentration_um)[length(unique(dose_avg$concentration_um))] - unique(dose_avg$concentration_um)[2]


population.10perceffect <- x %>%
  dplyr::filter(concentration_um == levels(as.factor(x$concentration_um))[length(levels(as.factor(x$concentration_um)))]) %>%
  dplyr::select(strain, concentration_um, median_wormlength_um_reg) %>%
  dplyr::group_by(concentration_um) %>%
  dplyr::summarise(avg.effects = mean(median_wormlength_um_reg)) %>%
  dplyr::select(avg.effects) %>% as.numeric() * 0.5

population.response <- x %>%
  dplyr::select(drug, strain, concentration_um, median_wormlength_um_reg) %>%
  dplyr::mutate(affected = if_else(median_wormlength_um_reg < population.10perceffect, true = "affected", false = "unaffected")) %>%
  dplyr::group_by(drug, concentration_um, affected) %>%
  dplyr::summarise(n = n()) %>%
  tidyr::pivot_wider(names_from = affected, values_from = n)
population.response[is.na(population.response)] <- 0
population.response %<>%
  dplyr::mutate(fraction.affected = affected/(affected+unaffected))


frac.affected <- population.response %>%
  ggplot(.) +
  theme_bw() + 
  geom_line(aes(x=log(concentration_um), 
                y=fraction.affected*100)) + 
  theme(panel.grid = element_blank()) +
  ggtitle("") + 
  ylim(c(0,100)) + 
  labs(x=expression(italic("log")("Concentration (μM)")),
       y = "Population affected (%)")


strains <- ggplot() +
  theme_bw() + 
  geom_errorbar(data = dose_avg, 
                aes(x=log(concentration_um), 
                    ymin=avg-st_dev, 
                    ymax = avg+st_dev,
                    colour = strain), width = 1/(dose.range/10))  +
  geom_line(data = dose_avg,
            aes(x=log(concentration_um), 
                y=avg, 
                group = strain, 
                colour = strain), size = 0.5) +
  scale_colour_manual(values = strain_colors, name = "Strain") +
  scale_y_continuous("Normalized response") + 
  theme(panel.grid = element_blank(),
        legend.position = "left") + 
  labs(x=expression(italic("log")("Concentration (μM)"))) + 
  ggtitle(unique(x$drug))

cowplot::plot_grid(strains, frac.affected, rel_widths = c(3:2))
}
```

```{r Three-Model CP Data, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
##############
## TOXIN 09 ##
##############
processed.toxin09A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20200711_toxin09A",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20200711_toxin09A_data_1603396935.RData") %>% 
  dplyr::filter(model != "MDHD") %>%
  droplevels() %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>% 
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

##############
## TOXIN 10 ##
##############
processed.toxin10A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20200802_toxin10A", 
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20200802_toxin10A_data_1603469205.RData") %>% 
  dplyr::filter(model != "MDHD") %>%
  droplevels() %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>% 
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

##############
## TOXIN 11 ##
##############
processed.toxin11A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20200924_toxin11A",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20200924_toxin11A_data_1602696342SJW.RData") %>% 
  dplyr::filter(model != "MDHD") %>%
  droplevels() %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>% 
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

##############
## TOXIN 12 ##
##############
processed.toxin12A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20201105_toxin12A",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20201105_toxin12A_data_1605131334SJW.RData") %>%
  dplyr::filter(model != "MDHD") %>%
  droplevels() %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>%
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

##############
## TOXIN 14 ##
##############
processed.toxin14A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20201210_toxin14A",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20201210_toxin14A_data_1609973542SJW.RData") %>% 
  dplyr::filter(model != "MDHD") %>%
  droplevels() %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>% 
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

processed.toxin14B <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20201211_toxin14B",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20201211_toxin14B_data_1609875275SJW.RData") %>% 
  dplyr::filter(model != "MDHD") %>%
  droplevels() %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>% 
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)


##############
## TOXIN 15 ##
##############
processed.toxin15A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20201217_toxin15A",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20201217_toxin15A_data_1609886407SJW.RData") %>% 
  dplyr::filter(model != "MDHD") %>%
  droplevels() %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>% 
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

processed.toxin15B <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20201218_toxin15B",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20201218_toxin15B_data_1609979126SJW.RData") %>% 
  dplyr::filter(model != "MDHD") %>%
  droplevels() %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>% 
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

##############
## TOXIN 16 ##
##############
processed.toxin16A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20210129_toxin16A",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20210129_toxin16A_data_1612115412SJW.RData") %>% 
  dplyr::filter(model != "MDHD") %>%
  droplevels() %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>% 
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

##############
## TOXIN 17 ##
##############
processed.toxin17A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20210204_toxin17A",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20210204_toxin17A_data_1612562886SJW.RData") %>% 
  dplyr::filter(model != "MDHD") %>%
  droplevels() %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>% 
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

##############
## TOXIN 18 ##
##############
processed.toxin18A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20210211_toxin18A",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20210211_toxin18A_data_1613317121SJW.RData") %>% 
  dplyr::filter(model != "MDHD") %>%
  droplevels() %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>% 
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

##############
## TOXIN 19 ##
##############
processed.toxin19A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20210218_toxin19A",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20210218_toxin19A_data_1614224793SJW.RData") %>% 
  dplyr::filter(model != "MDHD") %>%
  droplevels() %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>% 
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

##############
## TOXIN 22 ##
##############
processed.toxin22A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20210311_toxin22A/",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20210311_toxin22A_data_1615574989SJW.RData") %>% 
  dplyr::filter(model != "MDHD") %>%
  droplevels() %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>% 
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

##############
## TOXIN 23 ##
##############
processed.toxin23A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20210318_toxin23A/",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20210318_toxin23A_data_1616184391SJW.RData") %>% 
  dplyr::filter(model != "MDHD") %>%
  droplevels() %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>% 
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)
```

```{r MDHD CP Data, message=FALSE, warning=FALSE, include=FALSE}

##############
## TOXIN 09 ##
##############
MDHD.toxin09A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20200711_toxin09A",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20200711_toxin09A_data_1603396935.RData") %>%
  dplyr::filter(Worm_Length > 50) %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>%
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

##############
## TOXIN 10 ##
##############
MDHD.toxin10A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20200802_toxin10A",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20200802_toxin10A_data_1603469205.RData") %>%
  dplyr::filter(Worm_Length > 50) %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>%
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

##############
## TOXIN 11 ##
##############
MDHD.toxin11A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20200924_toxin11A",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20200924_toxin11A_data_1602696342SJW.RData") %>%
  dplyr::filter(Worm_Length > 50) %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>%
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

##############
## TOXIN 12 ##
##############
MDHD.toxin12A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20201105_toxin12A",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20201105_toxin12A_data_1605131334SJW.RData") %>%
  dplyr::filter(Worm_Length > 50) %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>%
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

##############
## TOXIN 14 ##
##############
MDHD.toxin14A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20201210_toxin14A",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20201210_toxin14A_data_1609973542SJW.RData") %>%
  dplyr::filter(Worm_Length > 50) %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>%
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

MDHD.toxin14B <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20201211_toxin14B",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20201211_toxin14B_data_1609875275SJW.RData") %>%
  dplyr::filter(Worm_Length > 50) %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>%
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)


##############
## TOXIN 15 ##
##############
MDHD.toxin15A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20201217_toxin15A",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20201217_toxin15A_data_1609886407SJW.RData") %>%
  dplyr::filter(Worm_Length > 50) %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>%
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

MDHD.toxin15B <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20201218_toxin15B",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20201218_toxin15B_data_1609979126SJW.RData") %>%
  dplyr::filter(Worm_Length > 50) %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>%
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

##############
## TOXIN 16 ##
##############
MDHD.toxin16A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20210129_toxin16A",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20210129_toxin16A_data_1612115412SJW.RData") %>%
  dplyr::filter(Worm_Length > 50) %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>%
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

##############
## TOXIN 17 ##
##############
MDHD.toxin17A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20210204_toxin17A",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20210204_toxin17A_data_1612562886SJW.RData") %>%
  dplyr::filter(Worm_Length > 50) %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>%
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

##############
## TOXIN 18 ##
##############
MDHD.toxin18A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20210211_toxin18A",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20210211_toxin18A_data_1613317121SJW.RData") %>% 
  dplyr::filter(Worm_Length > 50) %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>% 
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

##############
## TOXIN 19 ##
##############
MDHD.toxin19A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20210218_toxin19A",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20210218_toxin19A_data_1614224793SJW.RData") %>% 
  dplyr::filter(Worm_Length > 50) %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>% 
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)


##############
## TOXIN 22 ##
##############
MDHD.toxin22A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20210311_toxin22A/",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20210311_toxin22A_data_1615574989SJW.RData") %>% 
  dplyr::filter(Worm_Length > 50) %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>% 
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)


##############
## TOXIN 23 ##
##############
MDHD.toxin23A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20210318_toxin23A/",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20210318_toxin23A_data_1616184391SJW.RData") %>% 
  dplyr::filter(Worm_Length > 50) %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>% 
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)


##############
## TOXIN 24 ##
##############
MDHD.toxin24A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20210325_toxin24A/",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20210325_toxin24A_data_1616789627SJW.RData") %>% 
  dplyr::filter(Worm_Length > 50) %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>% 
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

##############
## TOXIN 25 ##
##############
MDHD.toxin25A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20210401_toxin25A/",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20210401_toxin25A_data_1617560356SJW.RData") %>% 
  dplyr::filter(Worm_Length > 50) %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>% 
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

##############
## TOXIN 26 ##
##############
MDHD.toxin26A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20210408_toxin26A/",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20210408_toxin26A_data_1617993567SJW.RData") %>% 
  dplyr::filter(Worm_Length > 50) %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>% 
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)


##############
## TOXIN 27 ##
##############
MDHD.toxin27A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20210415_toxin27A/",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20210415_toxin27A_data_1618834612SJW.RData") %>% 
  dplyr::filter(Worm_Length > 50) %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>% 
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)


##############
## TOXIN 28 ##
##############
MDHD.toxin28A <- easyXpress::readXpress(filedir = "~/Dropbox/HTA_ImageXpress/Projects/20210701_toxin28A/",
                                             design = T,
                                             rdafile = "CellProfiler-Analysis_20210701_toxin28A_data_1625594171SJW.RData") %>% 
  dplyr::filter(Worm_Length > 50) %>%
  easyXpress::modelSelection(.) %>%
  easyXpress::edgeFlag(.) %>%
  easyXpress::setFlags(.) %>% 
  easyXpress::process(., Metadata_Plate, Metadata_Well, Metadata_Experiment, bleach, drug, strain, concentration_um)

beepr::beep(sound = "fanfare")
# #### TIDY IMAGES #### (ifneedbe)
# easyXpress::tidyImages(project_dir = "/Volumes/ECA_Image/sam/20210211-toxin18A/", rm_other = T)
# easyXpress::tidyProject(project_dir = "/Volumes/ECA_Image/sam/20210211-toxin18A/", plates = "all")
```

```{r message=TRUE, warning=FALSE, include=FALSE}
# CP.data.list <- as.list(ls(pattern = "processed"))
MDHD.data.list <- as.list(ls(pattern = "MDHD"))
pull.toxin <- function(data, toxin){
  assay <- get(data)
  assay$summarized_processed[grep(assay$summarized_processed$drug, pattern = toxin, ignore.case = T),] %>%
    dplyr::mutate(Metadata_Plate = gsub(x = Metadata_Plate, 
                                        pattern = "p", 
                                        replacement = ""),
                  well_censor_reason = as.character(well_censor_reason),
                  notes = as.character(notes),
                  concentration_um = round(concentration_um, 1))
}
traits <- c("median_wormlength_um")
```

```{r processing, echo=FALSE, message=FALSE, warning=FALSE}

all.dat <- MDHD.toxin09A$summarized_processed %>%
  dplyr::full_join(MDHD.toxin10A$summarized_processed) %>%
  dplyr::full_join(MDHD.toxin11A$summarized_processed) %>%
  dplyr::full_join(MDHD.toxin14A$summarized_processed) %>%
  dplyr::full_join(MDHD.toxin14B$summarized_processed) %>%
  dplyr::full_join(MDHD.toxin15A$summarized_processed) %>%
  dplyr::full_join(MDHD.toxin15B$summarized_processed) %>%
  dplyr::full_join(MDHD.toxin16A$summarized_processed) %>%
  dplyr::full_join(MDHD.toxin17A$summarized_processed) %>%
  dplyr::full_join(MDHD.toxin18A$summarized_processed) %>%
  dplyr::full_join(MDHD.toxin19A$summarized_processed) %>%
  dplyr::full_join(MDHD.toxin22A$summarized_processed) %>%
  dplyr::full_join(MDHD.toxin23A$summarized_processed) %>%
  dplyr::full_join(MDHD.toxin24A$summarized_processed) %>%
  dplyr::full_join(MDHD.toxin25A$summarized_processed) %>%
  dplyr::full_join(MDHD.toxin26A$summarized_processed) %>%
  dplyr::full_join(MDHD.toxin27A$summarized_processed) %>%
  dplyr::full_join(MDHD.toxin28A$summarized_processed)

all.dat <- all.dat%>%
  dplyr::mutate(drug = as.factor(stringr::str_to_sentence(drug)))

pre.tab <- all.dat %>%
  dplyr::group_by(drug, strain, Metadata_Experiment) %>%
  tidyr::nest()

tab <- list()
for(i in 1:length(pre.tab$data)){
  g <- pre.tab$data[[i]] %>%
    dplyr::mutate(dose = as.factor(concentration_um),
                  strain = pre.tab$strain[[i]],
                  drug = pre.tab$drug[[i]],
                  assay = pre.tab$Metadata_Experiment[[i]])
  levels(g$dose) <- c(1:length(levels(g$dose)))
  tab[[i]] <- g
}
raw.tab.dat <- Reduce(rbind, tab) %>%
  dplyr::select(Metadata_Plate, assay, bleach, drug, strain, dose, n, median_wormlength_um, Metadata_Well)

control.wells.variance <- raw.tab.dat %>%
  dplyr::filter(dose == 1) %>%
  dplyr::group_by(assay, bleach, strain) %>%
  dplyr::summarise(mean.n = mean(n),
                   sd.n = sd(n),
                   cv.n = (sd.n/mean.n),
                   mean.median_wormlength_um = mean(median_wormlength_um),
                   sd.median_wormlength_um = sd(median_wormlength_um),
                   cv.worm.length = sd(median_wormlength_um)/mean(median_wormlength_um)) %>%
  tidyr::pivot_longer(cols = !c(assay, bleach, strain), names_to = "metric")

cv.n.censor <- control.wells.variance %>%
  dplyr::filter(metric == "cv.n") %>%
  dplyr::group_by(assay, bleach) %>%
  dplyr::summarise(median = median(value)) %>%
  dplyr::mutate(cv.censor = if_else(condition = median > 0.5, true = 1, false = 0)) %>%
  dplyr::rename(Metadata_Experiment = assay)
```

## Silver nitrate
```{r Silver, echo=FALSE, message=FALSE, warning=FALSE}
silver <- purrr::map2(MDHD.data.list, 
                      "silver",
                      pull.toxin)
silver.df <- Reduce(rbind,silver) %>%
  dplyr::mutate(drug = levels(as.factor(drug))[2],
                assay_bleach = paste(Metadata_Experiment,bleach,sep = "_")) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  dplyr::filter(!assay_bleach %in% c("toxin09A_1","toxin11A_1","toxin15A_1","toxin15A_2")) %>%
  cleanData(.)

drug.data.nested <- silver.df[[1]] %>%
  dplyr::select(strain, drug, concentration_um, median_wormlength_um_reg) %>%
  dplyr::group_by(concentration_um, strain) %>%
  tidyr::nest()

drug.data.nested$data <- purrr::map(drug.data.nested$data, make.reps)
drug.data.nested.reps <- drug.data.nested %>%
  tidyr::unnest(cols = c(data)) %>%
  dplyr::group_by(concentration_um) %>%
  tidyr::nest()

silverH2 <- purrr::map2(drug.data.nested.reps$data,
            drug.data.nested.reps$concentration_um,
            drugHeritability)
H2.plot(H2.out = silverH2)
GWA.doses <- c(7.8, 250)
DR.herit.summary(H2.out = silverH2, x = silver.df[[1]], doses = GWA.doses)
```

## Cadmium dichloride
```{r Cadmium, echo=FALSE, message=FALSE, warning=FALSE}
cadmium <- purrr::map2(MDHD.data.list, 
                      "cadmium",
                      pull.toxin)
cadmium.df <- Reduce(rbind,cadmium) %>%
  dplyr::mutate(drug = levels(as.factor(drug))[2],
                assay_bleach = paste(Metadata_Experiment,bleach,sep = "_")) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  dplyr::filter(!assay_bleach %in% c("toxin09A_1","toxin11A_1","toxin15A_1","toxin15A_2")) %>%
  cleanData(.)



drug.data.nested <- cadmium.df[[1]] %>%
  dplyr::select(strain, drug, concentration_um, median_wormlength_um_reg) %>%
  dplyr::group_by(concentration_um, strain) %>%
  tidyr::nest()

drug.data.nested$data <- purrr::map(drug.data.nested$data, make.reps)
drug.data.nested.reps <- drug.data.nested %>%
  tidyr::unnest(cols = c(data)) %>%
  dplyr::group_by(concentration_um) %>%
  tidyr::nest()

cadmiumH2 <- purrr::map2(drug.data.nested.reps$data,
            drug.data.nested.reps$concentration_um,
            drugHeritability)
H2.plot(H2.out = cadmiumH2)
GWA.doses <- c(50)
DR.herit.summary(H2.out = cadmiumH2, x = cadmium.df[[1]], doses = GWA.doses)
```

## Copper (II) dichloride
```{r copper, echo=FALSE, message=FALSE, warning=FALSE}
copper <- purrr::map2(MDHD.data.list, 
                      "copper",
                      pull.toxin)

copper.df <- Reduce(rbind,copper) %>%
  dplyr::mutate(drug = levels(as.factor(drug))[2],
                assay_bleach = paste(Metadata_Experiment,bleach,sep = "_")) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  dplyr::filter(!assay_bleach %in% c("toxin09A_1","toxin11A_1","toxin15A_1","toxin15A_2")) %>%
  cleanData(.)



drug.data.nested <- copper.df[[1]] %>%
  dplyr::select(strain, drug, concentration_um, median_wormlength_um_reg) %>%
  dplyr::group_by(concentration_um, strain) %>%
  tidyr::nest()

drug.data.nested$data <- purrr::map(drug.data.nested$data, make.reps)
drug.data.nested.reps <- drug.data.nested %>%
  tidyr::unnest(cols = c(data)) %>%
  dplyr::group_by(concentration_um) %>%
  tidyr::nest()

copperH2 <- purrr::map2(drug.data.nested.reps$data,
            drug.data.nested.reps$concentration_um,
            drugHeritability)
H2.plot(H2.out = copperH2)
GWA.doses <- c(100)
DR.herit.summary(H2.out = copperH2, x = copper.df[[1]], doses = GWA.doses)
```

## Nickel dichloride
```{r nickel, echo=FALSE, message=FALSE, warning=FALSE}
nickel <- purrr::map2(MDHD.data.list, 
                      "nickel",
                      pull.toxin)

nickel.df <- Reduce(rbind,nickel) %>%
  dplyr::mutate(drug = levels(as.factor(drug))[2],
                assay_bleach = paste(Metadata_Experiment,bleach,sep = "_")) %>%## from combining 9,10,11
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  dplyr::filter(!assay_bleach %in% c("toxin09A_1","toxin11A_1","toxin15A_1")) %>%
  cleanData(.)



drug.data.nested <- nickel.df[[1]] %>%
  dplyr::select(strain, drug, concentration_um, median_wormlength_um_reg) %>%
  dplyr::group_by(concentration_um, strain) %>%
  tidyr::nest()

drug.data.nested$data <- purrr::map(drug.data.nested$data, make.reps)
drug.data.nested.reps <- drug.data.nested %>%
  tidyr::unnest(cols = c(data)) %>%
  dplyr::group_by(concentration_um) %>%
  tidyr::nest()

nickelH2 <- purrr::map2(drug.data.nested.reps$data,
            drug.data.nested.reps$concentration_um,
            drugHeritability)

H2.plot(H2.out = nickelH2)
GWA.doses <- c(100)
DR.herit.summary(H2.out = nickelH2, x = nickel.df[[1]], doses = GWA.doses)
```

## Paraquat
```{r paraquat, echo=FALSE, message=FALSE, warning=FALSE}
paraquat <- purrr::map2(MDHD.data.list, 
                        "paraquat",
                        pull.toxin)

paraquat.df <- Reduce(rbind,paraquat) %>%
  dplyr::mutate(drug = levels(as.factor(drug))[2],
                assay_bleach = paste(Metadata_Experiment,bleach,sep = "_")) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  dplyr::filter(!assay_bleach %in% c("toxin09A_1","toxin10A_1","toxin11A_1","toxin15A_1")) %>%
  cleanData(.)



drug.data.nested <- paraquat.df[[1]] %>%
  dplyr::select(strain, drug, concentration_um, median_wormlength_um_reg) %>%
  dplyr::group_by(concentration_um, strain) %>%
  tidyr::nest()

drug.data.nested$data <- purrr::map(drug.data.nested$data, make.reps)
drug.data.nested.reps <- drug.data.nested %>%
  tidyr::unnest(cols = c(data)) %>%
  dplyr::group_by(concentration_um) %>%
  tidyr::nest()

paraquatH2 <- purrr::map2(drug.data.nested.reps$data,
            drug.data.nested.reps$concentration_um,
            drugHeritability)
H2.plot(H2.out = paraquatH2)
GWA.doses <- c(62.5,250)
DR.herit.summary(H2.out = paraquatH2, x = paraquat.df[[1]], doses = GWA.doses)

```

## Zinc dichloride
```{r zinc, echo=FALSE, message=FALSE, warning=FALSE}
zinc <- purrr::map2(MDHD.data.list, 
                        "zinc",
                        pull.toxin)

zinc.df <- Reduce(rbind,zinc) %>%
  dplyr::mutate(drug = levels(as.factor(drug))[2],
                assay_bleach = paste(Metadata_Experiment,bleach,sep = "_")) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  dplyr::filter(!assay_bleach %in% c("toxin09A_1","toxin11A_1","toxin15A_1")) %>%
  cleanData(.)



drug.data.nested <- zinc.df[[1]] %>%
  dplyr::select(strain, drug, concentration_um, median_wormlength_um_reg) %>%
  dplyr::group_by(concentration_um, strain) %>%
  tidyr::nest()

drug.data.nested$data <- purrr::map(drug.data.nested$data, make.reps)
drug.data.nested.reps <- drug.data.nested %>%
  tidyr::unnest(cols = c(data)) %>%
  dplyr::group_by(concentration_um) %>%
  tidyr::nest()

zincH2 <- purrr::map2(drug.data.nested.reps$data,
            drug.data.nested.reps$concentration_um,
            drugHeritability)
H2.plot(H2.out = zincH2)
GWA.doses <- c(50)
DR.herit.summary(H2.out = zincH2, x = zinc.df[[1]], doses = GWA.doses)
```

## Pyraclostrobin
```{r pyraclostrobin, echo=FALSE, message=FALSE, warning=FALSE}
pyraclostrobin <- purrr::map2(MDHD.data.list, 
                        "pyraclostrobin",
                        pull.toxin)

pyraclostrobin.df <- Reduce(rbind,pyraclostrobin) %>%
  dplyr::mutate(drug = levels(as.factor(drug))[2],
                assay_bleach = paste(Metadata_Experiment,bleach,sep = "_")) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  dplyr::filter(!assay_bleach %in% c("toxin09A_1","toxin10A_1","toxin11A_1","toxin15B_2")) %>%
  cleanData(.)



drug.data.nested <- pyraclostrobin.df[[1]] %>%
  dplyr::select(strain, drug, concentration_um, median_wormlength_um_reg) %>%
  dplyr::group_by(concentration_um, strain) %>%
  tidyr::nest()

drug.data.nested$data <- purrr::map(drug.data.nested$data, make.reps)
drug.data.nested.reps <- drug.data.nested %>%
  tidyr::unnest(cols = c(data)) %>%
  dplyr::group_by(concentration_um) %>%
  tidyr::nest()

pyraclostrobinH2 <- purrr::map2(drug.data.nested.reps$data,
            drug.data.nested.reps$concentration_um,
            drugHeritability)
H2.plot(H2.out = pyraclostrobinH2)
GWA.doses <- c(93.75)
DR.herit.summary(H2.out = pyraclostrobinH2, x = pyraclostrobin.df[[1]], doses = GWA.doses)

```

## Aldicarb
```{r aldicarb, echo=FALSE, message=FALSE, warning=FALSE}
aldicarb <- purrr::map2(MDHD.data.list, 
                        "aldicarb",
                        pull.toxin)

aldicarb.df <- Reduce(rbind,aldicarb) %>%
  dplyr::mutate(drug = levels(as.factor(drug))[2],
                assay_bleach = paste(Metadata_Experiment,bleach,sep = "_")) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  dplyr::filter(!assay_bleach %in% c("toxin10A_1","toxin11A_1")) %>%
  cleanData(.)



drug.data.nested <- aldicarb.df[[1]] %>%
  dplyr::select(strain, drug, concentration_um, median_wormlength_um_reg) %>%
  dplyr::group_by(concentration_um, strain) %>%
  tidyr::nest()

drug.data.nested$data <- purrr::map(drug.data.nested$data, make.reps)
drug.data.nested.reps <- drug.data.nested %>%
  tidyr::unnest(cols = c(data)) %>%
  dplyr::group_by(concentration_um) %>%
  tidyr::nest()

aldicarbH2 <- purrr::map2(drug.data.nested.reps$data,
            drug.data.nested.reps$concentration_um,
            drugHeritability)
H2.plot(H2.out = aldicarbH2)
GWA.doses <- c(156.25)
DR.herit.summary(H2.out = aldicarbH2, x = aldicarb.df[[1]], doses = GWA.doses)
```

## Chlorfenapyr
```{r chlorfenapyr, echo=FALSE, message=FALSE, warning=FALSE}
chlorfenapyr <- purrr::map2(MDHD.data.list, 
                        "chlorfenapyr",
                        pull.toxin)

chlorfenapyr.df <- Reduce(rbind,chlorfenapyr) %>%
  dplyr::mutate(drug = levels(as.factor(drug))[2],
                assay_bleach = paste(Metadata_Experiment,bleach,sep = "_")) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  dplyr::filter(!assay_bleach %in% c("toxin09A_1","toxin10A_1","toxin11A_1","toxin15B_1")) %>%
  cleanData(.)



drug.data.nested <- chlorfenapyr.df[[1]] %>%
  dplyr::select(strain, drug, concentration_um, median_wormlength_um_reg) %>%
  dplyr::group_by(concentration_um, strain) %>%
  tidyr::nest()

drug.data.nested$data <- purrr::map(drug.data.nested$data, make.reps)
drug.data.nested.reps <- drug.data.nested %>%
  tidyr::unnest(cols = c(data)) %>%
  dplyr::group_by(concentration_um) %>%
  tidyr::nest()

chlorfenapyrH2 <- purrr::map2(drug.data.nested.reps$data,
            drug.data.nested.reps$concentration_um,
            drugHeritability)
H2.plot(H2.out = chlorfenapyrH2)
GWA.doses <- c(0.62)
DR.herit.summary(H2.out = chlorfenapyrH2, x = chlorfenapyr.df[[1]], doses = GWA.doses)
```

## Methomyl
```{r methomyl, echo=FALSE, message=FALSE, warning=FALSE}
methomyl <- purrr::map2(MDHD.data.list, 
                        "methomyl",
                        pull.toxin)

methomyl.df <- Reduce(rbind,methomyl) %>%
  dplyr::mutate(drug = levels(as.factor(drug))[2],
                assay_bleach = paste(Metadata_Experiment,bleach,sep = "_")) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  dplyr::filter(!assay_bleach %in% c("toxin10A_1","toxin11A_1","toxin14B_1")) %>%
  cleanData(.)



drug.data.nested <- methomyl.df[[1]] %>%
  dplyr::select(strain, drug, concentration_um, median_wormlength_um_reg) %>%
  dplyr::group_by(concentration_um, strain) %>%
  tidyr::nest()

drug.data.nested$data <- purrr::map(drug.data.nested$data, make.reps)
drug.data.nested.reps <- drug.data.nested %>%
  tidyr::unnest(cols = c(data)) %>%
  dplyr::group_by(concentration_um) %>%
  tidyr::nest()

methomylH2 <- purrr::map2(drug.data.nested.reps$data,
            drug.data.nested.reps$concentration_um,
            drugHeritability)
H2.plot(H2.out = methomylH2)
GWA.doses <- c(50)
DR.herit.summary(H2.out = methomylH2, x = methomyl.df[[1]], doses = GWA.doses)
```

## Methylmercury dichloride
```{r mercury, echo=FALSE, message=FALSE, warning=FALSE}
methyl.mercury <- purrr::map2(MDHD.data.list, 
                        "mercury",
                        pull.toxin)

methyl.mercury.df <- Reduce(rbind,methyl.mercury) %>%
  dplyr::mutate(drug = levels(as.factor(drug))[2],
                assay_bleach = paste(Metadata_Experiment,bleach,sep = "_")) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  dplyr::filter(!assay_bleach %in% c("toxin10A_1","toxin11A_1")) %>%
  cleanData(.)


drug.data.nested <- methyl.mercury.df[[1]] %>%
  dplyr::select(strain, drug, concentration_um, median_wormlength_um_reg) %>%
  dplyr::group_by(concentration_um, strain) %>%
  tidyr::nest()

drug.data.nested$data <- purrr::map(drug.data.nested$data, make.reps)
drug.data.nested.reps <- drug.data.nested %>%
  tidyr::unnest(cols = c(data)) %>%
  dplyr::group_by(concentration_um) %>%
  tidyr::nest()

mercuryH2 <- purrr::map2(drug.data.nested.reps$data,
            drug.data.nested.reps$concentration_um,
            drugHeritability)
H2.plot(H2.out = mercuryH2)
GWA.doses <- c(15.62)
DR.herit.summary(H2.out = mercuryH2, x = methyl.mercury.df[[1]], doses = GWA.doses)
```

## Triphenyl phosphate
```{r tpp, echo=FALSE, message=FALSE, warning=FALSE}
tpp <- purrr::map2(MDHD.data.list, 
                   "triphenyl",
                   pull.toxin)

tpp.df <- Reduce(rbind,tpp) %>%
  dplyr::mutate(drug = levels(as.factor(drug))[2],
                assay_bleach = paste(Metadata_Experiment,bleach,sep = "_")) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  dplyr::filter(!assay_bleach %in% c("toxin09A_1","toxin11A_1","toxin15B_1")) %>%
  cleanData(.)



drug.data.nested <- tpp.df[[1]] %>%
  dplyr::select(strain, drug, concentration_um, median_wormlength_um_reg) %>%
  dplyr::group_by(concentration_um, strain) %>%
  tidyr::nest()

drug.data.nested$data <- purrr::map(drug.data.nested$data, make.reps)
drug.data.nested.reps <- drug.data.nested %>%
  tidyr::unnest(cols = c(data)) %>%
  dplyr::group_by(concentration_um) %>%
  tidyr::nest()

tppH2 <- purrr::map2(drug.data.nested.reps$data,
            drug.data.nested.reps$concentration_um,
            drugHeritability)
H2.plot(H2.out = tppH2)
GWA.doses <- c(6.25,50)
DR.herit.summary(H2.out = tppH2, x = tpp.df[[1]], doses = GWA.doses)
```

## Arsenic trioxide
```{r arsenic, echo=FALSE, message=FALSE, warning=FALSE}
arsenic <- purrr::map2(MDHD.data.list, 
                   "Arsenic",
                   pull.toxin)
arsenic.df <- Reduce(rbind,arsenic) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  cleanData(.)



drug.data.nested <- arsenic.df[[1]] %>%
  dplyr::select(strain, drug, concentration_um, median_wormlength_um_reg) %>%
  dplyr::group_by(concentration_um, strain) %>%
  tidyr::nest()

drug.data.nested$data <- purrr::map(drug.data.nested$data, make.reps)
drug.data.nested.reps <- drug.data.nested %>%
  tidyr::unnest(cols = c(data)) %>%
  dplyr::group_by(concentration_um) %>%
  tidyr::nest()

arsenicH2 <- purrr::map2(drug.data.nested.reps$data,
            drug.data.nested.reps$concentration_um,
            drugHeritability)
H2.plot(H2.out = arsenicH2)
GWA.doses <- c(242.26)
DR.herit.summary(H2.out = arsenicH2, x = arsenic.df[[1]], doses = GWA.doses)
```

## Carbaryl
```{r carbaryl, echo=FALSE, message=FALSE, warning=FALSE}
carbaryl <- purrr::map2(MDHD.data.list, 
                   "Carbaryl",
                   pull.toxin)
carbaryl.df <- Reduce(rbind,carbaryl) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  cleanData(.)



drug.data.nested <- carbaryl.df[[1]] %>%
  dplyr::select(strain, drug, concentration_um, median_wormlength_um_reg) %>%
  dplyr::group_by(concentration_um, strain) %>%
  tidyr::nest()

drug.data.nested$data <- purrr::map(drug.data.nested$data, make.reps)
drug.data.nested.reps <- drug.data.nested %>%
  tidyr::unnest(cols = c(data)) %>%
  dplyr::group_by(concentration_um) %>%
  tidyr::nest()

carbarylH2 <- purrr::map2(drug.data.nested.reps$data,
            drug.data.nested.reps$concentration_um,
            drugHeritability)
H2.plot(H2.out = carbarylH2)
GWA.doses <- c(262.14)
DR.herit.summary(H2.out = carbarylH2, x = carbaryl.df[[1]], doses = GWA.doses)
```

## Carboxin
```{r carboxin, echo=FALSE, message=FALSE, warning=FALSE}
carboxin <- purrr::map2(MDHD.data.list, 
                   "Carboxin",
                   pull.toxin)
carboxin.df <- Reduce(rbind,carboxin) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  cleanData(.)



drug.data.nested <- carboxin.df[[1]] %>%
  dplyr::select(strain, drug, concentration_um, median_wormlength_um_reg) %>%
  dplyr::group_by(concentration_um, strain) %>%
  tidyr::nest()

drug.data.nested$data <- purrr::map(drug.data.nested$data, make.reps)
drug.data.nested.reps <- drug.data.nested %>%
  tidyr::unnest(cols = c(data)) %>%
  dplyr::group_by(concentration_um) %>%
  tidyr::nest()

carboxinH2 <- purrr::map2(drug.data.nested.reps$data,
            drug.data.nested.reps$concentration_um,
            drugHeritability)
H2.plot(H2.out = carboxinH2)
GWA.doses <- c(538.66)
DR.herit.summary(H2.out = carboxinH2, x = carboxin.df[[1]], doses = GWA.doses)
```

## Chlorpyrifos
```{r chlorpyrifos, echo=FALSE, message=FALSE, warning=FALSE}
chlorpyrifos <- purrr::map2(MDHD.data.list, 
                   "Chlorpyrifos",
                   pull.toxin)
print("Excluding toxin17A: No Response")
chlorpyrifos.df <- Reduce(rbind,chlorpyrifos) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  dplyr::filter(!Metadata_Experiment %in% c("toxin17A")) %>% 
  cleanData(.)



drug.data.nested <- chlorpyrifos.df[[1]] %>%
  dplyr::select(strain, drug, concentration_um, median_wormlength_um_reg) %>%
  dplyr::group_by(concentration_um, strain) %>%
  tidyr::nest()

drug.data.nested$data <- purrr::map(drug.data.nested$data, make.reps)
drug.data.nested.reps <- drug.data.nested %>%
  tidyr::unnest(cols = c(data)) %>%
  dplyr::group_by(concentration_um) %>%
  tidyr::nest()

chlorpyrifosH2 <- purrr::map2(drug.data.nested.reps$data,
            drug.data.nested.reps$concentration_um,
            drugHeritability)
H2.plot(H2.out = chlorpyrifosH2)
GWA.doses <- c(2.7)
DR.herit.summary(H2.out = chlorpyrifosH2, x = chlorpyrifos.df[[1]], doses = GWA.doses)
```

## Lead (II) nitrate
```{r lead, echo=FALSE, message=FALSE, warning=FALSE}
lead <- purrr::map2(MDHD.data.list, 
                   "Lead",
                   pull.toxin)
lead.df <- Reduce(rbind,lead) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  cleanData(.)



drug.data.nested <- lead.df[[1]] %>%
  dplyr::select(strain, drug, concentration_um, median_wormlength_um_reg) %>%
  dplyr::group_by(concentration_um, strain) %>%
  tidyr::nest()

drug.data.nested$data <- purrr::map(drug.data.nested$data, make.reps)
drug.data.nested.reps <- drug.data.nested %>%
  tidyr::unnest(cols = c(data)) %>%
  dplyr::group_by(concentration_um) %>%
  tidyr::nest()

leadH2 <- purrr::map2(drug.data.nested.reps$data,
            drug.data.nested.reps$concentration_um,
            drugHeritability)

H2.plot(H2.out = leadH2)
GWA.doses <- c(49.74)
DR.herit.summary(H2.out = leadH2, x = lead.df[[1]], doses = GWA.doses)
```

## Atrazine
```{r atrazine, echo=FALSE, message=FALSE, warning=FALSE}
atrazine <- purrr::map2(MDHD.data.list, 
                   "Atrazine",
                   pull.toxin)
atrazine.df <- Reduce(rbind,atrazine) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  cleanData(.)



drug.data.nested <- atrazine.df[[1]] %>%
  dplyr::select(strain, drug, concentration_um, median_wormlength_um_reg) %>%
  dplyr::group_by(concentration_um, strain) %>%
  tidyr::nest()

drug.data.nested$data <- purrr::map(drug.data.nested$data, make.reps)
drug.data.nested.reps <- drug.data.nested %>%
  tidyr::unnest(cols = c(data)) %>%
  dplyr::group_by(concentration_um) %>%
  tidyr::nest()

atrazineH2 <- purrr::map2(drug.data.nested.reps$data,
            drug.data.nested.reps$concentration_um,
            drugHeritability)
H2.plot(H2.out = atrazineH2)
GWA.doses <- c(510.2)
DR.herit.summary(H2.out = atrazineH2, x = atrazine.df[[1]], doses = GWA.doses)
```

## 2,4-D
```{r x24D, echo=FALSE, message=FALSE, warning=FALSE}
x2.4.D <- purrr::map2(MDHD.data.list, 
                   "2,4-D",
                   pull.toxin)
x2.4.D.df <- Reduce(rbind,x2.4.D) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  cleanData(.)



drug.data.nested <- x2.4.D.df[[1]] %>%
  dplyr::select(strain, drug, concentration_um, median_wormlength_um_reg) %>%
  dplyr::group_by(concentration_um, strain) %>%
  tidyr::nest()

drug.data.nested$data <- purrr::map(drug.data.nested$data, make.reps)
drug.data.nested.reps <- drug.data.nested %>%
  tidyr::unnest(cols = c(data)) %>%
  dplyr::group_by(concentration_um) %>%
  tidyr::nest()

x2.4.DH2 <- purrr::map2(drug.data.nested.reps$data,
            drug.data.nested.reps$concentration_um,
            drugHeritability)
H2.plot(H2.out = x2.4.DH2)
GWA.doses <- c(751.31)
DR.herit.summary(H2.out = x2.4.DH2, x = x2.4.D.df[[1]], doses = GWA.doses)

```

## Malathion
```{r malathion, echo=FALSE, message=FALSE, warning=FALSE}
malathion <- purrr::map2(MDHD.data.list, 
                   "Malathion",
                   pull.toxin)
malathion.df <- Reduce(rbind,malathion) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  cleanData(.)



drug.data.nested <- malathion.df[[1]] %>%
  dplyr::select(strain, drug, concentration_um, median_wormlength_um_reg) %>%
  dplyr::group_by(concentration_um, strain) %>%
  tidyr::nest()

drug.data.nested$data <- purrr::map(drug.data.nested$data, make.reps)
drug.data.nested.reps <- drug.data.nested %>%
  tidyr::unnest(cols = c(data)) %>%
  dplyr::group_by(concentration_um) %>%
  tidyr::nest()

malathionH2 <- purrr::map2(drug.data.nested.reps$data,
            drug.data.nested.reps$concentration_um,
            drugHeritability)
H2.plot(H2.out = malathionH2)
GWA.doses <- c(790.12)
DR.herit.summary(H2.out = malathionH2, x = malathion.df[[1]], doses = GWA.doses)
```

## Chlorothalonil
```{r Chlorothalonil, echo=FALSE, message=FALSE, warning=FALSE}
chlorothalonil <- purrr::map2(MDHD.data.list, 
                   "Chlorothalonil",
                   pull.toxin)
chlorothalonil.df <- Reduce(rbind,chlorothalonil) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  cleanData(.)



drug.data.nested <- chlorothalonil.df[[1]] %>%
  dplyr::select(strain, drug, concentration_um, median_wormlength_um_reg) %>%
  dplyr::group_by(concentration_um, strain) %>%
  tidyr::nest()

drug.data.nested$data <- purrr::map(drug.data.nested$data, make.reps)
drug.data.nested.reps <- drug.data.nested %>%
  tidyr::unnest(cols = c(data)) %>%
  dplyr::group_by(concentration_um) %>%
  tidyr::nest()

chlorothalonilH2 <- purrr::map2(drug.data.nested.reps$data,
            drug.data.nested.reps$concentration_um,
            drugHeritability)
H2.plot(H2.out = chlorothalonilH2)
GWA.doses <- c(111.11)
DR.herit.summary(H2.out = chlorothalonilH2, x = chlorothalonil.df[[1]], doses = GWA.doses)
```

## Deltamethrin
```{r Deltamethrin, echo=FALSE, message=FALSE, warning=FALSE}
deltamethrin <- purrr::map2(MDHD.data.list, 
                   "Deltamethrin",
                   pull.toxin)
deltamethrin.df <- Reduce(rbind,deltamethrin) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  cleanData(.)



drug.data.nested <- deltamethrin.df[[1]] %>%
  dplyr::select(strain, drug, concentration_um, median_wormlength_um_reg) %>%
  dplyr::group_by(concentration_um, strain) %>%
  tidyr::nest()

drug.data.nested$data <- purrr::map(drug.data.nested$data, make.reps)
drug.data.nested.reps <- drug.data.nested %>%
  tidyr::unnest(cols = c(data)) %>%
  dplyr::group_by(concentration_um) %>%
  tidyr::nest()

deltamethrinH2 <- purrr::map2(drug.data.nested.reps$data,
            drug.data.nested.reps$concentration_um,
            drugHeritability)
H2.plot(H2.out = deltamethrinH2)
se.DR(deltamethrin.df[[1]])
```

## Manganese dichloride
```{r Manganese, echo=FALSE, message=FALSE, warning=FALSE}
manganese <- purrr::map2(MDHD.data.list, 
                   "Manganese dichloride",
                   pull.toxin)
manganese.df <- Reduce(rbind,manganese) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  cleanData(.)



drug.data.nested <- manganese.df[[1]] %>%
  dplyr::select(strain, drug, concentration_um, median_wormlength_um_reg) %>%
  dplyr::group_by(concentration_um, strain) %>%
  tidyr::nest()

drug.data.nested$data <- purrr::map(drug.data.nested$data, make.reps)
drug.data.nested.reps <- drug.data.nested %>%
  tidyr::unnest(cols = c(data)) %>%
  dplyr::group_by(concentration_um) %>%
  tidyr::nest()

manganeseH2 <- purrr::map2(drug.data.nested.reps$data,
            drug.data.nested.reps$concentration_um,
            drugHeritability)
H2.plot(H2.out = manganeseH2)
se.DR(manganese.df[[1]])
```

## Propoxur
```{r propoxur, echo=FALSE, message=FALSE, warning=FALSE}
propoxur <- purrr::map2(MDHD.data.list, 
                   "Propoxur",
                   pull.toxin)
propoxur.df <- Reduce(rbind,propoxur) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  cleanData(.)

drug.data.nested <- propoxur.df[[1]] %>%
  dplyr::select(strain, drug, concentration_um, median_wormlength_um_reg) %>%
  dplyr::group_by(concentration_um, strain) %>%
  tidyr::nest()

drug.data.nested$data <- purrr::map(drug.data.nested$data, make.reps)
drug.data.nested.reps <- drug.data.nested %>%
  tidyr::unnest(cols = c(data)) %>%
  dplyr::group_by(concentration_um) %>%
  tidyr::nest()

propoxurH2 <- purrr::map2(drug.data.nested.reps$data,
            drug.data.nested.reps$concentration_um,
            drugHeritability)
H2.plot(H2.out = propoxurH2)
GWA.doses <- c(195.09)
DR.herit.summary(H2.out = propoxurH2, x = propoxur.df[[1]], doses = GWA.doses)
```

## Mancozeb
```{r mancozeb, echo=FALSE, message=FALSE, warning=FALSE}
mancozeb <- purrr::map2(MDHD.data.list, 
                   "Mancozeb",
                   pull.toxin)
mancozeb.df <- Reduce(rbind,mancozeb) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1, drug != "Mancozeb_Dilute") %>%
  cleanData(.)



drug.data.nested <- mancozeb.df[[1]] %>%
  dplyr::select(strain, drug, concentration_um, median_wormlength_um_reg) %>%
  dplyr::group_by(concentration_um, strain) %>%
  tidyr::nest()

drug.data.nested$data <- purrr::map(drug.data.nested$data, make.reps)
drug.data.nested.reps <- drug.data.nested %>%
  tidyr::unnest(cols = c(data)) %>%
  dplyr::group_by(concentration_um) %>%
  tidyr::nest()

mancozebH2 <- purrr::map2(drug.data.nested.reps$data,
            drug.data.nested.reps$concentration_um,
            drugHeritability)
H2.plot(H2.out = mancozebH2)
GWA.doses <- c(65.54)
DR.herit.summary(H2.out = mancozebH2, x = mancozeb.df[[1]], doses = GWA.doses)
```

## Bacteria
```{r bacteria, echo=FALSE, message=FALSE, warning=FALSE}
bacteria <- purrr::map2(MDHD.data.list, 
                      "Bacteria",
                      pull.toxin)
bacteria.df <- Reduce(rbind,bacteria) %>%
  dplyr::mutate(assay_bleach = paste(Metadata_Experiment,bleach,sep = "_")) %>%
  dplyr::left_join(., cv.n.censor) %>%
  dplyr::filter(cv.censor != 1) %>%
  cleanData(.)


drug.data.nested <- bacteria.df[[1]] %>%
  dplyr::select(strain, drug, concentration_um, median_wormlength_um_reg) %>%
  dplyr::group_by(concentration_um, strain) %>%
  tidyr::nest()

drug.data.nested$data <- purrr::map(drug.data.nested$data, make.reps)
drug.data.nested.reps <- drug.data.nested %>%
  tidyr::unnest(cols = c(data)) %>%
  dplyr::group_by(concentration_um) %>%
  tidyr::nest()

OD_H2 <- purrr::map2(drug.data.nested.reps$data,
                     drug.data.nested.reps$concentration_um,
                     drugHeritability)
H2.plot(H2.out = OD_H2)

se.DR.BACTERIA <- function(x){
  norm <- x %>%
    dplyr::group_by(strain,) %>%
    dplyr::filter(concentration_um == 0) %>%
    dplyr::summarize(mean_ctrl = mean(mean_wormlength_um_reg)) %>%
    dplyr::ungroup() %>%
    dplyr::select(strain, mean_ctrl) %>% ##added trait
    dplyr::full_join(x , by = c("strain")) %>% ## "trait" instead of "condition"
    dplyr::distinct() %>%
    dplyr::mutate(norm_pheno = mean_wormlength_um_reg - mean_ctrl) 

dose_avg <- norm %>%
  dplyr::group_by(strain, concentration_um) %>%
  dplyr::summarise(avg = mean(norm_pheno), st_dev = sd(norm_pheno))

dose.range <- unique(dose_avg$concentration_um)[length(unique(dose_avg$concentration_um))] - unique(dose_avg$concentration_um)[2]

dose_avg %>% 
  ggplot(.) +
  theme_bw() + 
  #geom_point(data = dose_avg , aes(x=log(concentration_um) , y=avg), size = 0.1) +
  geom_errorbar(aes(x=log(concentration_um), 
                    ymin=avg-st_dev, 
                    ymax = avg+st_dev,
                    colour = strain))  +
  geom_line(aes(x=log(concentration_um), 
                y=avg, 
                group = strain, 
                colour = strain), size = 0.5) +
  scale_colour_manual(values = strain_colors, name = "Strain") +
  scale_y_continuous("Normalized response") + 
  ggtitle(unique(x$drug)) +
  labs(x = "log(Bacteria OD)")
}


se.DR.BACTERIA(bacteria.df[[1]])
```

```{r Summary, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
all.herits <- ls(pattern = "H2")
all.herits <- all.herits[!all.herits %in% c("H2","H2.bootstrapping.calc","H2.bootstrapping.perm","H2.plot", 
                                            "top.H2.summary","topH2.nested","H2.pheno.rankings")] # things added later, but including here so this chunk can be re-run more easily on its own

top.herits <- list()
for(i in 1:length(all.herits)){
  drug.herit <- get(all.herits[[i]])
  all.doses <- list()
  for(j in 1:length(drug.herit)){
    
    if(drug.herit[[j]][[1]] != "NA"){
      broad <- drug.herit[[j]][[1]] %>%
        tidyr::pivot_longer(cols = H2, names_to = "metric") %>%
        as.data.frame()
      
      narrow <- drug.herit[[j]][[3]] %>%
        tidyr::pivot_longer(cols = h2, names_to = "metric") %>%
        as.data.frame()
    
    all.doses[[j]] <- broad %>%
      dplyr::full_join(., narrow) %>%
      data.frame()
    } else {
      next
    }
  }
  all.dose.herits <- Reduce(rbind, all.doses)
  top.herits[[i]] <- all.dose.herits
}
top.H2.summary <- do.call(rbind, top.herits)
drug.classes <- read.csv("data/drugclasses.csv")
h2.doses <- data.table::fread("data/h2doses.csv")




big.herit.summary <- h2.doses %>%
  dplyr::mutate(concentration_um = round(concentration_um,1)) %>%
  dplyr::left_join(.,top.H2.summary) %>%
  dplyr::left_join(., drug.classes) %>%
  tidyr::pivot_wider(names_from = metric, values_from = c(upper, lower, value)) %>%
  dplyr::mutate(class = as.factor(class))
class.palette <- c("darkgreen","brown","steelblue1","navajowhite","tan","sandybrown","yellow","red")
names(class.palette) <- unique(big.herit.summary$class)


big.herit.plot <- ggplot(big.herit.summary, mapping = aes(x = value_H2, y = value_h2, colour = class)) + 
  theme_bw(base_size = 20) + 
  geom_abline(slope = 1, alpha = 0.8, linetype = 4) + 
  geom_errorbar(aes(ymin = lower_h2, ymax = upper_h2), alpha = 0.4) + 
  geom_errorbarh(aes(xmin = lower_H2, xmax = upper_H2), alpha = 0.4) +
  geom_point(size = 5) + 
  ylim(c(0,1)) + 
  xlim(c(0,1)) + 
  # geom_text_repel(aes(label = drug), colour = "black", 
  #                 box.padding = 2, 
  #                 max.overlaps = Inf, 
  #                 point.padding = 0.5, size = 3.5) +
  scale_colour_manual(values = class.palette, guide = F) + 
  theme(panel.grid = element_blank()) + 
  labs(x = "Broad-sense heritability",
       y = "Narrow-sense heritability")
width = 6
height = width
ggsave(big.herit.plot, filename = "output/big.herit.plot.png", width = width, height = height)
  






topH2.nested <- top.H2.summary %>%
  dplyr::group_by(drug) %>%
  tidyr::nest()

clean.drug.phenos <- as.list(ls(pattern = ".df"))

clean.drug.phenos[[16]][1] <- "methyl.mercury.df"
clean.drug.phenos[[17]][1] <- "methomyl.df"

H2.pheno.rankings <- function(drug, data, clean.drug.phenos){

  phenos <- get(clean.drug.phenos)[[1]]
  
  dose.mean <- phenos %>%
    dplyr::select(strain, drug, concentration_um, median_wormlength_um_reg) %>%
    dplyr::left_join(data,.) %>%
    dplyr::filter(!is.na(median_wormlength_um_reg)) %>%
    dplyr::group_by(concentration_um) %>%
    dplyr::summarise(dose.mean = mean(median_wormlength_um_reg))
  
  dose.norm <- phenos %>%
    dplyr::select(strain, drug, concentration_um, median_wormlength_um_reg) %>%
    dplyr::left_join(data,.) %>%
    dplyr::filter(!is.na(median_wormlength_um_reg)) %>%
    dplyr::group_by(concentration_um, strain) %>%
    dplyr::summarise(mean = mean(median_wormlength_um_reg), 
                     sd = sd(median_wormlength_um_reg)) %>%
    dplyr::full_join(., dose.mean) %>%
    dplyr::mutate(norm = dose.mean - mean)
  
  ranks <- dose.norm %>%
    dplyr::group_by(concentration_um) %>%
    tidyr::nest()

  strain.ranks <- function(x,y){
    x %>%
      dplyr::mutate(rank = rank(norm),
                    concentration_um = y)
  }
  rank.df <- purrr::map2(ranks$data, ranks$concentration_um, strain.ranks) %>%
    Reduce(rbind,.)
  
  palette <- park_palette(name = names(sample(park_palettes, 1)), n = 3)
  
  ggplot(rank.df) + 
    theme_bw() + 
    geom_pointrange(aes(x = reorder(strain,norm),
                        y = norm,
                        ymax = norm+sd,
                        ymin = norm-sd, 
                        colour = as.factor(concentration_um)), position = position_dodge(width = 0.5)) + 
    geom_text_repel(aes(x = reorder(strain,norm),
                        y = norm, label = 9-rank)) + 
    scale_colour_manual(values = palette, name = "Concentration (uM)") +
    theme(legend.position = "bottom",
          axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
          axis.title.x = element_blank()) + 
    ggtitle(drug) + 
    ggsave(filename = paste0("output/",drug,"_H2.rank.plot.png"), height = 6, width = 6)

}

for(k in 1:length(clean.drug.phenos)){
  print(k)
  print(c(topH2.nested$drug[[k]], clean.drug.phenos[[k]]))
  H2.pheno.rankings(drug = topH2.nested$drug[[k]], 
                    data = topH2.nested$data[[k]], 
                    clean.drug.phenos = clean.drug.phenos[[k]])
}




# K99 figure
se.DR.K99 <- function(x){
  text.size = 6
  
  norm <- x %>%
    dplyr::group_by(strain,) %>%
    dplyr::filter(concentration_um == 0) %>%
    dplyr::summarize(mean_ctrl = mean(mean_wormlength_um_reg)) %>%
    dplyr::ungroup() %>%
    dplyr::select(strain, mean_ctrl) %>% ##added trait
    dplyr::full_join(x , by = c("strain")) %>% ## "trait" instead of "condition"
    dplyr::distinct() %>%
    dplyr::mutate(norm_pheno = mean_wormlength_um_reg - mean_ctrl) 

dose_avg <- norm %>%
  dplyr::group_by(strain, concentration_um) %>%
  dplyr::summarise(avg = mean(norm_pheno), st_dev = sd(norm_pheno))

dose.range <- unique(dose_avg$concentration_um)[length(unique(dose_avg$concentration_um))] - unique(dose_avg$concentration_um)[2]


population.10perceffect <- x %>%
  dplyr::filter(concentration_um == levels(as.factor(x$concentration_um))[length(levels(as.factor(x$concentration_um)))]) %>%
  dplyr::select(strain, concentration_um, median_wormlength_um_reg) %>%
  dplyr::group_by(concentration_um) %>%
  dplyr::summarise(avg.effects = mean(median_wormlength_um_reg)) %>%
  dplyr::select(avg.effects) %>% as.numeric() * 0.1

population.response <- x %>%
  dplyr::select(drug, strain, concentration_um, median_wormlength_um_reg) %>%
  dplyr::mutate(affected = if_else(median_wormlength_um_reg < population.10perceffect, true = "affected", false = "unaffected")) %>%
  dplyr::group_by(drug, concentration_um, affected) %>%
  dplyr::summarise(n = n()) %>%
  tidyr::pivot_wider(names_from = affected, values_from = n)
population.response[is.na(population.response)] <- 0
population.response %<>%
  dplyr::mutate(fraction.affected = affected/(affected+unaffected))


frac.affected <- population.response %>%
  ggplot(.) +
  theme_bw(base_size = text.size) + 
  geom_line(aes(x=log(concentration_um), 
                y=fraction.affected*100)) + 
  theme(panel.grid = element_blank(),
        plot.title = element_blank(),
        axis.title.x = element_blank()) +
  ylim(c(0,100)) + 
  labs(y = "Population affected (%)")


strains <- ggplot() +
  theme_bw(base_size = text.size) + 
  # geom_pointrange(data = dose_avg,
  #                 aes(x=log(concentration_um),
  #                     y = avg,
  #                     ymin=avg-st_dev,
  #                     ymax = avg+st_dev,
  #                     colour = strain), size = 0.02) + 
  # geom_errorbar(data = dose_avg,
  #               aes(x=log(concentration_um),
  #                   ymin=avg-st_dev,
  #                   ymax = avg+st_dev,
  #                   colour = strain), width = 0.2)  +
  geom_line(data = dose_avg,
            aes(x=log(concentration_um), 
                y=avg, 
                group = strain, 
                colour = strain), size = 0.15) +
  scale_colour_manual(values = strain_colors, name = "Strain") +
  scale_y_continuous("Normalized response") + 
  theme(panel.grid = element_blank(),
        legend.position = "none",
        axis.title.y = element_text(size = text.size), 
        plot.title = element_blank(),
        axis.title.x = element_blank())
  # labs(x=expression(italic("log")("Concentration (μM)"))) + 
  # ggtitle(unique(x$drug))

multiplot <- cowplot::plot_grid(strains, frac.affected, rel_widths = c(1:1))
grid.arrange(multiplot, top=textGrob(unique(x$drug), gp=gpar(fontsize=text.size)))
}
A <- se.DR.K99(tpp.df[[1]])
B <- se.DR.K99(cadmium.df[[1]])
C <- se.DR.K99(paraquat.df[[1]])
K99.DR.fig <- cowplot::plot_grid(A, B, C, labels = "AUTO", label_size = 7, ncol = 1)
x.grob <- textGrob(expression(italic("log")("Concentration (μM)")), 
                   gp=gpar(fontsize=text.size))
K99.DR.fig.2 <- grid.arrange(arrangeGrob(K99.DR.fig,bottom = x.grob))
ggsave(K99.DR.fig.2, 
       filename = "/Volumes/GoogleDrive/My Drive/Fellowships/K99-R00/plots/DR.fig.jpeg", width = 2.5, height = 4)


```



